<!DOCTYPE html>

<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>–ú—ã—Ç–∏—â–∏ 2D - –ù–æ–≤—ã–π –°–µ–∑–æ–Ω</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Varela+Round&family=Righteous&display=swap');

- {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  }

body {
font-family: ‚ÄòVarela Round‚Äô, sans-serif;
background: #000;
overflow: hidden;
touch-action: none;
}

#gameCanvas {
display: block;
margin: 0 auto;
background: linear-gradient(180deg, #A0D0FF 0%, #E0F0FF 100%);
touch-action: none;
}

.screen {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
background: radial-gradient(circle, #00D4FF 0%, #0040A0 100%);
z-index: 1000;
padding: 20px;
}

h1 {
font-family: ‚ÄòRighteous‚Äô, cursive;
font-size: clamp(36px, 10vw, 72px);
color: white;
text-shadow: 0 0 30px rgba(0, 212, 255, 0.8);
margin-bottom: 20px;
animation: glow 2s infinite;
}

@keyframes glow {
0%, 100% { text-shadow: 0 0 30px rgba(0, 212, 255, 0.8); }
50%       { text-shadow: 0 0 50px rgba(255, 107, 157, 0.8); }
}

button {
background: linear-gradient(135deg, #00D4FF, #0080C0);
border: 3px solid white;
color: white;
font-family: ‚ÄòVarela Round‚Äô, sans-serif;
font-size: clamp(18px, 4vw, 24px);
font-weight: bold;
padding: 15px 40px;
border-radius: 50px;
margin: 10px;
cursor: pointer;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

button:active { transform: scale(0.95); }

#hud {
position: fixed;
top: 0;
left: 0;
width: 100%;
pointer-events: none;
z-index: 100;
padding: 15px;
}

.stat {
background: rgba(0, 0, 0, 0.8);
padding: 10px 20px;
border-radius: 15px;
color: white;
font-size: 18px;
font-weight: bold;
border: 2px solid rgba(0, 212, 255, 0.5);
display: inline-block;
margin: 5px;
}

#joystick {
position: fixed;
bottom: 30px;
left: 30px;
width: 120px;
height: 120px;
background: radial-gradient(circle, rgba(0, 212, 255, 0.3), rgba(0, 212, 255, 0.1));
border: 3px solid rgba(0, 212, 255, 0.5);
border-radius: 50%;
z-index: 200;
pointer-events: all;
}

#stick {
position: absolute;
width: 50px;
height: 50px;
background: radial-gradient(circle at 30% 30%, #00D4FF, #0080C0);
border: 3px solid white;
border-radius: 50%;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
}

#shootBtn {
position: fixed;
bottom: 30px;
right: 30px;
width: 80px;
height: 80px;
background: radial-gradient(circle at 30% 30%, #FF6B9D, #D02070);
border: 3px solid white;
border-radius: 50%;
color: white;
font-size: 32px;
z-index: 200;
pointer-events: all;
display: flex;
align-items: center;
justify-content: center;
}

#message {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: linear-gradient(135deg, #00D4FF, #FF6B9D);
padding: 20px 40px;
border-radius: 20px;
color: white;
font-size: 24px;
font-weight: bold;
text-align: center;
z-index: 300;
opacity: 0;
pointer-events: none;
transition: opacity 0.3s;
border: 3px solid white;
}

#message.show { opacity: 1; }

.location-select {
background: rgba(0, 0, 0, 0.6);
padding: 20px;
border-radius: 15px;
margin: 20px 0;
}

.location-btn { background: linear-gradient(135deg, #00D4FF, #0080C0); margin: 10px; }
.location-btn.murino { background: linear-gradient(135deg, #555, #222); }
.location-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ===== –ê–õ–¨–ú–ê–ù–ê–• ===== */
.almanac-entry {
background: rgba(0,0,0,0.45);
border-radius: 16px;
padding: 16px 18px;
margin: 10px 0;
max-width: 480px;
width: 100%;
text-align: left;
border-left: 5px solid #00D4FF;
position: relative;
}
.almanac-entry.locked {
opacity: 0.45;
border-left-color: #555;
filter: grayscale(0.6);
}
.almanac-entry-header {
display: flex;
align-items: center;
gap: 12px;
margin-bottom: 8px;
}
.almanac-icon {
font-size: 36px;
flex-shrink: 0;
}
.almanac-name {
font-family: ‚ÄòRighteous‚Äô, cursive;
font-size: clamp(17px, 4vw, 22px);
color: #fff;
}
.almanac-location {
font-size: 11px;
font-weight: bold;
letter-spacing: 1px;
text-transform: uppercase;
padding: 2px 8px;
border-radius: 8px;
display: inline-block;
margin-bottom: 6px;
}
.almanac-desc {
font-size: 14px;
color: rgba(255,255,255,0.8);
line-height: 1.55;
}
.almanac-lock-badge {
position: absolute;
top: 10px;
right: 12px;
background: #333;
color: #888;
font-size: 11px;
padding: 2px 8px;
border-radius: 8px;
font-weight: bold;
}

/* ===== –°–£–ù–î–£–ö–ò ===== */
#chestScreen {
overflow-y: auto;
}

.chest-card {
background: rgba(0,0,0,0.4);
border: 3px solid rgba(0,212,255,0.4);
border-radius: 20px;
padding: 20px;
text-align: center;
max-width: 280px;
margin: 10px;
}

/* –ú–µ–ª—Å—Ç—Ä–æ–π –ü–∞—Å—Å */
#passGrid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
gap: 15px;
overflow: hidden;
transition: transform 0.3s ease;
}

#passGridContainer {
overflow: hidden;
max-height: 60vh;
position: relative;
}

.pass-arrow {
position: fixed;
left: 50%;
transform: translateX(-50%);
width: 60px;
height: 60px;
border-radius: 50%;
background: linear-gradient(135deg, #00D4FF, #0080C0);
border: 3px solid white;
color: white;
font-size: 32px;
cursor: pointer;
box-shadow: 0 5px 15px rgba(0,0,0,0.5);
z-index: 50;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s;
}

.pass-arrow:hover {
transform: translateX(-50%) scale(1.1);
box-shadow: 0 8px 20px rgba(0,0,0,0.7);
}

.pass-arrow:active {
transform: translateX(-50%) scale(0.95);
}

.pass-arrow.disabled {
opacity: 0.3;
cursor: not-allowed;
}

#keyCharGrid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
gap: 12px;
}

/* –°—É–Ω–¥—É–∫-–ø—É–∑—ã—Ä—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
#chestOpenOverlay {
display: none;
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background: radial-gradient(circle, #001a40 0%, #000510 100%);
z-index: 2000;
flex-direction: column;
align-items: center;
justify-content: center;
user-select: none;
}

#chestOpenOverlay.active { display: flex; }

#bubbleCanvas {
cursor: pointer;
filter: drop-shadow(0 0 30px rgba(0,212,255,0.8));
transition: transform 0.08s;
}

#bubbleCanvas:active { transform: scale(0.93); }

#chestRarityLabel {
font-family: ‚ÄòRighteous‚Äô, cursive;
font-size: clamp(22px, 6vw, 38px);
font-weight: bold;
letter-spacing: 2px;
margin-bottom: 12px;
text-transform: uppercase;
transition: color 0.4s, text-shadow 0.4s;
}

#chestTapsLeft {
font-size: clamp(16px, 4vw, 22px);
color: rgba(255,255,255,0.7);
margin-top: 14px;
}

#chestResultOverlay {
display: none;
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background: rgba(0,0,0,0.85);
z-index: 3000;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 30px;
}

#chestResultOverlay.active { display: flex; }

.result-box {
background: linear-gradient(135deg, rgba(0,40,80,0.95), rgba(0,10,30,0.95));
border-radius: 24px;
padding: 36px 40px;
text-align: center;
max-width: 340px;
width: 100%;
}

.result-emoji { font-size: 80px; margin-bottom: 10px; }

.result-name {
font-family: ‚ÄòRighteous‚Äô, cursive;
font-size: clamp(24px, 7vw, 36px);
font-weight: bold;
margin: 8px 0;
}

.result-rarity {
font-size: 14px;
font-weight: bold;
letter-spacing: 1px;
text-transform: uppercase;
margin-bottom: 16px;
}

@keyframes popIn {
0%   { transform: scale(0.3); opacity: 0; }
70%  { transform: scale(1.1); }
100% { transform: scale(1);   opacity: 1; }
}

.result-box { animation: popIn 0.45s ease-out both; }

@keyframes bubblePop {
0%   { transform: scale(1);    opacity: 1; }
40%  { transform: scale(1.25); opacity: 0.8; }
100% { transform: scale(0.1);  opacity: 0; }
}

.bubble-popping { animation: bubblePop 0.35s ease-in forwards; }

@keyframes rarityFlash {
0%, 100% { opacity: 1; }
50%       { opacity: 0.3; }
}
.rarity-flash { animation: rarityFlash 0.25s ease-in-out 3; }

@keyframes pulse {
0%, 100% { transform: translate(-50%,-50%) scale(1); }
50%       { transform: translate(-50%,-50%) scale(1.1); }
}

</style>

</head>
<body>
    <canvas id="gameCanvas"></canvas>

<div id="hud">
    <div class="stat" id="currency">üí∞ 0</div>
    <div class="stat" id="hazard">–ì—Ä—è–∑–Ω–æ—Å—Ç—å: 0%</div>
    <div class="stat" id="location" style="float: right;">üìç –ú—ã—Ç–∏—â–∏</div>
</div>

<div id="joystick"><div id="stick"></div></div>
<div id="shootBtn">E</div>
<div id="message"></div>

<!-- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù -->

<div id="startScreen" class="screen">
    <h1>–ú–´–¢–ò–©–ò 2D</h1>
    <div style="color: rgba(255,255,255,0.8); margin-bottom: 20px; font-size: 18px;">
        –ü–µ—Ä—Å–æ–Ω–∞–∂: <span id="charName" style="color: #FFD700;">–ß</span>
    </div>
    <button onclick="sfxClick();openLocationSelect()">‚ñ∂Ô∏è –ù–ê–ß–ê–¢–¨</button>
    <button onclick="sfxClick();openShop()">üõí –ú–ï–õ–°–¢–†–û–ô–ù–û–°–¢–ò</button>
    <button onclick="sfxClick();openPass('start')">üéÅ –ú–ï–õ–°–¢–†–û–ô –ü–ê–°–°</button>
    <button onclick="sfxClick();openChests('start')">üì¶ –°–£–ù–î–£–ö–ò</button>
    <button onclick="sfxClick();openAlmanac('start')">üìñ –ê–õ–¨–ú–ê–ù–ê–•</button>
    <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; margin-top: 20px; max-width: 400px;">
        üïπÔ∏è –î–∂–æ–π—Å—Ç–∏–∫ - –¥–≤–∏–∂–µ–Ω–∏–µ<br>
        üî¥ E - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ / —Å—Ç—Ä–µ–ª—å–±–∞<br>
        üí∞ –°–æ–±–∏—Ä–∞–π –¥—Ä—É–Ω–±–ª–µ–∏ / –∞–ª–º–∞–∑—ã<br>
        üöø –ú–æ–π—Å—è –≤ –¥—É—à–µ (–ú—ã—Ç–∏—â–∏)<br>
        ‚ö†Ô∏è –ë–µ–≥–∏ –æ—Ç –≤—Ä–∞–≥–æ–≤!
    </div>
</div>

<!-- –≠–ö–†–ê–ù –õ–û–ö–ê–¶–ò–ô -->

<div id="locationScreen" class="screen" style="display: none;">
    <h1>–í–´–ë–ï–†–ò –õ–û–ö–ê–¶–ò–Æ</h1>
    <div class="location-select">
        <button class="location-btn" onclick="startGame('mytishchi')">
            üèôÔ∏è –ú–´–¢–ò–©–ò<br><small>–ì—Ä—è–∑–Ω–æ—Å—Ç—å ‚Ä¢ –ì—Ä—è–∑–Ω–∏ –∏ –§–æ–≥–∏</small>
        </button>
        <button class="location-btn murino" id="murinoBtn" onclick="startGame('murino')" disabled>
            üå´Ô∏è –ú–£–†–ò–ù–û<br><small>üîí –ü–æ–±–µ–¥–∏ –ò–º–ø–µ—Ä–∞—Ç–æ—Ä–∞</small>
        </button>
        <button class="location-btn" id="molochnoeBtn" onclick="startGame('molochnoe')" disabled style="background: linear-gradient(135deg, #90EE90, #228B22);">
            üï∏Ô∏è –ú–û–õ–û–ß–ù–û–ï<br><small>üîí –ü–æ–±–µ–¥–∏ The FOG</small>
        </button>
    </div>
    <button onclick="closeLocationSelect()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>
</div>

<!-- –ú–ê–ì–ê–ó–ò–ù -->

<div id="shopScreen" class="screen" style="display: none; overflow-y: auto;">
    <div style="position: sticky; top: 0; background: inherit; padding: 15px 0; z-index: 10;">
        <h1 style="font-size: clamp(28px, 6vw, 48px);">–ú–ï–õ–°–¢–†–û–ô–ù–û–°–¢–ò</h1>
        <div style="background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 15px; display: inline-block;">
            üí∞ <span id="shopBalance">0</span> –¥—Ä—É–Ω–±–ª–µ–π
        </div>
    </div>
    <div id="charGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; max-width: 600px; margin: 20px auto; padding: 0 10px; max-height: 60vh; overflow-y: auto;"></div>
    <div id="bossBtn" style="display: none; margin: 20px;">
        <button onclick="startBoss()" style="background: linear-gradient(135deg, #0080C0, #00BFFF); border-color: #FFD700; font-size: 20px;">
            üëë –ë–û–°–°: –ò–ú–ü–ï–†–ê–¢–û–† –ú–´–¢–ò–©–¨
        </button>
    </div>
    <div id="murinoBossBtn" style="display: none; margin: 20px;">
        <button onclick="startMurinoBoss()" style="background: linear-gradient(135deg, #1a1a2e, #4a0080); border-color: #9B59B6; font-size: 20px;">
            üå´Ô∏è –ë–û–°–°: THE FOG
        </button>
    </div>
    <div id="molochnoeBossBtn" style="display: none; margin: 20px;">
        <button onclick="startMolochnoeBoss()" style="background: linear-gradient(135deg, #90EE90, #228B22); border-color: #FFD700; font-size: 20px;">
            üöä –ë–û–°–°: –¢–†–ê–ú–í–ê–ô
        </button>
    </div>
    <button onclick="closeShop()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>
</div>

<!-- –≠–ö–†–ê–ù –°–£–ù–î–£–ö–û–í -->

<div id="chestScreen" class="screen" style="display: none;">
    <div style="position: sticky; top: 0; background: inherit; padding: 15px 0; z-index: 10; text-align: center;">
        <h1 style="font-size: clamp(28px, 6vw, 48px);">üì¶ –°–£–ù–î–£–ö–ò</h1>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
            <div style="background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 15px; display: inline-block;">
                üí∞ <span id="chestBalance">0</span> –¥—Ä—É–Ω–±–ª–µ–π
            </div>
            <div style="background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 15px; display: inline-block; border: 1px solid #0FF;">
                üíé <span id="crystalBalance">0</span> –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤
            </div>
        </div>
    </div>
    <div id="chestGrid" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; max-width: 600px; margin: 20px auto; padding: 0 10px; max-height: 55vh; overflow-y: auto;"></div>
    <button onclick="closeChests()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>
</div>

<!-- –≠–ö–†–ê–ù –°–ú–ï–†–¢–ò -->

<div id="deathScreen" class="screen" style="display: none;">
    <h1 style="color: #FF6B6B;">–ü–û–†–ê–ñ–ï–ù–ò–ï</h1>
    <div id="deathStats" style="font-size: 20px; margin: 20px;"></div>
    <button onclick="sfxClick();restartGame()">üîÑ –ó–ê–ù–û–í–û</button>
    <button onclick="sfxClick();openLocationFromGame()">üó∫Ô∏è –õ–û–ö–ê–¶–ò–ò</button>
    <button onclick="sfxClick();openShopFromGame()">üõí –ú–ï–õ–°–¢–†–û–ô–ù–û–°–¢–ò</button>
    <button onclick="sfxClick();openPass('death')">üéÅ –ú–ï–õ–°–¢–†–û–ô –ü–ê–°–°</button>
    <button onclick="sfxClick();openChests('death')">üì¶ –°–£–ù–î–£–ö–ò</button>
    <button onclick="sfxClick();openAlmanac('death')">üìñ –ê–õ–¨–ú–ê–ù–ê–•</button>
</div>

<!-- –≠–ö–†–ê–ù –ü–û–ë–ï–î–´ -->

<div id="victoryScreen" class="screen" style="display: none;">
    <h1 style="color: #00FFD4;">–ü–û–ë–ï–î–ê!</h1>
    <div id="victoryStats" style="font-size: 20px; margin: 20px;"></div>
    <button onclick="sfxClick();restartGame()">üîÑ –ï–©–Å –†–ê–ó</button>
    <button onclick="sfxClick();openLocationFromGame()">üó∫Ô∏è –õ–û–ö–ê–¶–ò–ò</button>
    <button onclick="sfxClick();openShopFromGame()">üõí –ú–ï–õ–°–¢–†–û–ô–ù–û–°–¢–ò</button>
    <button onclick="sfxClick();openPass('victory')">üéÅ –ú–ï–õ–°–¢–†–û–ô –ü–ê–°–°</button>
    <button onclick="sfxClick();openChests('victory')">üì¶ –°–£–ù–î–£–ö–ò</button>
    <button onclick="sfxClick();openAlmanac('victory')">üìñ –ê–õ–¨–ú–ê–ù–ê–•</button>
</div>

<!-- –≠–ö–†–ê–ù –ê–õ–¨–ú–ê–ù–ê–•–ê -->

<div id="almanacScreen" class="screen" style="display: none; overflow-y: auto;">
    <div style="position: sticky; top: 0; background: inherit; padding: 15px 0; z-index: 10; text-align: center;">
        <h1 style="font-size: clamp(28px, 6vw, 48px);">üìñ –ê–õ–¨–ú–ê–ù–ê–•</h1>
        <div style="color: rgba(255,255,255,0.6); font-size: 13px; margin-top: -10px;">–í—Ä–∞–≥–∏ –∫–æ—Ç–æ—Ä—ã—Ö —Ç—ã –≤—Å—Ç—Ä–µ—á–∞–ª</div>
    </div>
    <div id="almanacList" style="width: 100%; max-width: 520px; margin: 0 auto; padding: 0 12px 20px;"></div>
    <button onclick="closeAlmanac()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>
</div>

<!-- –ú–ï–õ–°–¢–†–û–ô –ü–ê–°–° -->

<div id="passScreen" class="screen" style="display: none; overflow: hidden;">
    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –≤ –º–µ–Ω—é –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
    <button onclick="closePassToMenu()" style="position: fixed; top: 20px; right: 20px; z-index: 100; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #FF6B9D, #FF1493); border: 3px solid white; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">üè†</button>

<!-- –°—Ç—Ä–µ–ª–∫–∞ –≤–≤–µ—Ä—Ö -->

<button id="passArrowUp" class="pass-arrow" style="top: 120px;" onclick="scrollPassUp()">‚ñ≤</button>

<!-- –°—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑ -->

<button id="passArrowDown" class="pass-arrow" style="bottom: 80px;" onclick="scrollPassDown()">‚ñº</button>

<div style="position: sticky; top: 0; background: inherit; padding: 15px 0; z-index: 10; text-align: center;">
    <h1 style="font-size: clamp(28px, 6vw, 48px);">üéÅ –ú–ï–õ–°–¢–†–û–ô –ü–ê–°–°</h1>
    <div style="background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 15px; display: inline-block; margin-top: 10px;">
        <div style="font-size: 18px; color: #FFD700; font-weight: bold;">–¢–∏—Ä: <span id="passCurrentTier">0</span> / 60</div>
    </div>
</div>
<div id="passGridContainer" style="width: 100%; max-width: 800px; margin: 20px auto; padding: 0 12px 20px; overflow: hidden; max-height: 60vh;">
    <div id="passGrid" style="width: 100%;"></div>
</div>
<button onclick="closePass()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>

</div>

<!-- –û–í–ï–†–õ–ï–ô: –í–´–ë–û–† –ü–ï–†–°–û–ù–ê–ñ–ê –ü–û –ö–õ–Æ–ß–£ -->

<div id="keySelectOverlay" class="screen" style="display: none;">
    <h1 style="font-size: clamp(32px, 8vw, 52px);" id="keySelectTitle">üîë –û–ë–´–ß–ù–û–°–¢–¨ –ö–õ–Æ–ß</h1>
    <div style="color: rgba(255,255,255,0.8); margin-bottom: 20px; font-size: 18px;">–í—ã–±–µ—Ä–∏ –æ–¥–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</div>
    <div id="keyCharGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; max-width: 600px; margin: 0 auto; padding: 0 10px; max-height: 60vh; overflow-y: auto;"></div>
    <button onclick="closeKeySelect()" style="margin-top: 20px;">‚¨ÖÔ∏è –ù–ê–ó–ê–î</button>
</div>

<!-- –û–í–ï–†–õ–ï–ô: –û–¢–ö–†–´–¢–ò–ï –°–£–ù–î–£–ö–ê (–∞–Ω–∏–º–∞—Ü–∏—è –ø—É–∑—ã—Ä—è) -->

<div id="chestOpenOverlay">
    <div id="chestRarityLabel">–û–ë–´–ß–ù–û–°–¢–¨</div>
    <canvas id="bubbleCanvas" width="260" height="260"></canvas>
    <div id="chestTapsLeft">–ù–∞–∂–º–∏ 5 —Ä–∞–∑ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
    <button onclick="cancelChestOpen()" style="margin-top: 30px; font-size: 16px; padding: 10px 30px; background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4);">‚úñ –û–¢–ú–ï–ù–ê</button>
</div>

<!-- –û–í–ï–†–õ–ï–ô: –†–ï–ó–£–õ–¨–¢–ê–¢ –°–£–ù–î–£–ö–ê -->

<div id="chestResultOverlay">
    <div class="result-box" id="resultBox">
        <div class="result-emoji" id="resultEmoji"></div>
        <div class="result-name" id="resultName"></div>
        <div class="result-rarity" id="resultRarity"></div>
        <div id="resultDesc" style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 20px;"></div>
        <button onclick="closeResult()" style="font-size: 18px; padding: 12px 36px;">‚úÖ –ó–ê–ë–†–ê–¢–¨</button>
    </div>
</div>

<script>
    // ===================== CANVAS & RESIZE =====================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // ===================== GAME STATE =====================
    let gameRunning       = false;
    let currentLocation  = 'mytishchi';
    let isBossMode       = false;
    let isMurinoBossMode = false;
    let theFog           = null;  // –±–æ—Å—Å –ú—É—Ä–∏–Ω–æ
    let isMolochnoeBo—Å—ÅMode = false;
    let tramvai          = null;  // –±–æ—Å—Å –ú–æ–ª–æ—á–Ω–æ–µ
    let tramvaiSpawnTimer = 0;    // —Ç–∞–π–º–µ—Ä —Å–ø–∞–≤–Ω–∞ –ø–∞–≤—É–∫–æ–≤ –≤–æ –≤—Ä–µ–º—è –±–æ—è —Å —Ç—Ä–∞–º–≤–∞–µ–º

    let player = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        size: 20,
        speed: 3,
        vx: 0,
        vy: 0,
        color: '#FFFFFF',
        maxHazard: 100
    };

    let currency    = 0;
    let totalEarned = parseInt(localStorage.getItem('totalEarned') || '0');
    let totalCrystals = parseInt(localStorage.getItem('totalCrystals') || '0'); // –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã
    let hazard      = 0;
    const hazardRate = 0.15;

    // ===================== –ú–ï–õ–°–¢–†–û–ô –ü–ê–°–° =====================
    let passProgress = parseInt(localStorage.getItem('passProgress') || '0'); // –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –¥—Ä—É–Ω–±–ª–µ–π
    let passTier = parseInt(localStorage.getItem('passTier') || '0'); // —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–∞—Å—Å–∞ (0-60)
    let passRewards = JSON.parse(localStorage.getItem('passRewards') || '[]'); // –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã
    
    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞—Å—Å–∞: 
    // –¢–∏—Ä 0-19: –∫–∞–∂–¥—ã–µ 20000 = —Å—É–Ω–¥—É–∫ –ø—É–∑—ã—Ä—å, –Ω–∞ 20 = –æ–±—ã—á–Ω–æ—Å—Ç—å –∫–ª—é—á
    // –¢–∏—Ä 20-39: –∫–∞–∂–¥—ã–µ 30000 = —Å—É–Ω–¥—É–∫ –¥—ã–º–Ω–æ—Å—Ç—å, –Ω–∞ 40 = —Ä–µ–¥–∫–æ—Å—Ç—å –∫–ª—é—á  
    // –¢–∏—Ä 40-59: –∫–∞–∂–¥—ã–µ 40000 = —Å—É–Ω–¥—É–∫ –ø–∞—É—Ç–∏–Ω–∞, –Ω–∞ 60 = –≤–µ–ª–∏–∫–æ—Å—Ç—å –∫–ª—é—á
    
    function getPassTierReward(tier) {
        if (tier === 20) return { type: 'key', rarity: '–û–±—ã—á–Ω–æ—Å—Ç—å', name: '–û–±—ã—á–Ω–æ—Å—Ç—å –ö–ª—é—á', emoji: 'üîë' };
        if (tier === 40) return { type: 'key', rarity: '–†–µ–¥–∫–æ—Å—Ç—å', name: '–†–µ–¥–∫–æ—Å—Ç—å –ö–ª—é—á', emoji: 'üóùÔ∏è' };
        if (tier === 60) return { type: 'key', rarity: '–í–µ–ª–∏–∫–æ—Å—Ç—å', name: '–í–µ–ª–∏–∫–æ—Å—Ç—å –ö–ª—é—á', emoji: 'üîê' };
        
        if (tier < 20) return { type: 'chest', chest: 'bubble', name: '–ü—É–∑—ã—Ä—å', emoji: 'ü´ß' };
        if (tier < 40) return { type: 'chest', chest: 'dymnost', name: '–î—ã–º–Ω–æ—Å—Ç—å', emoji: 'üå´Ô∏è' };
        if (tier <= 60) return { type: 'chest', chest: 'pautina', name: '–ü–∞—É—Ç–∏–Ω–∞', emoji: 'üï∏Ô∏è' };
        
        return null;
    }
    
    function getPassTierCost(tier) {
        if (tier < 20) return 20000;
        if (tier < 40) return 30000;
        if (tier <= 60) return 40000;
        return 0;
    }
    
    function updatePassProgress(spent) {
        const oldProgress = passProgress;
        passProgress += spent;
        localStorage.setItem('passProgress', passProgress);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –Ω–æ–≤—ã—Ö –Ω–∞–≥—Ä–∞–¥ (–Ω–æ –ù–ï –∑–∞–±–∏—Ä–∞–µ–º –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        while (passTier < 60) {
            const cost = getPassTierCost(passTier);
            if (passProgress >= cost) {
                passProgress -= cost;
                passTier++;
                localStorage.setItem('passTier', passTier);
                localStorage.setItem('passProgress', passProgress);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ (–Ω–æ –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –≤ passRewards)
                const reward = getPassTierReward(passTier);
                if (reward) {
                    showMessage('üéÅ –ú–µ–ª—Å—Ç—Ä–æ–π –ü–∞—Å—Å –¢–∏—Ä ' + passTier + ': ' + reward.emoji + ' ' + reward.name + ' —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!', 3000);
                }
            } else {
                break;
            }
        }
    }

    // ===================== –ó–í–£–ö (Web Audio API) =====================
    let audioCtx = null;
    let musicNode = null;
    let musicGain = null;
    let musicInterval = null;

    function getAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
    }

    function beep(freq, type, dur, vol, startDelay) {
        try {
            const ac = getAudio();
            const osc = ac.createOscillator();
            const gain = ac.createGain();
            osc.connect(gain); gain.connect(ac.destination);
            osc.type = type || 'square';
            osc.frequency.setValueAtTime(freq, ac.currentTime + (startDelay||0));
            gain.gain.setValueAtTime(vol||0.15, ac.currentTime + (startDelay||0));
            gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + (startDelay||0) + dur);
            osc.start(ac.currentTime + (startDelay||0));
            osc.stop(ac.currentTime + (startDelay||0) + dur);
        } catch(e) {}
    }

    // –ó–≤—É–∫–∏ UI
    function sfxClick()   { beep(440, 'square', 0.06, 0.12); beep(660, 'square', 0.05, 0.08, 0.06); }
    function sfxBack()    { beep(330, 'square', 0.05, 0.1);  beep(220, 'square', 0.06, 0.08, 0.05); }
    function sfxCoin()    { beep(880, 'sine',   0.08, 0.08); beep(1100,'sine',   0.06, 0.06, 0.07); }
    function sfxHit()     { beep(110, 'sawtooth',0.1, 0.18); }
    function sfxShoot()   { beep(660, 'square', 0.07, 0.1);  }
    function sfxPush()    { beep(200, 'sawtooth',0.05,0.15); beep(400,'sawtooth',0.08,0.12,0.05); beep(600,'sawtooth',0.06,0.1,0.1); }
    function sfxVictory() {
        [523,659,784,1047].forEach((f,i) => beep(f,'square',0.18,0.15,i*0.13));
    }
    function sfxDie()     {
        [400,320,240,160].forEach((f,i) => beep(f,'sawtooth',0.15,0.15,i*0.1));
    }

    // –ó–≤—É–∫–∏ —Å—É–Ω–¥—É–∫–æ–≤
    function sfxChestTap()    { beep(350,'square',0.08,0.12); beep(500,'square',0.06,0.1,0.07); }
    function sfxChestRarityUp() {
        [440,554,659,880].forEach((f,i) => beep(f,'sine',0.1,0.15,i*0.07));
    }
    function sfxChestOpen() {
        [523,659,784,880,1047,1319].forEach((f,i) => beep(f,'sine',0.12,0.18,i*0.07));
    }
    function sfxChestEmpty() { beep(220,'sawtooth',0.1,0.12); beep(180,'sawtooth',0.12,0.1,0.1); }

    // ===================== –ú–£–ó–´–ö–ê (8-–±–∏—Ç –ø–µ—Ç–ª–∏) =====================
    function stopMusic() {
        if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
    }

    function playMusicLoop(notesFn, tempo) {
        stopMusic();
        try { getAudio(); } catch(e) { return; }
        let step = 0;
        const notes = notesFn();
        function tick() {
            const n = notes[step % notes.length];
            if (n) beep(n[0], n[1]||'square', n[2]||0.12, n[3]||0.1);
            step++;
        }
        tick();
        musicInterval = setInterval(tick, tempo || 180);
    }

    // –ú–µ–Ω—é ‚Äî –≤–µ—Å—ë–ª–∞—è –º–µ–ª–æ–¥–∏—è
    function playMenuMusic() {
        playMusicLoop(() => [
            [523,'square',0.13,0.12],[659,'square',0.13,0.12],[784,'square',0.13,0.12],[1047,'square',0.13,0.12],
            [784,'square',0.13,0.12],[659,'square',0.13,0.12],[523,'square',0.13,0.12],[0,null,0.01,0],
            [587,'square',0.13,0.12],[740,'square',0.13,0.12],[880,'square',0.13,0.12],[740,'square',0.13,0.12],
            [659,'square',0.13,0.12],[523,'square',0.13,0.12],[440,'square',0.13,0.12],[0,null,0.01,0]
        ], 170);
    }

    // –ú—ã—Ç–∏—â–∏ ‚Äî —Ä–∞—Å—Å–ª–∞–±–ª—è—é—â–∞—è
    function playMytishchiMusic() {
        playMusicLoop(() => [
            [330,'triangle',0.14,0.11],[392,'triangle',0.14,0.11],[494,'triangle',0.14,0.11],[392,'triangle',0.14,0.11],
            [330,'triangle',0.14,0.11],[0,null,0.01,0],[294,'triangle',0.14,0.11],[330,'triangle',0.14,0.11],
            [370,'triangle',0.14,0.11],[440,'triangle',0.14,0.11],[370,'triangle',0.14,0.11],[330,'triangle',0.14,0.11],
            [294,'triangle',0.14,0.11],[0,null,0.01,0],[262,'triangle',0.14,0.11],[294,'triangle',0.14,0.11]
        ], 220);
    }

    // –ú—É—Ä–∏–Ω–æ ‚Äî –º—Ä–∞—á–Ω–∞—è
    function playMurinoMusic() {
        playMusicLoop(() => [
            [185,'sawtooth',0.13,0.12],[196,'sawtooth',0.13,0.12],[185,'sawtooth',0.13,0.12],[175,'sawtooth',0.13,0.12],
            [165,'sawtooth',0.13,0.12],[0,null,0.01,0],[175,'sawtooth',0.13,0.12],[165,'sawtooth',0.13,0.12],
            [156,'sawtooth',0.13,0.12],[0,null,0.01,0],[185,'sawtooth',0.16,0.12],[220,'sawtooth',0.13,0.12],
            [196,'sawtooth',0.13,0.12],[185,'sawtooth',0.13,0.12],[175,'sawtooth',0.13,0.12],[0,null,0.01,0]
        ], 230);
    }

    // –ú–æ–ª–æ—á–Ω–æ–µ ‚Äî –≤–µ—Å—ë–ª–∞—è –∏ –∑–∞–¥–æ—Ä–∏—Å—Ç–∞—è
    function playMolochnoeMusic() {
        playMusicLoop(() => [
            [523,'triangle',0.12,0.13],[587,'triangle',0.12,0.13],[659,'triangle',0.12,0.13],[784,'triangle',0.12,0.13],
            [659,'triangle',0.12,0.13],[587,'triangle',0.12,0.13],[523,'triangle',0.12,0.13],[440,'triangle',0.12,0.13],
            [494,'triangle',0.12,0.13],[587,'triangle',0.12,0.13],[659,'triangle',0.12,0.13],[587,'triangle',0.12,0.13],
            [494,'triangle',0.12,0.13],[440,'triangle',0.12,0.13],[392,'triangle',0.14,0.13],[0,null,0.01,0]
        ], 160);
    }

    function startGameMusic() {
        if (isBossMode || isMurinoBossMode || isMolochnoeBo—Å—ÅMode) {
            // –ë–∏—Ç–≤–∞ —Å –±–æ—Å—Å–æ–º ‚Äî –±—ã—Å—Ç—Ä–∞—è –º—Ä–∞—á–Ω–∞—è
            playMusicLoop(() => [
                [220,'sawtooth',0.1,0.14],[277,'sawtooth',0.1,0.14],[330,'sawtooth',0.1,0.14],[220,'sawtooth',0.1,0.14],
                [185,'sawtooth',0.12,0.14],[0,null,0.01,0],[220,'sawtooth',0.1,0.14],[196,'sawtooth',0.1,0.14],
                [175,'sawtooth',0.1,0.14],[165,'sawtooth',0.12,0.14],[0,null,0.01,0],[220,'sawtooth',0.1,0.14],
                [247,'sawtooth',0.1,0.14],[277,'sawtooth',0.1,0.14],[330,'sawtooth',0.1,0.14],[0,null,0.01,0]
            ], 130);
        } else if (currentLocation === 'murino') {
            playMurinoMusic();
        } else if (currentLocation === 'molochnoe') {
            playMolochnoeMusic();
        } else {
            playMytishchiMusic();
        }
    }

    let currentChar     = localStorage.getItem('currentChar') || 'ch';
    let unlocked        = JSON.parse(localStorage.getItem('unlocked') || '["ch"]');
    let murinoUnlocked  = localStorage.getItem('murinoUnlocked') === 'true';
    let molochnoeUnlocked = localStorage.getItem('molochnoeUnlocked') === 'true';
    
    // –°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π: 0 = –Ω–µ –æ—Ç–∫—Ä—ã—Ç, 1 = –æ—Ç–∫—Ä—ã—Ç, 2 = —É–ª—É—á—à–µ–Ω 1 —Ä–∞–∑, 3 = –ú–ê–ö–°–ò–ú–£–ú
    let charLevels = JSON.parse(localStorage.getItem('charLevels') || '{"ch": 1}'); // –ß –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã–º, –Ω–æ –Ω–µ –ø—Ä–æ–∫–∞—á–∞–Ω–Ω—ã–º
    
    // –ú–∏–≥—Ä–∞—Ü–∏—è: –µ—Å–ª–∏ —É –ß –±—ã–ª —É—Ä–æ–≤–µ–Ω—å 3 –∏–∑ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–æ 1
    // (—É–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ-–º–∞–∫—Å–∏–º—É–º, —Ç–µ–ø–µ—Ä—å –µ–≥–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–∫–∞—á–∏–≤–∞—Ç—å)
    if (!localStorage.getItem('charLevelsMigrated_v2')) {
        if (charLevels['ch'] === 3) {
            charLevels['ch'] = 1;
            localStorage.setItem('charLevels', JSON.stringify(charLevels));
        }
        localStorage.setItem('charLevelsMigrated_v2', 'true');
    }

    // ===================== –ü–ï–†–°–û–ù–ê–ñ–ò =====================
    const characters = {
        ch:         { name: '–ß',               rarity: '–û–±—ã—á–Ω–æ—Å—Ç—å',      cost: 0,       speed: 1,    hazard: 1,    color: '#FFF',    shoot: false, shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: null      },
        kotnost:    { name: '–ö–æ—Ç–Ω–æ—Å—Ç—å',         rarity: '–û–±—ã—á–Ω–æ—Å—Ç—å',      cost: 30000,   speed: 1.5,  hazard: 0.5,  color: '#F4A460', shoot: false, shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: null      },
        drun:       { name: '–î—Ä—É–Ω',             rarity: '–û–±—ã—á–Ω–æ—Å—Ç—å',      cost: 50000,   speed: 1.3,  hazard: 0.7,  color: '#F00',    shoot: false, shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: null      },
        etost:      { name: '–≠—Ç–æ—Å—Ç—å',           rarity: '–û–±—ã—á–Ω–æ—Å—Ç—å',      cost: 40000,   speed: 1.8,  hazard: 0.4,  color: '#FF69B4', shoot: false, shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: null      },
        pavuk_char: { name: '–ü–∞–≤—É–∫',            rarity: '–û–±—ã—á–Ω–æ—Å—Ç—å',      cost: 60000,   speed: 1.1,  hazard: 0.6,  color: '#8B4513', shoot: true,  shootType: 'web',    murinoOnly: false, molochnoeOnly: true,  special: null      },
        yakrasny:   { name: '–Ø —É–∂–µ –∫—Ä–∞—Å–Ω—ã–π',   rarity: '–†–µ–¥–∫–æ—Å—Ç—å',       cost: 120000,  speed: 0.9,  hazard: 1.1,  color: '#FF2222', shoot: false, shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: 'push'    },
        myt:        { name: '–ú—ã—Ç—å',             rarity: '–†–µ–¥–∫–æ—Å—Ç—å',       cost: 100000,  speed: 0.9,  hazard: 1.5,  color: '#0CF',    shoot: false, shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: null      },
        dance:      { name: '–¢–∞–Ω—Ü—É–µ–º!',         rarity: '–†–µ–¥–∫–æ—Å—Ç—å',       cost: 100000,  speed: 1.5,  hazard: 1,    color: '#F0F',    shoot: false, shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: null      },
        kyo:        { name: '–ö—å–æ',              rarity: '–†–µ–¥–∫–æ—Å—Ç—å',       cost: 110000,  speed: 1.15, hazard: 0.8,  color: '#9370DB', shoot: false, shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: 'invisibility' },
        shlyapuk:   { name: '–®–ª—è–ø—É–∫',           rarity: '–†–µ–¥–∫–æ—Å—Ç—å',       cost: 130000,  speed: 1.0,  hazard: 0.6,  color: '#A0522D', shoot: true,  shootType: 'web_push', murinoOnly: false, molochnoeOnly: true, special: null      },
        moydodyr:   { name: '–ú–æ–π–¥–æ–¥—ã—Ä',         rarity: '–í–µ–ª–∏–∫–æ—Å—Ç—å',      cost: 250000,  speed: 0.75, hazard: 0.9,  color: '#0F0',    shoot: true,  shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: null      },
        vkusnost:   { name: '–í–∫—É—Å–Ω–æ—Å—Ç—å',        rarity: '–í–µ–ª–∏–∫–æ—Å—Ç—å',      cost: 300000,  speed: 1.0,  hazard: 0.5,  color: '#FFB6C1', shoot: true,  shootType: 'slow',   murinoOnly: true,  molochnoeOnly: false, special: null      },
        goodfog:    { name: '–î–æ–±—Ä—ã–π –§–æ–≥',       rarity: '–ú–µ–º–Ω–æ—Å—Ç—å',       cost: 400000,  speed: 1.0,  hazard: 1,    color: '#1E9',    shoot: true,  shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: null      },
        bambam:     { name: '–ë—ç–º –ë—ç–º',          rarity: '–ú–µ–º–Ω–æ—Å—Ç—å',       cost: 500000,  speed: 0.65, hazard: 0.8,  color: '#FF8C00', shoot: true,  shootType: 'aoe',    murinoOnly: true,  molochnoeOnly: false, special: null      },
        arthur:     { name: '–ê—Ä—Ç—É—Ä',            rarity: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å',  cost: 750000,  speed: 2,    hazard: 2,    color: '#F69',    shoot: false, shootType: 'normal', murinoOnly: false, molochnoeOnly: false, special: null      },
        melstroy:   { name: '–ú–µ–ª—Å—Ç—Ä–æ–π',         rarity: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å',  cost: 1000000, speed: 1.5,  hazard: 1.5,  color: '#FFD700', shoot: true,  shootType: 'normal', murinoOnly: true,  molochnoeOnly: false, special: null      },
        fog_char:   { name: '–§–æ–≥',              rarity: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å',  cost: 1200000, speed: 1.2,  hazard: 1.2,  color: '#888',    shoot: true,  shootType: 'fog',    murinoOnly: true,  molochnoeOnly: false, special: null      }
    };

    // –≠–º–æ–¥–∑–∏ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    const charEmoji = {
        ch: 'üòä', kotnost: 'üê±', drun: 'üî¥', etost: 'üí®',
        pavuk_char: 'üï∑Ô∏è', yakrasny: 'üü•',
        myt: 'üöø', dance: 'üíÉ', kyo: 'üëª', shlyapuk: 'üçÑ',
        moydodyr: 'üö∞',
        vkusnost: 'üê∞', goodfog: 'üíß', bambam: 'üí•',
        arthur: 'üëã', melstroy: '‚≠ê', fog_char: 'üå´Ô∏è'
    };

    // ===================== –†–ï–î–ö–û–°–¢–ò =====================
    const RARITIES = ['–û–±—ã—á–Ω–æ—Å—Ç—å', '–†–µ–¥–∫–æ—Å—Ç—å', '–í–µ–ª–∏–∫–æ—Å—Ç—å', '–ú–µ–º–Ω–æ—Å—Ç—å', '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å'];

    const rarityColors = {
        '–û–±—ã—á–Ω–æ—Å—Ç—å':      '#AAAAAA',
        '–†–µ–¥–∫–æ—Å—Ç—å':       '#4FC3F7',
        '–í–µ–ª–∏–∫–æ—Å—Ç—å':      '#CE93D8',
        '–ú–µ–º–Ω–æ—Å—Ç—å':       '#FFCC02',
        '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å': '#FF6B6B'
    };

    const rarityGlow = {
        '–û–±—ã—á–Ω–æ—Å—Ç—å':      'rgba(170,170,170,0.6)',
        '–†–µ–¥–∫–æ—Å—Ç—å':       'rgba(79,195,247,0.7)',
        '–í–µ–ª–∏–∫–æ—Å—Ç—å':      'rgba(206,147,216,0.7)',
        '–ú–µ–º–Ω–æ—Å—Ç—å':       'rgba(255,204,2,0.7)',
        '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å': 'rgba(255,107,107,0.8)'
    };

    // –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç—è–º (–≤–∫–ª—é—á–∞—è 'ch' ‚Äî –¥–ª—è –ø—Ä–æ–∫–∞—á–∫–∏ —á–µ—Ä–µ–∑ —Å—É–Ω–¥—É–∫–∏)
    const charsByRarity = {
        '–û–±—ã—á–Ω–æ—Å—Ç—å':      ['ch', 'kotnost', 'drun', 'etost', 'pavuk_char'],
        '–†–µ–¥–∫–æ—Å—Ç—å':       ['yakrasny', 'myt', 'dance', 'kyo', 'shlyapuk'],
        '–í–µ–ª–∏–∫–æ—Å—Ç—å':      ['moydodyr', 'vkusnost'],
        '–ú–µ–º–Ω–æ—Å—Ç—å':       ['goodfog', 'bambam'],
        '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å': ['arthur', 'melstroy', 'fog_char']
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å —É—á—ë—Ç–æ–º —É—Ä–æ–≤–Ω—è
    function getCharStats(charId) {
        const baseChar = characters[charId];
        if (!baseChar) return null;
        
        const level = charLevels[charId] || 0;
        const isMaxLevel = level >= 3;
        
        // –ë–æ–Ω—É—Å—ã –¥–ª—è –ú–ê–ö–°–ò–ú–£–ú: +20% —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ +20% –∂–∏–≤—É—á–µ—Å—Ç–∏ (—É–º–µ–Ω—å—à–µ–Ω–∏–µ hazard)
        const speedBonus = isMaxLevel ? 1.2 : 1.0;
        const hazardBonus = isMaxLevel ? 0.8 : 1.0; // —É–º–µ–Ω—å—à–∞–µ–º –Ω–∞ 20% (—É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 0.8)
        
        return {
            ...baseChar,
            speed: baseChar.speed * speedBonus,
            hazard: baseChar.hazard * hazardBonus,
            level: level,
            isMaxLevel: isMaxLevel
        };
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    function getCharLevel(charId) {
        return charLevels[charId] || 0;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    function upgradeChar(charId) {
        const currentLevel = charLevels[charId] || 0;
        if (currentLevel < 3) {
            charLevels[charId] = currentLevel + 1;
            localStorage.setItem('charLevels', JSON.stringify(charLevels));
            return charLevels[charId];
        }
        return currentLevel;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–µ—Ç –ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂ –µ—â—ë –≤—ã–ø–∞–¥–∞—Ç—å
    function canCharDrop(charId) {
        const level = charLevels[charId] || 0;
        return level < 3; // –ü–µ—Ä—Å–æ–Ω–∞–∂ –º–æ–∂–µ—Ç –≤—ã–ø–∞–¥–∞—Ç—å –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç —É—Ä–æ–≤–Ω—è 3 (–ú–ê–ö–°–ò–ú–£–ú)
    }

    // ===================== –°–£–ù–î–£–ö–ò =====================
    const chestTypes = {
        bubble: {
            id:    'bubble',
            name:  '–ü—É–∑—ã—Ä—å',
            cost:  20000,
            emoji: 'ü´ß',
            desc:  '–ù–∞–∂–º–∏ 5 —Ä–∞–∑, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å.\n–ö–∞–∂–¥—ã–π —É–¥–∞—Ä ‚Äî 20% —à–∞–Ω—Å –ø–æ–≤—ã—Å–∏—Ç—å —Ä–µ–¥–∫–æ—Å—Ç—å!',
            tapsNeeded: 5,
            upgradeChance: 0.20,
            murinoOnly: false,
            crystalCost: false
        },
        dymnost: {
            id:    'dymnost',
            name:  '–î—ã–º–Ω–æ—Å—Ç—å',
            cost:  50000,
            emoji: 'üå´Ô∏è',
            desc:  '–ù–∞–∂–º–∏ 5 —Ä–∞–∑, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å.\n–ö–∞–∂–¥—ã–π —É–¥–∞—Ä ‚Äî 30% —à–∞–Ω—Å –ø–æ–≤—ã—Å–∏—Ç—å —Ä–µ–¥–∫–æ—Å—Ç—å!\nüîí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –ª–æ–∫–∞—Ü–∏–∏ –ú—É—Ä–∏–Ω–æ',
            tapsNeeded: 5,
            upgradeChance: 0.30,
            murinoOnly: true,
            crystalCost: false
        },
        star: {
            id:    'star',
            name:  '–ó–≤–µ–∑–¥–∞',
            cost:  100,
            emoji: '‚≠ê',
            desc:  '–ù–∞–∂–º–∏ 6 —Ä–∞–∑, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å.\n–ö–∞–∂–¥—ã–π —É–¥–∞—Ä ‚Äî 35% —à–∞–Ω—Å –ø–æ–≤—ã—Å–∏—Ç—å —Ä–µ–¥–∫–æ—Å—Ç—å!\n–ü–æ–∫—É–ø–∞–µ—Ç—Å—è –∑–∞ üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã',
            tapsNeeded: 6,
            upgradeChance: 0.35,
            murinoOnly: false,
            crystalCost: true  // —Å—Ç–æ–∏—Ç –∫—Ä–∏—Å—Ç–∞–ª–ª—ã, –Ω–µ –¥—Ä—É–Ω–±–ª–µ–∏
        },
        pautina: {
            id:    'pautina',
            name:  '–ü–∞—É—Ç–∏–Ω–∞',
            cost:  45000,
            emoji: 'üï∏Ô∏è',
            desc:  '–ù–∞–∂–º–∏ 10 —Ä–∞–∑, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å.\n–ö–∞–∂–¥—ã–π —É–¥–∞—Ä ‚Äî 15% —à–∞–Ω—Å –ø–æ–≤—ã—Å–∏—Ç—å —Ä–µ–¥–∫–æ—Å—Ç—å!\nüîí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –ª–æ–∫–∞—Ü–∏–∏ –ú–æ–ª–æ—á–Ω–æ–µ',
            tapsNeeded: 10,
            upgradeChance: 0.15,
            murinoOnly: false,
            molochnoeOnly: true,
            crystalCost: false
        },
        crown: {
            id:    'crown',
            name:  '–ö–æ—Ä–æ–Ω–∞',
            cost:  250,
            emoji: 'üëë',
            desc:  '–ù–∞–∂–º–∏ 7 —Ä–∞–∑, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å.\n–ö–∞–∂–¥—ã–π —É–¥–∞—Ä ‚Äî 40% —à–∞–Ω—Å –ø–æ–≤—ã—Å–∏—Ç—å —Ä–µ–¥–∫–æ—Å—Ç—å!\nüíé –ü–æ–∫—É–ø–∞–µ—Ç—Å—è –∑–∞ –ê–ª–º–∞–∑—ã\nüîë –í—ã–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏ ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!',
            tapsNeeded: 7,
            upgradeChance: 0.40,
            murinoOnly: false,
            crystalCost: true,
            keysOnly: true   // —Ñ–ª–∞–≥: —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏, –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        }
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—É–Ω–¥—É–∫–∞
    let chestState = {
        active:      false,
        type:        null,
        rarity:      '–û–±—ã—á–Ω–æ—Å—Ç—å',
        tapsLeft:    5,
        fromScreen:  'start'  // –æ—Ç–∫—É–¥–∞ –æ—Ç–∫—Ä—ã–ª–∏ –º–µ–Ω—é —Å—É–Ω–¥—É–∫–æ–≤
    };

    // ===================== –ü–£–ó–´–†–¨-–ö–ê–ù–í–ê–° =====================
    const bubbleCanvas  = document.getElementById('bubbleCanvas');
    const bCtx          = bubbleCanvas.getContext('2d');
    let bubbleAnim      = 0;
    let bubbleAnimFrame = null;

    function drawBubble(rarity, shake) {
        const w = bubbleCanvas.width;
        const h = bubbleCanvas.height;
        bCtx.clearRect(0, 0, w, h);

        const isDym  = chestState.type === 'dymnost';
        const isStar = chestState.type === 'star';
        const isPautina = chestState.type === 'pautina';
        const isCrown = chestState.type === 'crown';

        const cx = w / 2 + (shake ? (Math.random() - 0.5) * 14 : 0);
        const cy = h / 2 + (shake ? (Math.random() - 0.5) * 14 : 0);
        const r  = 100;

        const color = rarityColors[rarity];
        const glow  = rarityGlow[rarity];

        // –í–Ω–µ—à–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ
        const glowGrad = bCtx.createRadialGradient(cx, cy, r * 0.5, cx, cy, r * 1.6);
        glowGrad.addColorStop(0, glow);
        glowGrad.addColorStop(1, 'transparent');
        bCtx.fillStyle = glowGrad;
        bCtx.beginPath();
        bCtx.arc(cx, cy, r * 1.6, 0, Math.PI * 2);
        bCtx.fill();

        if (isDym) {
            const t = bubbleAnim;
            for (let i = 0; i < 6; i++) {
                const angle = (i / 6) * Math.PI * 2 + t * 0.5;
                const ox = Math.cos(angle) * r * 0.28 * (1 + 0.15 * Math.sin(t * 1.3 + i));
                const oy = Math.sin(angle) * r * 0.28 * (1 + 0.15 * Math.cos(t * 1.1 + i));
                const puffR = r * 0.52 + 6 * Math.sin(t * 0.9 + i * 1.2);
                const puffGrad = bCtx.createRadialGradient(cx + ox, cy + oy, 0, cx + ox, cy + oy, puffR);
                puffGrad.addColorStop(0, 'rgba(180,180,200,0.55)');
                puffGrad.addColorStop(0.5, color.replace(')', ',0.25)').replace('rgb', 'rgba'));
                puffGrad.addColorStop(1, 'rgba(0,0,0,0)');
                bCtx.fillStyle = puffGrad;
                bCtx.beginPath();
                bCtx.arc(cx + ox, cy + oy, puffR, 0, Math.PI * 2);
                bCtx.fill();
            }
            bCtx.strokeStyle = color; bCtx.lineWidth = 2; bCtx.globalAlpha = 0.4;
            bCtx.beginPath(); bCtx.arc(cx, cy, r, 0, Math.PI * 2); bCtx.stroke();
            bCtx.globalAlpha = 1;

        } else if (isStar) {
            // –ó–≤–µ–∑–¥–∞ ‚Äî –≤—Ä–∞—â–∞—é—â–∞—è—Å—è –∑–æ–ª–æ—Ç–∞—è –∑–≤–µ–∑–¥–∞
            const t = bubbleAnim;
            const starR = r * (0.85 + 0.08 * Math.sin(t * 2));
            const innerR = starR * 0.45;
            const points = 5;
            const goldGrad = bCtx.createRadialGradient(cx, cy - starR * 0.2, starR * 0.1, cx, cy, starR);
            goldGrad.addColorStop(0, '#FFF8DC');
            goldGrad.addColorStop(0.35, color.replace(')', ',0.9)').replace('rgb','rgba'));
            goldGrad.addColorStop(1, 'rgba(180,120,0,0.3)');
            bCtx.fillStyle = goldGrad;
            bCtx.beginPath();
            for (let i = 0; i < points * 2; i++) {
                const rad = (i % 2 === 0 ? starR : innerR);
                const angle = (i * Math.PI / points) - Math.PI / 2 + t * 0.4;
                if (i === 0) bCtx.moveTo(cx + rad * Math.cos(angle), cy + rad * Math.sin(angle));
                else bCtx.lineTo(cx + rad * Math.cos(angle), cy + rad * Math.sin(angle));
            }
            bCtx.closePath(); bCtx.fill();
            // –ó–æ–ª–æ—Ç–æ–π –∫–æ–Ω—Ç—É—Ä
            bCtx.strokeStyle = '#FFD700'; bCtx.lineWidth = 3; bCtx.globalAlpha = 0.9;
            bCtx.stroke(); bCtx.globalAlpha = 1;
            // –ë–ª–∏–∫
            bCtx.fillStyle = 'rgba(255,255,220,0.5)';
            bCtx.beginPath(); bCtx.ellipse(cx - starR*0.2, cy - starR*0.3, starR*0.18, starR*0.09, -0.4, 0, Math.PI*2); bCtx.fill();
            // –ú–∞–ª–µ–Ω—å–∫–∏–µ –∑–≤—ë–∑–¥–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥
            for (let i = 0; i < 4; i++) {
                const a = (i / 4) * Math.PI * 2 + t * 0.7;
                const mx = cx + (r * 1.1) * Math.cos(a);
                const my = cy + (r * 1.1) * Math.sin(a);
                bCtx.fillStyle = '#FFD700'; bCtx.globalAlpha = 0.7;
                bCtx.font = '14px Arial'; bCtx.textAlign = 'center'; bCtx.textBaseline = 'middle';
                bCtx.fillText('‚òÖ', mx, my);
            }
            bCtx.globalAlpha = 1;

        } else if (isPautina) {
            // –ü–∞—É—Ç–∏–Ω–∞ ‚Äî –∑–µ–ª—ë–Ω–∞—è –ø–∞—É—Ç–∏–Ω–∞ —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π
            const t = bubbleAnim;
            const webR = r * (0.9 + 0.1 * Math.sin(t * 1.5));
            
            // –ó–µ–ª—ë–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
            const webGrad = bCtx.createRadialGradient(cx, cy, 0, cx, cy, webR);
            webGrad.addColorStop(0, color.replace(')', ',0.4)').replace('rgb','rgba'));
            webGrad.addColorStop(0.7, color.replace(')', ',0.15)').replace('rgb','rgba'));
            webGrad.addColorStop(1, 'rgba(0,0,0,0)');
            bCtx.fillStyle = webGrad;
            bCtx.beginPath();
            bCtx.arc(cx, cy, webR, 0, Math.PI * 2);
            bCtx.fill();
            
            // –†–∏—Å—É–µ–º –ø–∞—É—Ç–∏–Ω—É
            bCtx.strokeStyle = color;
            bCtx.lineWidth = 2;
            bCtx.globalAlpha = 0.6;
            
            // –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—á–µ—Å–∫–∏–µ –∫—Ä—É–≥–∏
            for (let i = 1; i <= 4; i++) {
                bCtx.beginPath();
                bCtx.arc(cx, cy, webR * (i / 4), 0, Math.PI * 2);
                bCtx.stroke();
            }
            
            // –†–∞–¥–∏–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                bCtx.beginPath();
                bCtx.moveTo(cx, cy);
                bCtx.lineTo(cx + webR * Math.cos(angle), cy + webR * Math.sin(angle));
                bCtx.stroke();
            }
            bCtx.globalAlpha = 1;

        } else if (isCrown) {
            // –ö–æ—Ä–æ–Ω–∞ ‚Äî –∑–æ–ª–æ—Ç–∞—è –≤—Ä–∞—â–∞—é—â–∞—è—Å—è –∫–æ—Ä–æ–Ω–∞ —Å –∞–ª–º–∞–∑–∞–º–∏
            const t = bubbleAnim;
            const crownR = r * (0.88 + 0.07 * Math.sin(t * 1.8));

            // –ó–æ–ª–æ—Ç–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –ø–æ–¥–ª–æ–∂–∫–∞
            const crownGlow = bCtx.createRadialGradient(cx, cy, crownR * 0.2, cx, cy, crownR * 1.2);
            crownGlow.addColorStop(0, 'rgba(255,215,0,0.45)');
            crownGlow.addColorStop(0.6, 'rgba(255,165,0,0.2)');
            crownGlow.addColorStop(1, 'rgba(0,0,0,0)');
            bCtx.fillStyle = crownGlow;
            bCtx.beginPath(); bCtx.arc(cx, cy, crownR * 1.2, 0, Math.PI * 2); bCtx.fill();

            // –†–∏—Å—É–µ–º –∫–æ—Ä–æ–Ω—É (–≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏)
            const cw = crownR * 1.3;
            const ch2 = crownR * 0.85;
            const baseY = cy + crownR * 0.35;
            const topY = baseY - ch2;
            const leftX = cx - cw / 2;
            const rightX = cx + cw / 2;
            const peakH = ch2 * 0.7;

            const crownGrad = bCtx.createLinearGradient(cx, topY - peakH, cx, baseY);
            crownGrad.addColorStop(0, '#FFF8DC');
            crownGrad.addColorStop(0.3, '#FFD700');
            crownGrad.addColorStop(0.7, '#DAA520');
            crownGrad.addColorStop(1, '#B8860B');
            bCtx.fillStyle = crownGrad;
            bCtx.beginPath();
            // –û—Å–Ω–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–æ–Ω—ã
            bCtx.moveTo(leftX, baseY);
            bCtx.lineTo(leftX, topY);
            // –õ–µ–≤—ã–π –ø–∏–∫
            bCtx.lineTo(leftX + cw * 0.18, topY - peakH * 0.6);
            // –õ–µ–≤—ã–π —Å—Ä–µ–¥–Ω–∏–π –ø–æ–¥—ä—ë–º
            bCtx.lineTo(leftX + cw * 0.35, topY - peakH * 0.2);
            // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ø–∏–∫ (—Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π)
            bCtx.lineTo(cx, topY - peakH);
            // –ü—Ä–∞–≤—ã–π —Å—Ä–µ–¥–Ω–∏–π –ø–æ–¥—ä—ë–º
            bCtx.lineTo(rightX - cw * 0.35, topY - peakH * 0.2);
            // –ü—Ä–∞–≤—ã–π –ø–∏–∫
            bCtx.lineTo(rightX - cw * 0.18, topY - peakH * 0.6);
            bCtx.lineTo(rightX, topY);
            bCtx.lineTo(rightX, baseY);
            bCtx.closePath();
            bCtx.fill();

            // –ó–æ–ª–æ—Ç–æ–π –∫–æ–Ω—Ç—É—Ä
            bCtx.strokeStyle = '#FFD700'; bCtx.lineWidth = 2.5; bCtx.globalAlpha = 0.9;
            bCtx.stroke(); bCtx.globalAlpha = 1;

            // –ê–ª–º–∞–∑—ã –Ω–∞ –ø–∏–∫–∞—Ö
            const gemPositions = [
                { x: leftX + cw * 0.18, y: topY - peakH * 0.6 - 9 },
                { x: cx,                 y: topY - peakH - 11 },
                { x: rightX - cw * 0.18, y: topY - peakH * 0.6 - 9 }
            ];
            const gemColors = ['#4FC3F7', '#CE93D8', '#FF6B6B'];
            gemPositions.forEach((g, i) => {
                const gs = 7 + 2 * (i === 1 ? 1 : 0);
                bCtx.fillStyle = gemColors[i]; bCtx.globalAlpha = 0.95;
                bCtx.beginPath();
                bCtx.moveTo(g.x, g.y - gs);
                bCtx.lineTo(g.x + gs * 0.7, g.y);
                bCtx.lineTo(g.x, g.y + gs * 0.55);
                bCtx.lineTo(g.x - gs * 0.7, g.y);
                bCtx.closePath(); bCtx.fill();
                bCtx.strokeStyle = '#fff'; bCtx.lineWidth = 1; bCtx.stroke();
                bCtx.globalAlpha = 1;
            });

            // –ë–ª–∏–∫ –Ω–∞ –∫–æ—Ä–æ–Ω–µ
            bCtx.fillStyle = 'rgba(255,255,230,0.5)';
            bCtx.beginPath(); bCtx.ellipse(cx - cw * 0.18, topY - peakH * 0.35, cw * 0.12, ch2 * 0.08, -0.3, 0, Math.PI * 2); bCtx.fill();

            // –í—Ä–∞—â–∞—é—â–∏–µ—Å—è –∫–ª—é—á–∏–∫–∏ –≤–æ–∫—Ä—É–≥
            for (let i = 0; i < 5; i++) {
                const a = (i / 5) * Math.PI * 2 + t * 0.6;
                const kx = cx + (crownR * 1.35) * Math.cos(a);
                const ky = cy + (crownR * 1.35) * Math.sin(a);
                bCtx.fillStyle = '#FFD700'; bCtx.globalAlpha = 0.75;
                bCtx.font = '13px Arial'; bCtx.textAlign = 'center'; bCtx.textBaseline = 'middle';
                bCtx.fillText('üîë', kx, ky);
            }
            bCtx.globalAlpha = 1;

        } else {
            // –ü—É–∑—ã—Ä—å ‚Äî —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π —à–∞—Ä
            const grad = bCtx.createRadialGradient(cx - r * 0.3, cy - r * 0.3, r * 0.05, cx, cy, r);
            grad.addColorStop(0,   'rgba(255,255,255,0.55)');
            grad.addColorStop(0.3, color.replace(')', ',0.35)').replace('rgb', 'rgba'));
            grad.addColorStop(0.7, color.replace(')', ',0.18)').replace('rgb', 'rgba'));
            grad.addColorStop(1,   'rgba(0,0,0,0.0)');
            bCtx.fillStyle = grad;
            bCtx.beginPath(); bCtx.arc(cx, cy, r, 0, Math.PI * 2); bCtx.fill();
            bCtx.strokeStyle = color; bCtx.lineWidth = 3; bCtx.globalAlpha = 0.7;
            bCtx.beginPath(); bCtx.arc(cx, cy, r, 0, Math.PI * 2); bCtx.stroke(); bCtx.globalAlpha = 1;
            bCtx.fillStyle = 'rgba(255,255,255,0.55)';
            bCtx.beginPath(); bCtx.ellipse(cx - r * 0.32, cy - r * 0.35, r * 0.22, r * 0.13, -0.5, 0, Math.PI * 2); bCtx.fill();
            bCtx.fillStyle = 'rgba(255,255,255,0.25)';
            bCtx.beginPath(); bCtx.ellipse(cx + r * 0.28, cy + r * 0.32, r * 0.1, r * 0.06, 0.8, 0, Math.PI * 2); bCtx.fill();
        }

        // –≠–º–æ–¥–∑–∏ –≤–Ω—É—Ç—Ä–∏
        bCtx.font = '42px Arial';
        bCtx.textAlign    = 'center';
        bCtx.textBaseline = 'middle';
        bCtx.globalAlpha  = 1;
        bCtx.fillText(isDym ? 'üå´Ô∏è' : isStar ? '‚≠ê' : isPautina ? 'üï∏Ô∏è' : isCrown ? '' : 'ü´ß', cx, cy);

        if (!isDym && !isStar && !isPautina && !isCrown) {
            // –ú–∞–ª–µ–Ω—å–∫–∏–µ –ø—É–∑—ã—Ä–∏–∫–∏ –≤–æ–∫—Ä—É–≥ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ü—É–∑—ã—Ä—è)
            const t = bubbleAnim;
            [[0.15, -0.15, 18], [0.18, 0.12, 12], [-0.14, 0.16, 10]].forEach(([dx, dy, rr]) => {
                const px = cx + r * dx * (1 + 0.15 * Math.sin(t + dx * 10));
                const py = cy + r * dy * (1 + 0.15 * Math.cos(t + dy * 10));
                const miniGrad = bCtx.createRadialGradient(px - rr * 0.3, py - rr * 0.3, 1, px, py, rr);
                miniGrad.addColorStop(0, 'rgba(255,255,255,0.6)');
                miniGrad.addColorStop(1, color.replace(')', ',0.2)').replace('rgb', 'rgba'));
                bCtx.fillStyle = miniGrad;
                bCtx.beginPath();
                bCtx.arc(px, py, rr, 0, Math.PI * 2);
                bCtx.fill();
                bCtx.strokeStyle = color;
                bCtx.lineWidth = 1.5;
                bCtx.globalAlpha = 0.5;
                bCtx.stroke();
                bCtx.globalAlpha = 1;
            });
        }
    }

    function animateBubble() {
        bubbleAnim += 0.04;
        drawBubble(chestState.rarity, false);
        bubbleAnimFrame = requestAnimationFrame(animateBubble);
    }

    function stopBubbleAnim() {
        if (bubbleAnimFrame) {
            cancelAnimationFrame(bubbleAnimFrame);
            bubbleAnimFrame = null;
        }
    }

    // ===================== –û–¢–ö–†–´–¢–ò–ï –°–£–ù–î–£–ö–ê =====================
    function buyAndOpenChest(typeId) {
        const chest = chestTypes[typeId];
        if (chest.crystalCost) {
            if (totalCrystals < chest.cost) { showMessage('üíé –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤!', 1500); return; }
            totalCrystals -= chest.cost;
            localStorage.setItem('totalCrystals', totalCrystals);
        } else {
            if (totalEarned < chest.cost) { showMessage('üí∞ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥—Ä—É–Ω–±–ª–µ–π!', 1500); return; }
            totalEarned -= chest.cost;
            localStorage.setItem('totalEarned', totalEarned);
            updatePassProgress(chest.cost); // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–∞—Å—Å–∞
        }

        // –ù–∞—á–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ
        chestState.active   = true;
        chestState.type     = typeId;
        chestState.rarity   = '–û–±—ã—á–Ω–æ—Å—Ç—å';
        chestState.tapsLeft = chest.tapsNeeded;

        updateChestOpenUI();

        document.getElementById('chestScreen').style.display       = 'none';
        document.getElementById('chestOpenOverlay').classList.add('active');

        stopBubbleAnim();
        animateBubble();
    }

    function updateChestOpenUI() {
        const rarLabel = document.getElementById('chestRarityLabel');
        rarLabel.textContent  = chestState.rarity;
        rarLabel.style.color  = rarityColors[chestState.rarity];
        rarLabel.style.textShadow = '0 0 20px ' + rarityColors[chestState.rarity];

        const t = chestState.tapsLeft;
        document.getElementById('chestTapsLeft').textContent =
            t === 1 ? '–ü–æ—Å–ª–µ–¥–Ω–∏–π —É–¥–∞—Ä!' : '–ù–∞–∂–º–∏ –µ—â—ë ' + t + ' —Ä–∞–∑';
    }

    // –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –ø—É–∑—ã—Ä—å
    bubbleCanvas.addEventListener('click',     tapBubble);
    bubbleCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); tapBubble(); }, { passive: false });

    function tapBubble() {
        if (!chestState.active) return;
        if (chestState.tapsLeft <= 0) return;

        const chest = chestTypes[chestState.type];
        sfxChestTap();

        drawBubble(chestState.rarity, true);
        setTimeout(() => drawBubble(chestState.rarity, false), 120);

        // –®–∞–Ω—Å –ø–æ–≤—ã—Å–∏—Ç—å —Ä–µ–¥–∫–æ—Å—Ç—å
        const curRarIdx = RARITIES.indexOf(chestState.rarity);
        if (curRarIdx < RARITIES.length - 1 && Math.random() < chest.upgradeChance) {
            chestState.rarity = RARITIES[curRarIdx + 1];
            sfxChestRarityUp();
            flashRarityLabel();
        }

        chestState.tapsLeft--;
        updateChestOpenUI();

        if (chestState.tapsLeft <= 0) {
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –¥–∞–ª—å–Ω–µ–π—à–∏–µ –Ω–∞–∂–∞—Ç–∏—è –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ
            chestState.tapsLeft = 0;
            setTimeout(openChestResult, 200);
        }
    }

    function flashRarityLabel() {
        const el = document.getElementById('chestRarityLabel');
        el.classList.remove('rarity-flash');
        void el.offsetWidth; // reflow
        el.classList.add('rarity-flash');
        updateChestOpenUI();
    }

    function openChestResult() {
        stopBubbleAnim();

        // –ê–Ω–∏–º–∞—Ü–∏—è –ª–æ–ø–∞–Ω–∏—è –ø—É–∑—ã—Ä—è
        bubbleCanvas.classList.add('bubble-popping');

        setTimeout(() => {
            bubbleCanvas.classList.remove('bubble-popping');
            document.getElementById('chestOpenOverlay').classList.remove('active');

            // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É
            const rarity  = chestState.rarity;
            const chest_cfg = chestTypes[chestState.type];

            // –°—É–Ω–¥—É–∫ –ö–æ—Ä–æ–Ω–∞ ‚Äî –≤—Å–µ–≥–¥–∞ –≤—ã–¥–∞—ë—Ç –∫–ª—é—á –Ω—É–∂–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–µ—Ç
            if (chest_cfg && chest_cfg.keysOnly) {
                const keyEmojis = { '–û–±—ã—á–Ω–æ—Å—Ç—å': 'üîë', '–†–µ–¥–∫–æ—Å—Ç—å': 'üóùÔ∏è', '–í–µ–ª–∏–∫–æ—Å—Ç—å': 'üîê', '–ú–µ–º–Ω–æ—Å—Ç—å': 'üóùÔ∏è', '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å': 'üîê' };
                showChestResultKey(rarity, keyEmojis[rarity] || 'üîë');
                return;
            }

            const pool    = (charsByRarity[rarity] || []).filter(id => {
                if (!canCharDrop(id)) return false;  // –ø–µ—Ä—Å–æ–Ω–∞–∂ –¥–æ—Å—Ç–∏–≥ –º–∞–∫—Å–∏–º—É–º–∞
                if (characters[id].murinoOnly && !murinoUnlocked) return false;  // –º—É—Ä–∏–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ
                if (characters[id].molochnoeOnly && !molochnoeUnlocked) return false;  // –º–æ–ª–æ—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–æ
                return true;
            });
            let wonCharId = null;

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–≥–æ –≤—ã–¥–∞—Ç—å ‚Äî 50% —à–∞–Ω—Å –ø–µ—Ä—Å–æ–Ω–∞–∂, 50% –ø—É—Å—Ç–æ
            if (pool.length > 0 && Math.random() < 0.5) {
                wonCharId = pool[Math.floor(Math.random() * pool.length)];
            }

            showChestResult(rarity, wonCharId);
        }, 380);
    }

    function showChestResult(rarity, charId) {
        if (charId) { sfxChestOpen(); } else { sfxChestEmpty(); }
        const color = rarityColors[rarity];
        const resultBox = document.getElementById('resultBox');

        resultBox.style.border     = '3px solid ' + color;
        resultBox.style.boxShadow  = '0 0 40px ' + rarityGlow[rarity];

        if (charId) {
            const ch = characters[charId];
            const oldLevel = getCharLevel(charId);
            const newLevel = upgradeChar(charId);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ unlocked –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
            if (!unlocked.includes(charId)) {
                unlocked.push(charId);
                localStorage.setItem('unlocked', JSON.stringify(unlocked));
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å –±–æ–Ω—É—Å–∞–º–∏
            const finalStats = getCharStats(charId);
            
            document.getElementById('resultEmoji').textContent = charEmoji[charId];
            document.getElementById('resultName').textContent  = ch.name;
            document.getElementById('resultName').style.color  = ch.color;

            const rarEl = document.getElementById('resultRarity');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —É—Ä–æ–≤–Ω—è
            let levelText = '';
            if (newLevel === 1 && oldLevel === 0) {
                levelText = '‚ú¶ ' + rarity + ' ‚ú¶ –û–¢–ö–†–´–¢!';
            } else if (newLevel === 2) {
                levelText = '‚ú¶ ' + rarity + ' ‚ú¶ –£–õ–£–ß–®–ï–ù! (1/2)';
            } else if (newLevel === 3) {
                levelText = '‚ú¶ ' + rarity + ' ‚ú¶ üèÜ –ú–ê–ö–°–ò–ú–£–ú! üèÜ';
            }
            
            rarEl.textContent  = levelText;
            rarEl.style.color  = color;

            let descText = '–°–∫–æ—Ä–æ—Å—Ç—å: ' + (finalStats.speed * 100).toFixed(0) + '%  ‚Ä¢  –ñ–∏–≤—É—á–µ—Å—Ç—å: ' + (finalStats.hazard * 100).toFixed(0) + '%' +
                (ch.shoot ? '  ‚Ä¢  üî´ –°—Ç—Ä–µ–ª—è–µ—Ç' : '');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ–Ω—É—Å–∞—Ö –ú–ê–ö–°–ò–ú–£–ú –∏ —à–∫–∞–ª—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const progressPct = Math.round((newLevel / 3) * 100);
            const barColor = newLevel >= 3 ? '#FFD700' : '#00D4FF';
            let progressBar = '<div style="margin:10px 0 4px;text-align:left;">' +
                '<div style="display:flex;justify-content:space-between;font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:4px;">' +
                    '<span>–ü—Ä–æ–∫–∞—á–∫–∞</span>' +
                    '<span style="color:' + barColor + ';font-weight:bold;">' + newLevel + ' / 3</span>' +
                '</div>' +
                '<div style="background:rgba(255,255,255,0.2);border-radius:8px;height:12px;overflow:hidden;">' +
                    '<div style="width:' + progressPct + '%;height:100%;background:' + barColor + ';border-radius:8px;box-shadow:0 0 8px ' + barColor + ';transition:width 0.5s;"></div>' +
                '</div>' +
                '<div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px;text-align:center;">' +
                    (newLevel >= 3 ? 'üèÜ –ú–ê–ö–°–ò–ú–£–ú –î–û–°–¢–ò–ì–ù–£–¢! +20% –∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º' : ('üì¶ –ï—â—ë ' + (3 - newLevel) + ' —Ä–∞–∑ –≤—ã–±–∏—Ç—å –∏–∑ —Å—É–Ω–¥—É–∫–æ–≤')) +
                '</div>' +
            '</div>';
            
            if (newLevel === 3) {
                descText += '\n\nüèÜ –ú–ê–ö–°–ò–ú–£–ú: +20% —Å–∫–æ—Ä–æ—Å—Ç–∏, +20% –∂–∏–≤—É—á–µ—Å—Ç–∏!';
            } else if (newLevel < 3) {
                descText += '\n\n‚¨ÜÔ∏è –ü—Ä–æ–≥—Ä–µ—Å—Å: ' + newLevel + '/3 (–µ—â—ë ' + (3 - newLevel) + ' —Ä–∞–∑ –¥–æ –ú–ê–ö–°–ò–ú–£–ú)';
            }
            
            document.getElementById('resultDesc').innerHTML = progressBar + '<div style="color:rgba(255,255,255,0.7);font-size:13px;margin-top:6px;">' + descText.replace(/\n/g, '<br>') + '</div>';
        } else {
            document.getElementById('resultEmoji').textContent = 'üí®';
            document.getElementById('resultName').textContent  = '–ü–£–°–¢–û';
            document.getElementById('resultName').style.color  = 'rgba(255,255,255,0.6)';

            const rarEl = document.getElementById('resultRarity');
            rarEl.textContent  = '‚ú¶ ' + rarity + ' ‚ú¶';
            rarEl.style.color  = color;

            document.getElementById('resultDesc').textContent = '–í —ç—Ç–æ—Ç —Ä–∞–∑ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–∞–ª–æ...';
        }

        document.getElementById('chestResultOverlay').classList.add('active');
    }

    // –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—É–Ω–¥—É–∫–∞ –ö–æ—Ä–æ–Ω–∞ ‚Äî —Ç–æ–ª—å–∫–æ –∫–ª—é—á
    function showChestResultKey(rarity, emoji) {
        sfxChestOpen();
        const color = rarityColors[rarity];
        const resultBox = document.getElementById('resultBox');
        resultBox.style.border    = '3px solid #FFD700';
        resultBox.style.boxShadow = '0 0 40px rgba(255,215,0,0.8)';

        document.getElementById('resultEmoji').textContent = emoji;
        document.getElementById('resultName').textContent  = '–ö–õ–Æ–ß';
        document.getElementById('resultName').style.color  = '#FFD700';

        const rarEl = document.getElementById('resultRarity');
        rarEl.textContent = 'üëë –ö–û–†–û–ù–ê ‚Äî ' + rarity.toUpperCase() + ' –ö–õ–Æ–ß';
        rarEl.style.color = color;

        document.getElementById('resultDesc').innerHTML =
            '<div style="color:rgba(255,255,255,0.85);font-size:14px;margin:8px 0;">–¢—ã –ø–æ–ª—É—á–∏–ª –∫–ª—é—á —Ä–µ–¥–∫–æ—Å—Ç–∏ <span style="color:' + color + ';font-weight:bold;">' + rarity + '</span>!<br><br>' +
            '–ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω—É–∂–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏.</div>' +
            '<button onclick="useCrownKey(\'' + rarity + '\')" style="margin-top:10px;width:100%;padding:10px;border-radius:20px;font-size:16px;background:linear-gradient(135deg,#FFD700,#FFA500);border:2px solid white;color:#000;font-weight:bold;">üîë –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á</button>';

        document.getElementById('chestResultOverlay').classList.add('active');
    }

    function useCrownKey(rarity) {
        document.getElementById('chestResultOverlay').classList.remove('active');
        chestState.active = false;
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º tier=-1 –∫–∞–∫ –º–∞—Ä–∫–µ—Ä (–∫–æ—Ä–æ–Ω–∞)
        openKeySelect(-99, rarity);
    }

    function closeResult() {
        document.getElementById('chestResultOverlay').classList.remove('active');
        chestState.active = false;
        // –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —ç–∫—Ä–∞–Ω —Å—É–Ω–¥—É–∫–æ–≤ –∏–ª–∏ –ø–∞—Å—Å
        if (chestState.fromScreen === 'pass') {
            openPass(_passFrom);
        } else {
            openChests(chestState.fromScreen);
        }
    }

    function cancelChestOpen() {
        // –û—Ç–º–µ–Ω–∞ ‚Äî –¥–µ–Ω—å–≥–∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è (—Å—É–Ω–¥—É–∫ —É–∂–µ –∫—É–ø–ª–µ–Ω)
        stopBubbleAnim();
        chestState.active = false;
        document.getElementById('chestOpenOverlay').classList.remove('active');
        if (chestState.fromScreen === 'pass') {
            openPass(_passFrom);
        } else {
            openChests(chestState.fromScreen);
        }
    }

    // ===================== –ù–ê–í–ò–ì–ê–¶–ò–Ø –°–£–ù–î–£–ö–ò =====================
    let _chestFromScreen = 'start';

    function openChests(from) {
        _chestFromScreen        = from || 'start';
        chestState.fromScreen   = _chestFromScreen;

        document.getElementById('startScreen').style.display   = 'none';
        document.getElementById('deathScreen').style.display   = 'none';
        document.getElementById('victoryScreen').style.display = 'none';
        document.getElementById('shopScreen').style.display    = 'none';

        document.getElementById('chestBalance').textContent   = totalEarned.toLocaleString();
        document.getElementById('crystalBalance').textContent = totalCrystals.toLocaleString();
        renderChests();
        document.getElementById('chestScreen').style.display = 'flex';
    }

    function closeChests() {
        document.getElementById('chestScreen').style.display = 'none';
        const from = _chestFromScreen;
        if (from === 'death')   { document.getElementById('deathScreen').style.display   = 'flex'; }
        else if (from === 'victory') { document.getElementById('victoryScreen').style.display = 'flex'; }
        else                    { document.getElementById('startScreen').style.display   = 'flex'; }
    }

    function renderChests() {
        document.getElementById('chestBalance').textContent   = totalEarned.toLocaleString();
        document.getElementById('crystalBalance').textContent = totalCrystals.toLocaleString();
        const grid = document.getElementById('chestGrid');
        grid.innerHTML = '';

        Object.values(chestTypes).forEach(chest => {
            const isLockedByMurino = chest.murinoOnly && !murinoUnlocked;
            const isLockedByMolochnoe = chest.molochnoeOnly && !molochnoeUnlocked;
            const isLocked = isLockedByMurino || isLockedByMolochnoe;
            const canBuy   = !isLocked && (chest.crystalCost ? totalCrystals >= chest.cost : totalEarned >= chest.cost);

            // –ü—É–ª –Ω–∞–≥—Ä–∞–¥, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑ —ç—Ç–æ–≥–æ —Å—É–Ω–¥—É–∫–∞
            // –î—ã–º–Ω–æ—Å—Ç—å –≤—ã–¥–∞—ë—Ç —Ç–µ—Ö –∂–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —á—Ç–æ –∏ –ø—É–∑—ã—Ä—å
            let rewardLines = '';
            if (chest.keysOnly) {
                // –ö–æ—Ä–æ–Ω–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª—é—á–∏ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç—è–º
                const keyEmojis2 = { '–û–±—ã—á–Ω–æ—Å—Ç—å': 'üîë', '–†–µ–¥–∫–æ—Å—Ç—å': 'üóùÔ∏è', '–í–µ–ª–∏–∫–æ—Å—Ç—å': 'üîê', '–ú–µ–º–Ω–æ—Å—Ç—å': 'üóùÔ∏è', '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å': 'üîê' };
                rewardLines = '<div style="font-size:12px;color:#FFD700;margin-bottom:6px;font-weight:bold;">üîë –¢–æ–ª—å–∫–æ –∫–ª—é—á–∏ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–µ—Ç!</div>';
                RARITIES.forEach(rar => {
                    rewardLines += '<div style="font-size:11px;color:' + rarityColors[rar] + ';margin:3px 0;">' +
                        keyEmojis2[rar] + ' –ö–ª—é—á ¬´' + rar + '¬ª</div>';
                });
                rewardLines += '<div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:6px;">–†–µ–¥–∫–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É–¥–∞—á–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏</div>';
            } else {
            RARITIES.forEach(rar => {
                const pool = (charsByRarity[rar] || []).filter(id => canCharDrop(id));
                if (pool.length > 0) {
                    rewardLines +=
                        '<div style="font-size:11px;color:' + rarityColors[rar] + ';margin:3px 0;">' +
                        '‚ú¶ ' + rar + ':</div>' +
                        pool.map(id => {
                            const level = getCharLevel(id);
                            const pct = Math.round((level / 3) * 100);
                            const barColor = level >= 3 ? '#FFD700' : rarityColors[rar];
                            return '<div style="margin:2px 0 4px;padding:3px 0;">' +
                                '<div style="display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,0.7);">' +
                                    '<span>' + characters[id].name + '</span>' +
                                    '<span style="color:' + barColor + ';">' + level + '/3' + (level >= 3 ? ' ‚úì' : '') + '</span>' +
                                '</div>' +
                                '<div style="background:rgba(255,255,255,0.1);border-radius:4px;height:5px;overflow:hidden;margin-top:2px;">' +
                                    '<div style="width:' + pct + '%;height:100%;background:' + barColor + ';border-radius:4px;"></div>' +
                                '</div>' +
                            '</div>';
                        }).join('');
                }
            });
            }
            if (!rewardLines) {
                rewardLines = '<div style="font-size:11px;color:#888;">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –ú–ê–ö–°–ò–ú–£–ú!</div>';
            }

            const card = document.createElement('div');
            card.className = 'chest-card';

            if (isLocked) {
                // –ö–∞—Ä—Ç–æ—á–∫–∞ ‚Äî –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
                const lockLabel = isLockedByMurino ? 'üå´Ô∏è –û—Ç–∫—Ä—ã—Ç—å –ª–æ–∫–∞—Ü–∏—é –ú—É—Ä–∏–Ω–æ' : 'üï∏Ô∏è –û—Ç–∫—Ä—ã—Ç—å –ª–æ–∫–∞—Ü–∏—é –ú–æ–ª–æ—á–Ω–æ–µ';
                const lockColor = isLockedByMurino ? '#8B008B' : '#228B22';
                card.style.borderColor = isLockedByMurino ? 'rgba(139,0,139,0.6)' : 'rgba(34,139,34,0.6)';
                card.style.background  = isLockedByMurino ? 'rgba(30,0,50,0.5)' : 'rgba(20,50,20,0.5)';
                card.innerHTML =
                    '<div style="font-size:64px;margin:8px 0;filter:grayscale(0.6) drop-shadow(0 0 12px ' + (isLockedByMurino ? 'rgba(139,0,139,0.6)' : 'rgba(34,139,34,0.6)') + ');">' + chest.emoji + '</div>' +
                    '<div style="font-family:Righteous,cursive;font-size:22px;color:#ccc;margin-bottom:6px;">' + chest.name + '</div>' +
                    '<div style="background:' + lockColor + ';color:white;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:bold;display:inline-block;margin-bottom:8px;">' + lockLabel + '</div>' +
                    '<div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:10px;line-height:1.5;">' + chest.desc.replace(/\n/g, '<br>') + '</div>' +
                    '<button disabled style="width:100%;padding:10px;border-radius:20px;font-size:16px;background:#333;border:2px solid #555;color:#888;font-weight:bold;">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</button>';
            } else {
                // –û–±—ã—á–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
                const isMurino = chest.murinoOnly;
                const isMolochnoe = chest.molochnoeOnly;
                const isStarChest = chest.crystalCost && !chest.keysOnly;
                const isCrownChest = !!chest.keysOnly;
                card.style.borderColor = canBuy
                    ? (isMurino ? 'rgba(139,0,139,0.9)' : isMolochnoe ? 'rgba(34,139,34,0.9)' : isCrownChest ? 'rgba(255,215,0,1.0)' : isStarChest ? 'rgba(255,215,0,0.9)' : 'rgba(0,212,255,0.7)')
                    : 'rgba(255,255,255,0.2)';
                if (isMurino)    card.style.background = 'rgba(60,0,80,0.4)';
                if (isMolochnoe) card.style.background = 'rgba(20,50,20,0.4)';
                if (isStarChest) card.style.background = 'rgba(50,40,0,0.5)';
                if (isCrownChest) card.style.background = 'rgba(60,50,0,0.6)';

                const openEmoji = isMurino ? 'üå´Ô∏è' : isMolochnoe ? 'üï∏Ô∏è' : isCrownChest ? 'üëë' : (isStarChest ? '‚≠ê' : 'ü´ß');
                const glowColor = isMurino ? 'rgba(139,0,139,0.8)' : isMolochnoe ? 'rgba(34,139,34,0.8)' : isCrownChest ? 'rgba(255,215,0,1.0)' : isStarChest ? 'rgba(255,215,0,0.9)' : 'rgba(0,212,255,0.8)';
                const costLabel = (isStarChest || isCrownChest) ? chest.cost.toLocaleString() + ' üíé' : chest.cost.toLocaleString() + ' üí∞';

                card.innerHTML =
                    (isMurino    ? '<div style="background:linear-gradient(135deg,#8B008B,#4B0082);color:white;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:bold;margin-bottom:6px;display:inline-block;">üå´Ô∏è –ú–£–†–ò–ù–û</div><br>' : '') +
                    (isMolochnoe ? '<div style="background:linear-gradient(135deg,#228B22,#90EE90);color:white;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:bold;margin-bottom:6px;display:inline-block;">üï∏Ô∏è –ú–û–õ–û–ß–ù–û–ï</div><br>' : '') +
                    (isStarChest ? '<div style="background:linear-gradient(135deg,#B8860B,#FFD700);color:#000;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:bold;margin-bottom:6px;display:inline-block;">üíé –ó–ê –ö–†–ò–°–¢–ê–õ–õ–´</div><br>' : '') +
                    (isCrownChest ? '<div style="background:linear-gradient(135deg,#B8860B,#FFD700);color:#000;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:bold;margin-bottom:6px;display:inline-block;">üëë –ö–û–†–û–ù–ê ‚Äî –¢–û–õ–¨–ö–û –ö–õ–Æ–ß–ò</div><br>' : '') +
                    '<div style="font-size:64px;margin:8px 0;filter:drop-shadow(0 0 12px ' + glowColor + ');">' + chest.emoji + '</div>' +
                    '<div style="font-family:Righteous,cursive;font-size:22px;color:#fff;margin-bottom:6px;">' + chest.name + '</div>' +
                    '<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:10px;line-height:1.5;">' + chest.desc.replace(/\n/g, '<br>') + '</div>' +
                    '<div style="background:rgba(0,0,0,0.3);border-radius:10px;padding:8px;margin-bottom:12px;">' +
                        '<div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:4px;">–í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã:</div>' +
                        rewardLines +
                    '</div>' +
                    '<button onclick="buyAndOpenChest(\'' + chest.id + '\')"' +
                        (!canBuy ? ' disabled' : '') +
                        ' style="width:100%;padding:10px;border-radius:20px;font-size:16px;background:' +
                        (canBuy ? (isMurino ? 'linear-gradient(135deg,#8B008B,#4B0082)' : isMolochnoe ? 'linear-gradient(135deg,#228B22,#90EE90)' : isCrownChest ? 'linear-gradient(135deg,#DAA520,#FFD700)' : 'linear-gradient(135deg,#FFD700,#FFA500)') : '#444') +
                        ';border:2px solid white;color:' + (isCrownChest ? '#000' : 'white') + ';font-weight:bold;">' +
                        (canBuy ? openEmoji + ' –û–¢–ö–†–´–¢–¨ ‚Äî ' + costLabel : 'üîí ' + costLabel) +
                    '</button>';
            }

            grid.appendChild(card);
        });
    }

    // ===================== GAME ENTITIES =====================
    let coins      = [];
    let enemies    = [];
    let projectiles = [];
    let showers    = [];
    let arthur     = null;
    let emperor    = null;
    let shootCooldown   = 0;
    let playerSlowUntil = 0;
    let aoeExplosions   = [];  // –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –≤–∑—Ä—ã–≤—ã –ë—ç–º –ë—ç–º
    let enemySpawnTimer = 0;   // —Ç–∞–π–º–µ—Ä —Å–ø–∞–≤–Ω–∞ –≤—Ä–∞–≥–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
    let pushCooldown    = 0;   // –∫—É–ª–¥–∞—É–Ω —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ ¬´–Ø —É–∂–µ –∫—Ä–∞—Å–Ω—ã–π¬ª (300 –∫–∞–¥—Ä–æ–≤ = 5—Å)
    let invisibilityCooldown = 0;  // –∫—É–ª–¥–∞—É–Ω –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç–∏ –ö—å–æ (900 –∫–∞–¥—Ä–æ–≤ = 15—Å)
    let invisibleUntil  = 0;   // –≤—Ä–µ–º—è –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫ –Ω–µ–≤–∏–¥–∏–º

    // ===================== –ê–õ–¨–ú–ê–ù–ê–• =====================
    // –î–∞–Ω–Ω—ã–µ –æ –≤—Ä–∞–≥–∞—Ö (seen ‚Äî –≤–∏–¥–µ–ª –ª–∏ –∏–≥—Ä–æ–∫ —ç—Ç–æ–≥–æ –≤—Ä–∞–≥–∞)
    const enemyLore = [
        {
            id:       'gryaznya',
            name:     '–ì—Ä—è–∑—å',
            icon:     'ü™£',
            location: '–ú—ã—Ç–∏—â–∏',
            locColor: '#8B7355',
            desc:     '–í—Ä–∞–∂–µ—Å–∫–∏–µ —é–Ω–∏—Ç—ã –∏–∑ –ú—ã—Ç–∏—â –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–æ—é—Ç—Å—è, –∏ –ø—ã—Ç–∞—é—Ç—Å—è –∑–∞–≥—Ä—è–∑–Ω–∏—Ç—å –≤–∞—Å. –ë–µ–≥—É—Ç –ø—Ä—è–º–æ –Ω–∞ –≤–∞—Å ‚Äî –Ω–µ –¥–∞–π—Ç–µ –∏–º –∫–æ—Å–Ω—É—Ç—å—Å—è!',
            seenIn:   ['mytishchi']
        },
        {
            id:       'fog_shooter',
            name:     '–ú—ã—Ç–∏—â–∏–Ω—Å–∫–∏–π –§–æ–≥',
            icon:     'ü´ß',
            location: '–ú—ã—Ç–∏—â–∏',
            locColor: '#00BFFF',
            desc:     '–ñ–∏—Ç–µ–ª—å –ú—É—Ä–∏–Ω–æ –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–±—Ä–∞–ª—Å—è –≤ –ú—ã—Ç–∏—â–∏ —á—Ç–æ–±—ã —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å –≤–∞—Å —Å–≤–æ–∏–º–∏ –ø—É–∑—ã—Ä—è–º–∏. –°—Ç–æ–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ –∏ —Å—Ç—Ä–µ–ª—è–µ—Ç ‚Äî –¥–µ—Ä–∂–∏—Ç–µ—Å—å –ø–æ–¥–∞–ª—å—à–µ!',
            seenIn:   ['mytishchi']
        },
        {
            id:       'pakost',
            name:     '–ö–∏—Å–ª–æ—Å—Ç—å',
            icon:     'üêá',
            location: '–ú—É—Ä–∏–Ω–æ',
            locColor: '#FF69B4',
            desc:     '–ö—Ä–æ–ª–∏–∫ –∂–∏–≤—É—â–∏–π –≤ –ú—É—Ä–∏–Ω–æ. –í—ã –µ–º—É –Ω–µ –Ω—Ä–∞–≤–∏—Ç–µ—Å—å, –ø–æ—ç—Ç–æ–º—É –æ–Ω –∑–∞–∫–∏–¥–∞–µ—Ç –≤–∞—Å –Ω–µ–≤–∫—É—Å–Ω–æ—Å—Ç—è–º–∏. –ï–≥–æ —Å–Ω–∞—Ä—è–¥—ã –∑–∞–º–µ–¥–ª—è—é—Ç ‚Äî –±–µ—Ä–µ–≥–∏—Ç–µ—Å—å!',
            seenIn:   ['murino']
        },
        {
            id:       'fog_runner',
            name:     '–§–æ–≥',
            icon:     'üå´Ô∏è',
            location: '–ú—É—Ä–∏–Ω–æ',
            locColor: '#888',
            desc:     '–ì–ª–∞–≤–Ω—ã–π –∂–∏—Ç–µ–ª—å –ú—É—Ä–∏–Ω–æ. –û–Ω —Ö–æ—á–µ—Ç –≤–∞—Å –ø–æ–π–º–∞—Ç—å ‚Äî –∏ –±–µ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –≥—Ä—è–∑–∏. –ù–µ –¥–∞–≤–∞–π—Ç–µ –µ–º—É –æ–∫—Ä—É–∂–∏—Ç—å –≤–∞—Å!',
            seenIn:   ['murino']
        },
        {
            id:       'pavuk',
            name:     '–ü–∞–≤—É–∫',
            icon:     'üï∑Ô∏è',
            location: '–ú–æ–ª–æ—á–Ω–æ–µ',
            locColor: '#90EE90',
            desc:     '–ú–∞–ª–µ–Ω—å–∫–∏–µ –ø–∞—É–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –±—ã—Å—Ç—Ä–æ –±–µ–≥–∞—é—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º. –û–Ω–∏ —à—É—Å—Ç—Ä—ã–µ, –Ω–æ –Ω–µ –æ—á–µ–Ω—å –æ–ø–∞—Å–Ω—ã–µ ‚Äî –ø–æ–ø–æ–ª–Ω—è—é—Ç –ø–∞–≤—É–∫–æ—Å—Ç—å –º–µ–Ω—å—à–µ —á–µ–º –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏.',
            seenIn:   ['molochnoe']
        },
        {
            id:       'big_pavuk',
            name:     '–ë–æ–ª—å—à–æ–π –ø–∞–≤—É–∫',
            icon:     'üï∏Ô∏è',
            location: '–ú–æ–ª–æ—á–Ω–æ–µ',
            locColor: '#228B22',
            desc:     '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫ –∫–æ—Ç–æ—Ä—ã–π —Å—Ç—Ä–µ–ª—è–µ—Ç –ø–∞—É—Ç–∏–Ω–æ–π. –•–æ—Ç—å –∏ –¥–≤–∏–∂–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ, –µ–≥–æ —Å–Ω–∞—Ä—è–¥—ã –æ–ø–∞—Å–Ω—ã ‚Äî –Ω–µ –¥–∞–π—Ç–µ —Å–µ–±—è –æ–ø—É—Ç–∞—Ç—å!',
            seenIn:   ['molochnoe']
        }
    ];

    // –°–ø–∏—Å–æ–∫ –≤—Å—Ç—Ä–µ—á–µ–Ω–Ω—ã—Ö –≤—Ä–∞–≥–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage
    let seenEnemies = JSON.parse(localStorage.getItem('seenEnemies') || '[]');

    function markEnemySeen(typeId) {
        if (!seenEnemies.includes(typeId)) {
            seenEnemies.push(typeId);
            localStorage.setItem('seenEnemies', JSON.stringify(seenEnemies));
        }
    }

    let _almanacFrom = 'start';

    function openAlmanac(from) {
        _almanacFrom = from || 'start';
        ['startScreen','deathScreen','victoryScreen','shopScreen','chestScreen'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        renderAlmanac();
        document.getElementById('almanacScreen').style.display = 'flex';
    }

    function closeAlmanac() {
        document.getElementById('almanacScreen').style.display = 'none';
        if (_almanacFrom === 'death')        document.getElementById('deathScreen').style.display   = 'flex';
        else if (_almanacFrom === 'victory') document.getElementById('victoryScreen').style.display = 'flex';
        else                                 document.getElementById('startScreen').style.display   = 'flex';
    }

    // ===================== –ú–ï–õ–°–¢–†–û–ô –ü–ê–°–° –§–£–ù–ö–¶–ò–ò =====================
    let _passFrom = 'start';

    function openPass(from) {
        _passFrom = from || 'start';
        ['startScreen','deathScreen','victoryScreen','shopScreen','chestScreen'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        renderPass();
        document.getElementById('passScreen').style.display = 'flex';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫–∏
        setTimeout(() => {
            resetPassScroll();
            updatePassArrows();
        }, 100);
    }

    function closePass() {
        document.getElementById('passScreen').style.display = 'none';
        if (_passFrom === 'death')        document.getElementById('deathScreen').style.display   = 'flex';
        else if (_passFrom === 'victory') document.getElementById('victoryScreen').style.display = 'flex';
        else                              document.getElementById('startScreen').style.display   = 'flex';
    }

    function closePassToMenu() {
        document.getElementById('passScreen').style.display = 'none';
        document.getElementById('startScreen').style.display = 'flex';
    }

    function renderPass() {
        document.getElementById('passCurrentTier').textContent = passTier;

        const grid = document.getElementById('passGrid');
        grid.innerHTML = '';

        // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ —Ç–∏—Ä—ã –æ—Ç 1 –¥–æ 60
        for (let tier = 1; tier <= 60; tier++) {
            const reward = getPassTierReward(tier);
            if (!reward) continue;

            const isUnlocked = tier <= passTier;
            const isClaimed = passRewards.includes(tier);
            const tierCost = getPassTierCost(tier - 1); // —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Ç–∏—Ä–∞

            const card = document.createElement('div');
            card.style.cssText = 
                'background: ' + (isUnlocked && !isClaimed ? 'rgba(0,212,255,0.3)' : isUnlocked ? 'rgba(0,212,255,0.15)' : 'rgba(0,0,0,0.4)') + ';' +
                'border: 3px solid ' + (isUnlocked && !isClaimed ? '#FFD700' : isUnlocked ? '#00D4FF' : 'rgba(255,255,255,0.2)') + ';' +
                'border-radius: 15px; padding: 15px; text-align: center; position: relative;' +
                'opacity: ' + (isUnlocked ? '1' : '0.5') + ';' +
                (isUnlocked && !isClaimed ? 'cursor: pointer; transition: transform 0.2s; box-shadow: 0 0 20px rgba(255,215,0,0.5);' : '');

            const isKey = reward.type === 'key';
            
            // –î–µ–ª–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É
            if (isUnlocked && !isClaimed) {
                card.onclick = () => {
                    if (isKey) {
                        claimKeyReward(tier, reward.rarity);
                    } else {
                        claimChestReward(tier, reward.chest);
                    }
                };
                card.onmouseover = () => card.style.transform = 'scale(1.05)';
                card.onmouseout = () => card.style.transform = 'scale(1)';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∏—Ä–æ–≤
            let costHTML = '';
            if (!isUnlocked) {
                costHTML = '<div style="position:absolute;top:8px;right:8px;background:rgba(255,215,0,0.8);color:#000;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:bold;">üí∞ ' + tierCost.toLocaleString() + '</div>';
            }

            let statusHTML = '';
            if (isUnlocked && !isClaimed) {
                statusHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,215,0,0.95);color:#000;padding:10px 20px;border-radius:20px;font-size:14px;font-weight:bold;box-shadow:0 5px 15px rgba(0,0,0,0.5);animation:pulse 1.5s infinite;">–ó–ê–ë–ï–†–ò –ü–†–ò–ó!</div>';
            } else if (isClaimed) {
                statusHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,255,0,0.8);color:#fff;padding:8px 16px;border-radius:15px;font-size:14px;font-weight:bold;">‚úì –ü–û–õ–£–ß–ï–ù–û</div>';
            } else if (!isUnlocked) {
                statusHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:#888;padding:8px 16px;border-radius:15px;font-size:14px;font-weight:bold;">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>';
            }

            card.innerHTML =
                '<div style="position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.7);color:#FFD700;padding:4px 10px;border-radius:8px;font-size:12px;font-weight:bold;">–¢–∏—Ä ' + tier + '</div>' +
                costHTML +
                '<div style="font-size:64px;margin:15px 0 10px;' + (isClaimed ? 'opacity:0.3;' : '') + '">' + reward.emoji + '</div>' +
                '<div style="font-size:18px;font-weight:bold;color:' + (isKey ? '#FFD700' : '#00D4FF') + ';margin-bottom:5px;' + (isClaimed ? 'opacity:0.5;' : '') + '">' + reward.name + '</div>' +
                (isKey ? '<div style="font-size:13px;color:rgba(255,255,255,0.7);' + (isClaimed ? 'opacity:0.5;' : '') + '">–í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞<br>—Ä–µ–¥–∫–æ—Å—Ç–∏ "' + reward.rarity + '"</div>' : '') +
                statusHTML;

            grid.appendChild(card);
        }

        // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (passTier >= 60) {
            const finalCard = document.createElement('div');
            finalCard.style.cssText = 
                'grid-column: 1 / -1; background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,107,157,0.3));' +
                'border: 3px solid #FFD700; border-radius: 15px; padding: 30px; text-align: center;';
            finalCard.innerHTML = 
                '<h2 style="font-size:36px;color:#FFD700;margin-bottom:10px;">üéâ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú!</h2>' +
                '<div style="font-size:18px;color:white;">–¢—ã –ø—Ä–æ—à—ë–ª –≤–µ—Å—å –ú–µ–ª—Å—Ç—Ä–æ–π –ü–∞—Å—Å!</div>';
            grid.appendChild(finalCard);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫–∏ –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        setTimeout(updatePassArrows, 100);
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–∞—Å—Å–∞
    let passScrollOffset = 0;
    let passRowHeight = 0;

    function updatePassArrows() {
        const container = document.getElementById('passGridContainer');
        const grid = document.getElementById('passGrid');
        const arrowUp = document.getElementById('passArrowUp');
        const arrowDown = document.getElementById('passArrowDown');
        
        if (!container || !grid || !arrowUp || !arrowDown) return;
        
        const maxScroll = grid.scrollHeight - container.clientHeight;
        
        // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –≤–≤–µ—Ä—Ö –µ—Å–ª–∏ –≤ –Ω–∞—á–∞–ª–µ
        if (passScrollOffset <= 0) {
            arrowUp.classList.add('disabled');
            arrowUp.disabled = true;
        } else {
            arrowUp.classList.remove('disabled');
            arrowUp.disabled = false;
        }
        
        // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –≤–Ω–∏–∑ –µ—Å–ª–∏ –≤ –∫–æ–Ω—Ü–µ
        if (passScrollOffset >= maxScroll) {
            arrowDown.classList.add('disabled');
            arrowDown.disabled = true;
        } else {
            arrowDown.classList.remove('disabled');
            arrowDown.disabled = false;
        }
    }

    function scrollPassUp() {
        const container = document.getElementById('passGridContainer');
        const grid = document.getElementById('passGrid');
        if (!container || !grid) return;
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–∞ –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const scrollStep = container.clientHeight * 0.8;
        passScrollOffset = Math.max(0, passScrollOffset - scrollStep);
        
        grid.style.transform = `translateY(-${passScrollOffset}px)`;
        updatePassArrows();
    }

    function scrollPassDown() {
        const container = document.getElementById('passGridContainer');
        const grid = document.getElementById('passGrid');
        if (!container || !grid) return;
        
        const maxScroll = grid.scrollHeight - container.clientHeight;
        const scrollStep = container.clientHeight * 0.8;
        
        passScrollOffset = Math.min(maxScroll, passScrollOffset + scrollStep);
        
        grid.style.transform = `translateY(-${passScrollOffset}px)`;
        updatePassArrows();
    }

    function resetPassScroll() {
        passScrollOffset = 0;
        const grid = document.getElementById('passGrid');
        if (grid) {
            grid.style.transform = 'translateY(0)';
        }
        updatePassArrows();
    }

    function claimChestReward(tier, chestType) {
        // –ü–æ–º–µ—á–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É –∫–∞–∫ –ø–æ–ª—É—á–µ–Ω–Ω—É—é
        if (!passRewards.includes(tier)) {
            passRewards.push(tier);
            localStorage.setItem('passRewards', JSON.stringify(passRewards));
        }
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—É–Ω–¥—É–∫ —Å—Ä–∞–∑—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ
        chestState.active   = true;
        chestState.type     = chestType;
        chestState.rarity   = '–û–±—ã—á–Ω–æ—Å—Ç—å';
        chestState.tapsLeft = chestTypes[chestType].tapsNeeded;
        chestState.fromScreen = 'pass';

        updateChestOpenUI();

        document.getElementById('passScreen').style.display = 'none';
        document.getElementById('chestOpenOverlay').classList.add('active');

        stopBubbleAnim();
        animateBubble();
    }

    function claimKeyReward(tier, rarity) {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        document.getElementById('passScreen').style.display = 'none';
        openKeySelect(tier, rarity);
    }

    let _currentKeyTier = 0;
    let _currentKeyRarity = '';

    function openKeySelect(tier, rarity) {
        _currentKeyTier = tier;
        _currentKeyRarity = rarity;
        
        const keyEmoji = rarity === '–û–±—ã—á–Ω–æ—Å—Ç—å' ? 'üîë' : rarity === '–†–µ–¥–∫–æ—Å—Ç—å' ? 'üóùÔ∏è' : 'üîê';
        document.getElementById('keySelectTitle').textContent = keyEmoji + ' ' + rarity.toUpperCase() + ' –ö–õ–Æ–ß';
        
        const grid = document.getElementById('keyCharGrid');
        grid.innerHTML = '';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω—É–∂–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—â—ë –Ω–µ –¥–æ—Å—Ç–∏–≥–ª–∏ –º–∞–∫—Å–∏–º—É–º–∞
        const availableChars = charsByRarity[rarity].filter(id => canCharDrop(id));

        if (availableChars.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:rgba(255,255,255,0.7);padding:20px;">–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ —ç—Ç–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –ú–ê–ö–°–ò–ú–£–ú!</div>';
        } else {
            availableChars.forEach(id => {
                const ch = characters[id];
                const level = getCharLevel(id);
                const isUnlocked = unlocked.includes(id);
                
                const card = document.createElement('div');
                card.style.cssText = 
                    'background: linear-gradient(135deg,rgba(0,212,255,0.2),rgba(255,107,157,0.2));' +
                    'border: 3px solid ' + ch.color + ';' +
                    'border-radius: 15px; padding: 12px; text-align: center; cursor: pointer;' +
                    'transition: transform 0.2s; position: relative;';
                card.onmouseover = () => card.style.transform = 'scale(1.05)';
                card.onmouseout = () => card.style.transform = 'scale(1)';
                card.onclick = () => selectCharWithKey(id);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —É—Ä–æ–≤–Ω—è –µ—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç
                let levelBadge = '';
                if (isUnlocked) {
                    levelBadge = '<div style="position:absolute;top:5px;right:5px;background:rgba(255,215,0,0.9);color:#000;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:bold;">' + level + '/3</div>';
                }

                card.innerHTML =
                    levelBadge +
                    '<div style="font-size:48px;margin:8px 0;">' + charEmoji[id] + '</div>' +
                    '<div style="font-size:16px;font-weight:bold;color:' + ch.color + ';">' + ch.name + '</div>' +
                    (isUnlocked ? (function() {
                        const lvl = level;
                        const maxLvl = 3;
                        const pct = Math.round((lvl / maxLvl) * 100);
                        const barColor = lvl >= maxLvl ? '#FFD700' : '#00D4FF';
                        return '<div style="margin:6px 4px 2px;">' +
                            '<div style="display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,0.6);margin-bottom:3px;">' +
                                '<span>–ü—Ä–æ–∫–∞—á–∫–∞</span>' +
                                '<span style="color:' + barColor + ';font-weight:bold;">' + lvl + ' / ' + maxLvl + '</span>' +
                            '</div>' +
                            '<div style="background:rgba(255,255,255,0.15);border-radius:5px;height:7px;overflow:hidden;">' +
                                '<div style="width:' + pct + '%;height:100%;background:' + barColor + ';border-radius:5px;box-shadow:0 0 5px ' + barColor + ';"></div>' +
                            '</div>' +
                        '</div>';
                    })() : '') +
                    (isUnlocked ? '<div style="font-size:11px;color:#FFD700;margin-top:5px;">‚¨ÜÔ∏è –£–õ–£–ß–®–ò–¢–¨</div>' : '<div style="font-size:11px;color:#4FC3F7;margin-top:5px;">üÜï –û–¢–ö–†–´–¢–¨</div>');

                grid.appendChild(card);
            });
        }

        document.getElementById('keySelectOverlay').style.display = 'flex';
    }

    function closeKeySelect() {
        document.getElementById('keySelectOverlay').style.display = 'none';
        if (_currentKeyTier === -99) {
            // –û—Ç–∫—Ä—ã—Ç–æ –∏–∑ —Å—É–Ω–¥—É–∫–∞ –ö–æ—Ä–æ–Ω–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Å—É–Ω–¥—É–∫–∏
            openChests(chestState.fromScreen || 'start');
        } else {
            openPass(_passFrom);
        }
    }

    function selectCharWithKey(charId) {
        const oldLevel = getCharLevel(charId);
        const newLevel = upgradeChar(charId);
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
        if (!unlocked.includes(charId)) {
            unlocked.push(charId);
            localStorage.setItem('unlocked', JSON.stringify(unlocked));
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è
        let message = '';
        if (newLevel === 1 && oldLevel === 0) {
            message = 'üéâ ' + characters[charId].name + ' –ø–æ–ª—É—á–µ–Ω –ø–æ –∫–ª—é—á—É!';
        } else if (newLevel === 2) {
            message = '‚¨ÜÔ∏è ' + characters[charId].name + ' —É–ª—É—á—à–µ–Ω! (1/2 –¥–æ –ú–ê–ö–°–ò–ú–£–ú)';
        } else if (newLevel === 3) {
            message = 'üèÜ ' + characters[charId].name + ' –¥–æ—Å—Ç–∏–≥ –ú–ê–ö–°–ò–ú–£–ú! +20% –∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º!';
        }
        
        showMessage(message, 3000);
        
        // –ü–æ–º–µ—á–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É –∫–∞–∫ –ø–æ–ª—É—á–µ–Ω–Ω—É—é
        if (!passRewards.includes(_currentKeyTier)) {
            passRewards.push(_currentKeyTier);
            localStorage.setItem('passRewards', JSON.stringify(passRewards));
        }

        closeKeySelect();
    }

    function renderAlmanac() {
        const list = document.getElementById('almanacList');
        list.innerHTML = '';

        enemyLore.forEach(enemy => {
            const isSeen   = seenEnemies.includes(enemy.id);
            const isMurino = enemy.seenIn.includes('murino') && !enemy.seenIn.includes('mytishchi');
            const isLocked = isMurino && !murinoUnlocked && !isSeen;

            const entry = document.createElement('div');
            entry.className = 'almanac-entry' + (isLocked ? ' locked' : '');
            entry.style.borderLeftColor = isSeen ? enemy.locColor : '#555';

            if (isLocked) {
                entry.innerHTML =
                    '<div class="almanac-lock-badge">üîí –ù–µ –≤—Å—Ç—Ä–µ—á–µ–Ω</div>' +
                    '<div class="almanac-entry-header">' +
                        '<div class="almanac-icon" style="filter:grayscale(1);">‚ùì</div>' +
                        '<div>' +
                            '<div class="almanac-name" style="color:#777;">???</div>' +
                            '<span class="almanac-location" style="background:rgba(139,0,139,0.4);color:#aaa;">üå´Ô∏è –ú—É—Ä–∏–Ω–æ</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="almanac-desc" style="color:#555;">–ü–æ–±–µ–¥–∏ –≤ –ú—É—Ä–∏–Ω–æ —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –æ–± —ç—Ç–æ–º –≤—Ä–∞–≥–µ.</div>';
            } else if (!isSeen) {
                entry.innerHTML =
                    '<div class="almanac-lock-badge">üëÅÔ∏è –ù–µ –≤—Å—Ç—Ä–µ—á–µ–Ω</div>' +
                    '<div class="almanac-entry-header">' +
                        '<div class="almanac-icon" style="filter:grayscale(0.5);">' + enemy.icon + '</div>' +
                        '<div>' +
                            '<div class="almanac-name" style="color:#aaa;">' + enemy.name + '</div>' +
                            '<span class="almanac-location" style="background:rgba(255,255,255,0.1);color:#888;">üìç ' + enemy.location + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="almanac-desc" style="color:#555;">–°—Ä–∞–∑–∏—Å—å —Å —ç—Ç–∏–º –≤—Ä–∞–≥–æ–º —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –æ –Ω—ë–º –±–æ–ª—å—à–µ.</div>';
            } else {
                entry.innerHTML =
                    '<div class="almanac-entry-header">' +
                        '<div class="almanac-icon">' + enemy.icon + '</div>' +
                        '<div>' +
                            '<div class="almanac-name">' + enemy.name + '</div>' +
                            '<span class="almanac-location" style="background:' + enemy.locColor + '33;color:' + enemy.locColor + ';">üìç ' + enemy.location + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="almanac-desc">' + enemy.desc + '</div>';
            }
            list.appendChild(entry);
        });

        // –ò—Ç–æ–≥–æ
        const total = enemyLore.length;
        const seen  = enemyLore.filter(e => seenEnemies.includes(e.id)).length;
        const summary = document.createElement('div');
        summary.style.cssText = 'text-align:center;margin-top:16px;color:rgba(255,255,255,0.5);font-size:13px;';
        summary.textContent = 'üìñ –í—Å—Ç—Ä–µ—á–µ–Ω–æ –≤—Ä–∞–≥–æ–≤: ' + seen + ' / ' + total;
        list.appendChild(summary);
    }

    let joystickActive = false;
    let joystickDir    = { x: 0, y: 0 };

    const joystick = document.getElementById('joystick');
    const stick    = document.getElementById('stick');
    const shootBtn = document.getElementById('shootBtn');

    joystick.addEventListener('touchstart', (e) => {
        e.preventDefault();
        joystickActive = true;
        updateJoystick(e.touches[0]);
    });
    joystick.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (joystickActive) updateJoystick(e.touches[0]);
    });
    joystick.addEventListener('touchend', () => {
        joystickActive = false;
        joystickDir    = { x: 0, y: 0 };
        stick.style.transform = 'translate(-50%, -50%)';
    });

    function updateJoystick(touch) {
        const rect = joystick.getBoundingClientRect();
        let x = touch.clientX - rect.left - rect.width / 2;
        let y = touch.clientY - rect.top - rect.height / 2;
        const maxDist = 35;
        const dist    = Math.sqrt(x * x + y * y);
        if (dist > maxDist) { x = (x / dist) * maxDist; y = (y / dist) * maxDist; }
        stick.style.transform = 'translate(calc(-50% + ' + x + 'px), calc(-50% + ' + y + 'px))';
        joystickDir.x = x / maxDist;
        joystickDir.y = y / maxDist;
    }

    shootBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleShoot(); });
    document.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key.toLowerCase() === 'e') handleShoot();
    });

    function handleShoot() {
        if (!gameRunning) return;
        const ch = characters[currentChar];

        // –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å ¬´–Ø —É–∂–µ –∫—Ä–∞—Å–Ω—ã–π¬ª ‚Äî –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ
        if (currentChar === 'yakrasny') {
            if (pushCooldown <= 0) {
                pushEnemies();
                pushCooldown = 300; // 5 —Å–µ–∫—É–Ω–¥
            } else {
                const secsLeft = Math.ceil(pushCooldown / 60);
                showMessage('‚è≥ –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞: ' + secsLeft + '—Å', 800);
            }
            return;
        }

        // –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å ¬´–ö—å–æ¬ª ‚Äî –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ 5 —Å–µ–∫—É–Ω–¥, –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ 15 —Å–µ–∫—É–Ω–¥
        if (currentChar === 'kyo') {
            if (invisibilityCooldown <= 0) {
                invisibleUntil = Date.now() + 5000; // 5 —Å–µ–∫—É–Ω–¥ –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç–∏
                invisibilityCooldown = 900; // 15 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞
                showMessage('üëª –ù–ï–í–ò–î–ò–ú–û–°–¢–¨! 5—Å', 2000);
            } else {
                const secsLeft = Math.ceil(invisibilityCooldown / 60);
                showMessage('‚è≥ –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞: ' + secsLeft + '—Å', 800);
            }
            return;
        }

        if (ch.shoot && shootCooldown <= 0) {
            shootAtEnemy();
            // –ë—ç–º –ë—ç–º ‚Äî –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ 5 —Å–µ–∫—É–Ω–¥, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî 2 —Å–µ–∫—É–Ω–¥—ã
            shootCooldown = (currentChar === 'bambam') ? 300 : 120;
        } else {
            checkInteractions();
        }
    }

    function pushEnemies() {
        const pushRadius = 200;
        const pushForce  = 180;
        let pushed = 0;
        enemies.forEach(e => {
            const dx   = e.x - player.x;
            const dy   = e.y - player.y;
            const dist = Math.hypot(dx, dy);
            if (dist < pushRadius && dist > 0) {
                e.x += (dx / dist) * pushForce;
                e.y += (dy / dist) * pushForce;
                // –ù–µ –≤—ã–ø—É—Å–∫–∞—Ç—å –∑–∞ —ç–∫—Ä–∞–Ω
                e.x = Math.max(0, Math.min(canvas.width,  e.x));
                e.y = Math.max(0, Math.min(canvas.height, e.y));
                pushed++;
            }
        });
        if (emperor) {
            const dx   = emperor.x - player.x;
            const dy   = emperor.y - player.y;
            const dist = Math.hypot(dx, dy);
            if (dist < pushRadius && dist > 0) {
                emperor.x += (dx / dist) * (pushForce * 0.5);
                emperor.y += (dy / dist) * (pushForce * 0.5);
            }
        }
        showMessage(pushed > 0 ? 'üü• –û–¢–ö–ò–ù–£–õ ' + pushed + ' –≤—Ä–∞–≥–æ–≤!' : 'üü• –ù–∏–∫–æ–≥–æ —Ä—è–¥–æ–º!', 1200);
    }

    function shootAtEnemy() {
        let nearest = null, nearestDist = Infinity;
        enemies.forEach(e => {
            const dist = Math.hypot(player.x - e.x, player.y - e.y);
            if (dist < nearestDist && dist < 300) { nearestDist = dist; nearest = e; }
        });
        if (nearest) {
            const ch = characters[currentChar];
            const angle = Math.atan2(nearest.y - player.y, nearest.x - player.x);

            if (ch.shootType === 'aoe') {
                // –ë—ç–º –ë—ç–º ‚Äî AOE —Å–Ω–∞—Ä—è–¥: –±–æ–ª—å—à–æ–π, –ª–µ—Ç–∏—Ç –∫ –±–ª–∏–∂–∞–π—à–µ–º—É –≤—Ä–∞–≥—É
                projectiles.push({
                    x: player.x, y: player.y,
                    vx: Math.cos(angle) * 4, vy: Math.sin(angle) * 4,
                    size: 18, color: '#FF8C00', friendly: true, life: 80,
                    shootType: 'aoe', aoeRadius: 80
                });
                showMessage('üí• –ë–≠–ú!', 800);
            } else if (ch.shootType === 'slow') {
                // –í–∫—É—Å–Ω–æ—Å—Ç—å ‚Äî –∑–∞–º–µ–¥–ª—è—é—â–∏–π —Å–Ω–∞—Ä—è–¥
                projectiles.push({
                    x: player.x, y: player.y,
                    vx: Math.cos(angle) * 4, vy: Math.sin(angle) * 4,
                    size: 10, color: '#FFB6C1', friendly: true, life: 60,
                    shootType: 'slow'
                });
                showMessage('üê∞ –í–´–°–¢–†–ï–õ!', 800);
            } else if (ch.shootType === 'web') {
                // –ü–∞–≤—É–∫ ‚Äî –ø–∞—É—Ç–∏–Ω–∞ –∫–æ—Ç–æ—Ä–∞—è –∑–∞–º–µ–¥–ª—è–µ—Ç
                projectiles.push({
                    x: player.x, y: player.y,
                    vx: Math.cos(angle) * 3.5, vy: Math.sin(angle) * 3.5,
                    size: 10, color: '#DDD', friendly: true, life: 60,
                    shootType: 'web'
                });
                showMessage('üï∑Ô∏è –ü–ê–£–¢–ò–ù–ê!', 800);
            } else if (ch.shootType === 'web_push') {
                // –®–ª—è–ø—É–∫ ‚Äî –ø–∞—É—Ç–∏–Ω–∞ –∫–æ—Ç–æ—Ä–∞—è –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–µ—Ç –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç
                projectiles.push({
                    x: player.x, y: player.y,
                    vx: Math.cos(angle) * 3.5, vy: Math.sin(angle) * 3.5,
                    size: 12, color: '#A0522D', friendly: true, life: 60,
                    shootType: 'web_push'
                });
                showMessage('üçÑ –ü–ê–£–¢–ò–ù–ê!', 800);
            } else if (ch.shootType === 'fog') {
                // –§–æ–≥ ‚Äî –¥—ã–º–æ–≤–æ–π —Å–Ω–∞—Ä—è–¥ –∫–æ—Ç–æ—Ä—ã–π —É–±–∏–≤–∞–µ—Ç –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç
                projectiles.push({
                    x: player.x, y: player.y,
                    vx: Math.cos(angle) * 3, vy: Math.sin(angle) * 3,
                    size: 14, color: '#888', friendly: true, life: 70,
                    shootType: 'fog'
                });
                showMessage('üå´Ô∏è –î–´–ú!', 800);
            } else {
                // –û–±—ã—á–Ω—ã–π —Å–Ω–∞—Ä—è–¥
                projectiles.push({
                    x: player.x, y: player.y,
                    vx: Math.cos(angle) * 4, vy: Math.sin(angle) * 4,
                    size: 10, color: player.color, friendly: true, life: 60,
                    shootType: 'normal'
                });
                showMessage('üí• –í–´–°–¢–†–ï–õ!', 800);
            }
        }
    }

    function checkInteractions() {
        if (currentLocation === 'mytishchi') {
            showers.forEach(s => {
                const dist = Math.hypot(player.x - s.x, player.y - s.y);
                if (dist < player.size + s.size && hazard > 0) {
                    hazard = 0;
                    showMessage('–Ø –ü–û–ú–´–õ–°–Ø! üöø', 2000);
                }
            });
        }
        if (currentLocation === 'mytishchi' && arthur && !arthur.used) {
            const dist = Math.hypot(player.x - arthur.x, player.y - arthur.y);
            if (dist < 40) {
                currency    += 1000;
                totalEarned += 1000;
                localStorage.setItem('totalEarned', totalEarned);
                arthur.used = true;
                showMessage('+1000 –¥—Ä—É–Ω–±–ª–µ–π! üëã', 2000);
                updateHUD();
            }
        }
    }

    // ===================== SPAWN =====================
    function spawnCoins() {
        const count = (isBossMode || isMurinoBossMode || isMolochnoeBo—Å—ÅMode) ? (isMurinoBossMode ? 30 : isMolochnoeBo—Å—ÅMode ? 25 : 20) : 25;
        for (let i = 0; i < count; i++) {
            coins.push({
                x: Math.random() * (canvas.width - 100) + 50,
                y: Math.random() * (canvas.height - 100) + 50,
                size: 12,
                value: (isBossMode || isMurinoBossMode || isMolochnoeBo—Å—ÅMode) ? 1 : (Math.floor(Math.random() * 400) + 100),
                color: isBossMode ? '#0FF' : isMurinoBossMode ? '#DA70D6' : isMolochnoeBo—Å—ÅMode ? '#0FF' : '#FFD700',
                angle: Math.random() * Math.PI * 2
            });
        }
    }

    function spawnEnemies() {
        if (isBossMode) {
            emperor = { x: canvas.width / 2, y: 100, size: 66, speed: 2.3,
                        color: '#00BFFF', hp: 1, bouncePhase: 0 };
            return;
        }
        if (isMurinoBossMode) {
            // The FOG ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—ã—á–Ω–æ–≥–æ —Ñ–æ–≥–∞ 2 + 40% = 2.8
            theFog = {
                x: canvas.width / 2, y: 80,
                size: 30,            // –∫–∞–∫ –æ–±—ã—á–Ω—ã–π fog_runner
                speed: 2.8,
                color: '#9B59B6',
                shootCooldown: 0,
                bouncePhase: 0
            };
            return;
        }
        if (isMolochnoeBo—Å—ÅMode) {
            // –¢—Ä–∞–º–≤–∞–π ‚Äî –±—ã—Å—Ç—Ä—ã–π –±–æ—Å—Å
            tramvai = {
                x: canvas.width / 2, y: 80,
                size: 40,
                speed: 3.85,  // +10% –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
                color: '#FFD700',
                bouncePhase: 0,
                direction: 1  // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–∞–Ω—Ç–æ–≥—Ä–∞—Ñ–∞
            };
            tramvaiSpawnTimer = 0;
            return;
        }
        if (currentLocation === 'mytishchi') {
            markEnemySeen('gryaznya');
            markEnemySeen('fog_shooter');
            for (let i = 0; i < 5; i++) enemies.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 25, speed: 1.5, color: '#8B7355', type: 'gryaznya',   damage: 5,  bouncePhase: Math.random() * Math.PI * 2 });
            for (let i = 0; i < 3; i++) enemies.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 30, speed: 0,   color: '#00BFFF', type: 'fog_shooter', damage: 8,  shootCooldown: 0 });
        } else if (currentLocation === 'molochnoe') {
            markEnemySeen('pavuk');
            markEnemySeen('big_pavuk');
            for (let i = 0; i < 8; i++) enemies.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 18, speed: 2.5, color: '#8B4513', type: 'pavuk', damage: 3, bouncePhase: Math.random() * Math.PI * 2 });
            for (let i = 0; i < 3; i++) enemies.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 35, speed: 1, color: '#654321', type: 'big_pavuk', damage: 10, shootCooldown: 0 });
        } else {
            markEnemySeen('pakost');
            markEnemySeen('fog_runner');
            for (let i = 0; i < 4; i++) enemies.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 28, speed: 0,   color: '#FFF',    type: 'pakost',      damage: 10, shootCooldown: 0 });
            for (let i = 0; i < 6; i++) enemies.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 25, speed: 2,   color: '#666',    type: 'fog_runner',  damage: 8,  bouncePhase: Math.random() * Math.PI * 2 });
        }
    }

    function spawnShowers() {
        if (currentLocation !== 'mytishchi') return;
        for (let i = 0; i < 3; i++)
            showers.push({ x: Math.random() * (canvas.width - 100) + 50, y: Math.random() * (canvas.height - 100) + 50, size: 30, color: '#C0E8FF' });
    }

    function spawnArthur() {
        if (currentLocation !== 'mytishchi') return;
        arthur = { x: Math.random() * (canvas.width - 100) + 50, y: Math.random() * (canvas.height - 100) + 50, size: 35, color: '#FF6B9D', used: false };
    }

    // ===================== UI =====================
    function showMessage(text, duration) {
        duration = duration || 3000;
        const msg = document.getElementById('message');
        msg.textContent = text;
        msg.classList.add('show');
        setTimeout(() => msg.classList.remove('show'), duration);
    }

    function updateHUD() {
        const hazardName    = currentLocation === 'mytishchi' ? '–ì—Ä—è–∑–Ω–æ—Å—Ç—å' : currentLocation === 'molochnoe' ? '–ü–∞–≤—É–∫–æ—Å—Ç—å' : '–§–æ–≥–æ—Å—Ç—å';
        const hazardPercent = (hazard / player.maxHazard) * 100;
        document.getElementById('currency').textContent =
            isBossMode        ? 'üíé ' + (20 - coins.length) + ' / 20  [–≤—Å–µ–≥–æ: ' + totalCrystals + ']'
            : isMurinoBossMode ? 'üíú ' + (30 - coins.length) + ' / 30  [–≤—Å–µ–≥–æ: ' + totalCrystals + ']'
            : isMolochnoeBo—Å—ÅMode ? 'üíé ' + (25 - coins.length) + ' / 25  [–≤—Å–µ–≥–æ: ' + totalCrystals + ']'
            : currentLocation === 'murino' ? 'üí∞ ' + currency.toLocaleString() + ' / 20 000'
            : currentLocation === 'molochnoe' ? 'üí∞ ' + currency.toLocaleString() + ' / 15 000'
            : 'üí∞ ' + currency.toLocaleString();
        document.getElementById('hazard').textContent  = hazardName + ': ' + hazardPercent.toFixed(0) + '%';
        document.getElementById('hazard').style.background =
            currentLocation === 'mytishchi'
                ? 'linear-gradient(90deg, rgba(139,69,19,0.8) ' + hazardPercent + '%, rgba(0,0,0,0.8) ' + hazardPercent + '%)'
                : currentLocation === 'molochnoe'
                ? 'linear-gradient(90deg, rgba(144,238,144,0.8) ' + hazardPercent + '%, rgba(0,0,0,0.8) ' + hazardPercent + '%)'
                : 'linear-gradient(90deg, rgba(100,100,100,0.8) ' + hazardPercent + '%, rgba(0,0,0,0.8) ' + hazardPercent + '%)';
        document.getElementById('location').textContent = currentLocation === 'mytishchi' ? 'üìç –ú—ã—Ç–∏—â–∏' : currentLocation === 'molochnoe' ? 'üìç –ú–æ–ª–æ—á–Ω–æ–µ' : 'üìç –ú—É—Ä–∏–Ω–æ';
    }

    // ===================== SCREEN NAV =====================
    function openLocationSelect() {
        document.getElementById('startScreen').style.display   = 'none';
        document.getElementById('locationScreen').style.display = 'flex';
        if (murinoUnlocked) {
            document.getElementById('murinoBtn').disabled = false;
            document.getElementById('murinoBtn').innerHTML = 'üå´Ô∏è –ú–£–†–ò–ù–û<br><small>–§–æ–≥–æ—Å—Ç—å ‚Ä¢ –ü–∞–∫–æ—Å—Ç—å –∏ –§–æ–≥–∏</small>';
        }
        if (molochnoeUnlocked) {
            document.getElementById('molochnoeBtn').disabled = false;
            document.getElementById('molochnoeBtn').innerHTML = 'üï∏Ô∏è –ú–û–õ–û–ß–ù–û–ï<br><small>–ü–∞–≤—É–∫–æ—Å—Ç—å ‚Ä¢ –ü–∞–≤—É–∫–∏ –∏ –ü–∞—É—Ç–∏–Ω–∞</small>';
        }
    }
    function closeLocationSelect() {
        document.getElementById('locationScreen').style.display = 'none';
        document.getElementById('startScreen').style.display   = 'flex';
    }
    function openLocationFromGame() {
        document.getElementById('deathScreen').style.display   = 'none';
        document.getElementById('victoryScreen').style.display = 'none';
        document.getElementById('locationScreen').style.display = 'flex';
    }
    function openShop() {
        document.getElementById('startScreen').style.display = 'none';
        renderShop();
    }
    function openShopFromGame() {
        document.getElementById('deathScreen').style.display   = 'none';
        document.getElementById('victoryScreen').style.display = 'none';
        renderShop();
    }
    function closeShop() {
        document.getElementById('shopScreen').style.display  = 'none';
        document.getElementById('startScreen').style.display = 'flex';
    }

    // ===================== –ú–ê–ì–ê–ó–ò–ù =====================
    function renderShop() {
        document.getElementById('shopScreen').style.display  = 'flex';
        document.getElementById('shopBalance').textContent   = totalEarned.toLocaleString();
        const grid = document.getElementById('charGrid');
        grid.innerHTML = '';
        // –ë–æ–π —Å –∏–º–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –¥–æ—Å—Ç—É–ø–µ–Ω –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç—ã –ª—é–±—ã–µ 5 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        const bossAvailable = unlocked.length >= 5;
        document.getElementById('bossBtn').style.display = bossAvailable ? 'block' : 'none';
        // –ë–æ–π —Å The FOG –¥–æ—Å—Ç—É–ø–µ–Ω –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç—ã –ª—é–±—ã–µ 10 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ò –ú—É—Ä–∏–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
        const murinoBossAvailable = murinoUnlocked && unlocked.length >= 10;
        document.getElementById('murinoBossBtn').style.display = murinoBossAvailable ? 'block' : 'none';
        // –ë–æ–π —Å –¢—Ä–∞–º–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–µ–Ω –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç—ã –ª—é–±—ã–µ 15 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ò –ú–æ–ª–æ—á–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–æ
        const molochnoeBossAvailable = molochnoeUnlocked && unlocked.length >= 15;
        document.getElementById('molochnoeBossBtn').style.display = molochnoeBossAvailable ? 'block' : 'none';

        Object.keys(characters).forEach(id => {
            const ch = characters[id];
            const isUnlocked = unlocked.includes(id);
            const isSelected = currentChar === id;
            const rColor     = rarityColors[ch.rarity] || '#FFF';
            const level = getCharLevel(id);
            const stats = getCharStats(id);

            const card = document.createElement('div');
            card.style.cssText =
                'position:relative;' +
                'background:' + (isSelected ? 'linear-gradient(135deg,rgba(255,215,0,0.3),rgba(255,107,157,0.3))' : isUnlocked ? 'linear-gradient(135deg,rgba(0,212,255,0.2),rgba(255,107,157,0.2))' : 'rgba(0,0,0,0.3)') + ';' +
                'border:3px solid ' + (isSelected ? '#FFD700' : isUnlocked ? ch.color : 'rgba(255,255,255,0.3)') + ';' +
                'border-radius:15px;padding:12px;text-align:center;opacity:' + (isUnlocked ? 1 : 0.6) + ';';

            let btnHTML = '';
            // murinoOnly –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø–æ–∫–∞ –ú—É—Ä–∏–Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ
            const isLockedByMurino = ch.murinoOnly && !murinoUnlocked && !isUnlocked;
            const isLockedByMolochnoe = ch.molochnoeOnly && !molochnoeUnlocked && !isUnlocked;
            if (isLockedByMurino) {
                btnHTML = '<button disabled style="width:100%;margin-top:8px;padding:8px;border-radius:20px;background:#333;border:2px solid #555;color:#888;font-weight:bold;">üå´Ô∏è –û—Ç–∫—Ä–æ–π –ú—É—Ä–∏–Ω–æ</button>';
            } else if (isLockedByMolochnoe) {
                btnHTML = '<button disabled style="width:100%;margin-top:8px;padding:8px;border-radius:20px;background:#333;border:2px solid #555;color:#888;font-weight:bold;">üï∏Ô∏è –û—Ç–∫—Ä–æ–π –ú–æ–ª–æ—á–Ω–æ–µ</button>';
            } else if (!isUnlocked && ch.cost > 0) {
                const canBuy = totalEarned >= ch.cost;
                btnHTML = '<button onclick="buyChar(\'' + id + '\')"' + (!canBuy ? ' disabled' : '') +
                    ' style="width:100%;margin-top:8px;padding:8px;border-radius:20px;background:' +
                    (canBuy ? 'linear-gradient(135deg,#FFD700,#FFA500)' : '#666') +
                    ';border:2px solid white;color:white;font-weight:bold;">' +
                    (canBuy ? 'üí∞ –ö–£–ü–ò–¢–¨' : 'üîí ' + ch.cost.toLocaleString()) + '</button>';
            } else if (isSelected) {
                btnHTML = '<button onclick="startGameQuick()" style="width:100%;margin-top:8px;padding:8px;border-radius:20px;background:linear-gradient(135deg,#FF6B9D,#FF1493);border:2px solid white;color:white;font-weight:bold;">‚öîÔ∏è –í –ë–û–ô!</button>';
            } else if (isUnlocked) {
                btnHTML = '<button onclick="selectChar(\'' + id + '\')" style="width:100%;margin-top:8px;padding:8px;border-radius:20px;background:linear-gradient(135deg,#00FF88,#00CC66);border:2px solid white;color:white;font-weight:bold;">‚úì –í–´–ë–†–ê–¢–¨</button>';
            }
            
            // –ë–µ–π–¥–∂ —É—Ä–æ–≤–Ω—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
            let levelBadge = '';
            if (isUnlocked && level >= 3) {
                levelBadge = '<div style="position:absolute;top:5px;left:5px;background:linear-gradient(135deg,#FFD700,#FFA500);color:#000;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:bold;box-shadow:0 2px 8px rgba(255,215,0,0.6);">üèÜ –ú–ê–ö–°–ò–ú–£–ú</div>';
            } else if (isUnlocked && level > 0) {
                levelBadge = '<div style="position:absolute;top:5px;left:5px;background:rgba(255,215,0,0.8);color:#000;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:bold;">' + level + '/3</div>';
            }

            card.innerHTML =
                levelBadge +
                (isSelected ? '<div style="position:absolute;top:5px;right:5px;background:#FFD700;color:black;padding:2px 8px;border-radius:8px;font-size:11px;font-weight:bold;">‚úì –í–´–ë–†–ê–ù</div>' : '') +
                (!isUnlocked ? '<div style="position:absolute;top:5px;right:5px;background:#F00;color:white;padding:2px 8px;border-radius:8px;font-size:11px;font-weight:bold;">üîí –ó–ê–ö–†–´–¢</div>' : '') +
                (ch.murinoOnly && !isUnlocked && !levelBadge ? '<div style="position:absolute;top:5px;left:5px;background:#8B008B;color:white;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:bold;">üå´Ô∏è –ú–£–†–ò–ù–û</div>' : '') +
                (ch.molochnoeOnly && !isUnlocked && !levelBadge ? '<div style="position:absolute;top:5px;left:5px;background:#228B22;color:white;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:bold;">üï∏Ô∏è –ú–û–õ–û–ß–ù–û–ï</div>' : '') +
                '<div style="font-size:40px;margin:8px 0;">' + charEmoji[id] + '</div>' +
                '<div style="font-size:18px;font-weight:bold;color:' + ch.color + ';margin:5px 0;">' + ch.name + '</div>' +
                '<div style="font-size:11px;font-weight:bold;color:' + rColor + ';margin:3px 0;letter-spacing:0.5px;text-transform:uppercase;">‚ú¶ ' + ch.rarity + ' ‚ú¶</div>' +
                '<div style="font-size:12px;color:rgba(255,255,255,0.8);">–°–∫–æ—Ä–æ—Å—Ç—å: ' + (stats.speed * 100).toFixed(0) + '%<br>–ñ–∏–≤—É—á–µ—Å—Ç—å: ' + (stats.hazard * 100).toFixed(0) + '%' +
                (ch.shoot ? '<br>üî´ –£–º–µ–µ—Ç —Å—Ç—Ä–µ–ª—è—Ç—å' : '') +
                (ch.special === 'push' ? '<br>üí® –û—Ç—Ç–∞–ª–∫–∏–≤–∞–µ—Ç –≤—Ä–∞–≥–æ–≤ (E)' : '') +
                (ch.special === 'invisibility' ? '<br>üëª –ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å 5—Å (E)' : '') +
                (stats.isMaxLevel ? '<br><span style="color:#FFD700;font-weight:bold;">‚ö° +20% –∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º</span>' : '') +
                '</div>' +
                (isUnlocked ? (function() {
                    const lvl = level;
                    const maxLvl = 3;
                    const pct = Math.round((lvl / maxLvl) * 100);
                    const barColor = lvl >= maxLvl ? '#FFD700' : '#00D4FF';
                    const labelText = lvl >= maxLvl ? 'üèÜ –ú–ê–ö–°–ò–ú–£–ú' : ('üì¶ –ï—â—ë ' + (maxLvl - lvl) + ' –≤—ã–±–∏—Ç—å –¥–æ –ú–ê–ö–°');
                    return '<div style="margin:7px 0 2px;text-align:left;">' +
                        '<div style="display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,0.6);margin-bottom:3px;">' +
                            '<span>–ü—Ä–æ–∫–∞—á–∫–∞</span>' +
                            '<span style="color:' + barColor + ';font-weight:bold;">' + lvl + ' / ' + maxLvl + '</span>' +
                        '</div>' +
                        '<div style="background:rgba(255,255,255,0.15);border-radius:6px;height:8px;overflow:hidden;">' +
                            '<div style="width:' + pct + '%;height:100%;background:' + barColor + ';border-radius:6px;transition:width 0.4s;box-shadow:0 0 6px ' + barColor + ';"></div>' +
                        '</div>' +
                        '<div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:3px;text-align:center;">' + labelText + '</div>' +
                    '</div>';
                })() : '') +
                (ch.cost > 0 && isUnlocked ? '<div style="color:#FFD700;font-size:14px;margin:5px 0;">‚úì –ö–£–ü–õ–ï–ù</div>' : '') +
                btnHTML;

            grid.appendChild(card);
        });
    }

    function buyChar(id) {
        const ch = characters[id];
        if (totalEarned >= ch.cost && !unlocked.includes(id)) {
            unlocked.push(id);
            // –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ø–µ—Ä—Å–æ–Ω–∞–∂ –ø–æ–ª—É—á–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å 1
            charLevels[id] = 1;
            localStorage.setItem('charLevels', JSON.stringify(charLevels));
            localStorage.setItem('unlocked', JSON.stringify(unlocked));
            updatePassProgress(ch.cost); // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–∞—Å—Å–∞
            showMessage('üéâ ' + ch.name + ' –∫—É–ø–ª–µ–Ω!', 2000);
            renderShop();
        }
    }

    function selectChar(id) {
        currentChar = id;
        localStorage.setItem('currentChar', id);
        const stats = getCharStats(id);
        player.color      = characters[id].color;
        player.speed      = 3 * stats.speed;
        player.maxHazard  = 100 * stats.hazard;
        renderShop();
        document.getElementById('charName').textContent  = characters[id].name;
        document.getElementById('charName').style.color  = ch.color;
    }

    function startGameQuick() { closeShop(); openLocationSelect(); }

    // ===================== GAME START =====================
    function startGame(location) { currentLocation = location; isBossMode = false; isMurinoBossMode = false; isMolochnoeBo—Å—ÅMode = false; initGame(); }
    function startBoss()         { currentLocation = 'mytishchi'; isBossMode = true; isMurinoBossMode = false; isMolochnoeBo—Å—ÅMode = false; initGame(); }
    function startMurinoBoss()   { currentLocation = 'murino';    isBossMode = false; isMurinoBossMode = true; isMolochnoeBo—Å—ÅMode = false; initGame(); }
    function startMolochnoeBoss() { currentLocation = 'molochnoe'; isBossMode = false; isMurinoBossMode = false; isMolochnoeBo—Å—ÅMode = true; initGame(); }

    function initGame() {
        ['startScreen','locationScreen','shopScreen'].forEach(id =>
            document.getElementById(id).style.display = 'none');

        const stats = getCharStats(currentChar);
        const ch = characters[currentChar];
        player.x         = canvas.width / 2;
        player.y         = canvas.height / 2;
        player.color     = ch.color;
        player.speed     = 3 * stats.speed;
        player.maxHazard = 100 * stats.hazard;

        currency = 0; hazard = 0;
        coins = []; enemies = []; projectiles = []; showers = [];
        arthur = null; emperor = null; theFog = null; tramvai = null;
        shootCooldown = 0; aoeExplosions = []; enemySpawnTimer = 0; pushCooldown = 0; tramvaiSpawnTimer = 0;
        invisibilityCooldown = 0; invisibleUntil = 0;

        spawnCoins(); spawnEnemies();
        if (!isBossMode && !isMolochnoeBo—Å—ÅMode) { spawnShowers(); if (currentLocation === 'mytishchi') spawnArthur(); }

        gameRunning = true;
        updateHUD();
        startGameMusic();
        gameLoop();
    }

    function restartGame() {
        document.getElementById('deathScreen').style.display   = 'none';
        document.getElementById('victoryScreen').style.display = 'none';
        initGame();
    }

    // ===================== GAME LOOP =====================
    function gameLoop() {
        if (!gameRunning) return;

        ctx.fillStyle = currentLocation === 'mytishchi' ? '#E0F0FF' : currentLocation === 'molochnoe' ? '#90EE90' : '#3A3A3A';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const speedMult = Date.now() < playerSlowUntil ? 0.7 : 1;
        player.vx = joystickDir.x * player.speed * speedMult;
        player.vy = joystickDir.y * player.speed * speedMult;
        player.x += player.vx;
        player.y += player.vy;
        player.x = Math.max(player.size, Math.min(canvas.width  - player.size, player.x));
        player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));

        hazard += hazardRate / 60;
        hazard  = Math.min(player.maxHazard, hazard);
        if (hazard >= player.maxHazard) { die(); return; }

        if (shootCooldown > 0) shootCooldown--;
        if (pushCooldown  > 0) pushCooldown--;
        if (invisibilityCooldown > 0) invisibilityCooldown--;

        // ‚îÄ‚îÄ –°–ø–∞–≤–Ω –Ω–æ–≤—ã—Ö –≤—Ä–∞–≥–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (300 –∫–∞–¥—Ä–æ–≤ @ 60fps) ‚îÄ‚îÄ
        if (!isBossMode && !isMurinoBossMode && !isMolochnoeBo—Å—ÅMode) {
            enemySpawnTimer++;
            if (enemySpawnTimer >= 300) {
                enemySpawnTimer = 0;
                if (currentLocation === 'mytishchi') {
                    enemies.push({
                        x: Math.random() < 0.5 ? -30 : canvas.width + 30,
                        y: Math.random() * canvas.height,
                        size: 25, speed: 1.5, color: '#8B7355',
                        type: 'gryaznya', damage: 5,
                        bouncePhase: Math.random() * Math.PI * 2
                    });
                } else if (currentLocation === 'murino') {
                    enemies.push({
                        x: Math.random() < 0.5 ? -30 : canvas.width + 30,
                        y: Math.random() * canvas.height,
                        size: 25, speed: 2, color: '#666',
                        type: 'fog_runner', damage: 8,
                        bouncePhase: Math.random() * Math.PI * 2
                    });
                } else if (currentLocation === 'molochnoe') {
                    enemies.push({
                        x: Math.random() < 0.5 ? -30 : canvas.width + 30,
                        y: Math.random() * canvas.height,
                        size: 18, speed: 2.5, color: '#8B4513',
                        type: 'pavuk', damage: 3,
                        bouncePhase: Math.random() * Math.PI * 2
                    });
                }
            }
        }

        updateCoins(); updateEnemies(); updateProjectiles();

        drawShowers(); drawCoins(); drawEnemies(); drawProjectiles(); drawAoeExplosions();
        if (arthur && !arthur.used) drawArthur();
        if (emperor) drawEmperor();
        if (theFog)  drawTheFog();
        if (tramvai) drawTramvai();
        drawPlayer();
        updateHUD();

        if (isBossMode && coins.length === 0) { bossVictory(); return; }
        else if (isMurinoBossMode && coins.length === 0) { murinoBossVictory(); return; }
        else if (isMolochnoeBo—Å—ÅMode && coins.length === 0) { molochnoeBo—Å—ÅVictory(); return; }
        else if (!isBossMode && !isMurinoBossMode && !isMolochnoeBo—Å—ÅMode && currentLocation === 'mytishchi' && currency >= 10000) { victory(); return; }
        else if (!isBossMode && !isMurinoBossMode && !isMolochnoeBo—Å—ÅMode && currentLocation === 'murino' && currency >= 20000) { murinoVictory(); return; }
        else if (!isBossMode && !isMurinoBossMode && !isMolochnoeBo—Å—ÅMode && currentLocation === 'molochnoe' && currency >= 15000) { molochnoeVictory(); return; }

        requestAnimationFrame(gameLoop);
    }

    // ===================== UPDATE =====================
    function updateCoins() {
        coins.forEach((c, i) => {
            c.angle += 0.05;
            const dist = Math.hypot(player.x - c.x, player.y - c.y);
            if (dist < player.size + c.size) {
                if (isBossMode || isMurinoBossMode || isMolochnoeBo—Å—ÅMode) {
                    coins.splice(i, 1);
                    totalCrystals++;
                    localStorage.setItem('totalCrystals', totalCrystals);
                } else {
                    currency    += c.value;
                    totalEarned += c.value;
                    localStorage.setItem('totalEarned', totalEarned);
                    coins.splice(i, 1);
                    if (coins.length < 20) coins.push({
                        x: Math.random() * (canvas.width - 100) + 50,
                        y: Math.random() * (canvas.height - 100) + 50,
                        size: 12, value: Math.floor(Math.random() * 400) + 100,
                        color: '#FFD700', angle: Math.random() * Math.PI * 2
                    });
                }
            }
        });
    }

    function updateEnemies() {
        const isInvisible = Date.now() < invisibleUntil;
        
        // –¢—Ä–∞–º–≤–∞–π –±–æ—Å—Å ‚Äî –±—ã—Å—Ç—Ä–æ –≥–æ–Ω–∏—Ç—Å—è –∑–∞ –∏–≥—Ä–æ–∫–æ–º –∏ —Å–ø–∞–≤–Ω–∏—Ç –ø–∞–≤—É–∫–æ–≤ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        if (tramvai) {
            if (!isInvisible) {
                const dx = player.x - tramvai.x, dy = player.y - tramvai.y;
                const dist = Math.hypot(dx, dy);
                tramvai.x += (dx / dist) * tramvai.speed;
                tramvai.y += (dy / dist) * tramvai.speed;
                tramvai.bouncePhase += 0.1;
                // –ö–æ–Ω—Ç–∞–∫—Ç —Å –∏–≥—Ä–æ–∫–æ–º
                if (dist < player.size + tramvai.size) {
                    hazard += 25;
                    tramvai.x -= (dx / dist) * 35;
                    tramvai.y -= (dy / dist) * 35;
                    showMessage('üöä –¢–†–ê–ú–í–ê–ô! +25%', 1500);
                }
            }
            // –°–ø–∞–≤–Ω –ø–∞–≤—É–∫–æ–≤ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã (180 –∫–∞–¥—Ä–æ–≤)
            tramvaiSpawnTimer++;
            if (tramvaiSpawnTimer >= 180) {
                tramvaiSpawnTimer = 0;
                // –°–ø–∞–≤–Ω–∏–º –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ–≥–æ –ø–∞—É–∫–∞ —Å –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ ‚Äî —Å—Ç–æ–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ, –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è
                const spawnSide = Math.random();
                let sx, sy;
                if (spawnSide < 0.25) { sx = -30; sy = Math.random() * canvas.height; }
                else if (spawnSide < 0.5) { sx = canvas.width + 30; sy = Math.random() * canvas.height; }
                else if (spawnSide < 0.75) { sx = Math.random() * canvas.width; sy = -30; }
                else { sx = Math.random() * canvas.width; sy = canvas.height + 30; }
                enemies.push({
                    x: sx, y: sy,
                    size: 22,
                    speed: 2.8 + Math.random() * 0.8,  // –±—ã—Å—Ç—Ä–æ –±–µ–≥–∞–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
                    color: '#5C2A00',
                    type: 'pavuk',
                    damage: 4,
                    bouncePhase: Math.random() * Math.PI * 2,
                    legPhase: 0
                });
            }
            // –ù–ï return ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å enemies (–ø–∞—É–∫–æ–≤) –Ω–∏–∂–µ
        }
        
        // The FOG boss ‚Äî –≥–æ–Ω–∏—Ç—Å—è –∏ —Å—Ç—Ä–µ–ª—è–µ—Ç (–£–õ–£–ß–®–ï–ù)
        if (theFog) {
            if (!isInvisible) {
                const dx = player.x - theFog.x, dy = player.y - theFog.y;
                const dist = Math.hypot(dx, dy);
                theFog.x += (dx / dist) * theFog.speed;
                theFog.y += (dy / dist) * theFog.speed;
                theFog.bouncePhase += 0.08;
                // –ö–æ–Ω—Ç–∞–∫—Ç —Å –∏–≥—Ä–æ–∫–æ–º
                if (dist < player.size + theFog.size) {
                    hazard += 20;
                    theFog.x -= (dx / dist) * 35;
                    theFog.y -= (dy / dist) * 35;
                    showMessage('üå´Ô∏è THE FOG! +20%', 1500);
                }
                // –°—Ç—Ä–µ–ª—å–±–∞ —Ç—É–º–∞–Ω–æ–º (–£–õ–£–ß–®–ï–ù–ù–û–ï –ü–†–ò–¶–ï–õ–ò–í–ê–ù–ò–ï)
                if (theFog.shootCooldown <= 0) {
                    // –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
                    const predictX = player.x + player.vx * 15;
                    const predictY = player.y + player.vy * 15;
                    const angle = Math.atan2(predictY - theFog.y, predictX - theFog.x);
                    projectiles.push({
                        x: theFog.x, y: theFog.y,
                        vx: Math.cos(angle) * 3, vy: Math.sin(angle) * 3,
                        size: 36, color: '#888', // –£–í–ï–õ–ò–ß–ï–ù —Ä–∞–∑–º–µ—Ä (20% –±–æ–ª—å—à–µ –±–æ—Å—Å–∞: 30 * 1.2 = 36)
                        friendly: false, life: 150,
                        slow: true, slowDuration: 8000,
                        isFogCloud: true
                    });
                    theFog.shootCooldown = 90;
                } else {
                    theFog.shootCooldown--;
                }
            }
            return;
        }

        if (emperor) {
            if (!isInvisible) {
                const dx = player.x - emperor.x, dy = player.y - emperor.y;
                const dist = Math.hypot(dx, dy);
                emperor.x += (dx / dist) * emperor.speed;
                emperor.y += (dy / dist) * emperor.speed;
                emperor.bouncePhase += 0.1;
                if (dist < player.size + emperor.size) {
                    hazard += 30;
                    emperor.x -= (dx / dist) * 30;
                    emperor.y -= (dy / dist) * 30;
                    showMessage('üëë –ò–ú–ü–ï–†–ê–¢–û–†! +30%', 1500);
                }
            }
            return;
        }
        enemies.forEach((e) => {
            if (e.type === 'gryaznya' || e.type === 'fog_runner' || e.type === 'pavuk') {
                if (!isInvisible) {
                    const dx = player.x - e.x, dy = player.y - e.y;
                    const dist = Math.hypot(dx, dy);
                    // –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –æ—Ç –í–∫—É—Å–Ω–æ—Å—Ç–∏
                    const eSlow = (e.slowed && Date.now() < e.slowUntil) ? 0.3 : 1;
                    e.x += (dx / dist) * e.speed * eSlow;
                    e.y += (dy / dist) * e.speed * eSlow;
                    e.bouncePhase += 0.1;
                    if (dist < player.size + e.size) {
                        hazard += e.damage;
                        e.x -= (dx / dist) * 20;
                        e.y -= (dy / dist) * 20;
                    }
                }
            } else if (e.type === 'fog_shooter' || e.type === 'pakost' || e.type === 'big_pavuk') {
                if (!isInvisible && e.shootCooldown <= 0) {
                    const dist = Math.hypot(player.x - e.x, player.y - e.y);
                    if (dist < 400) {
                        const angle = Math.atan2(player.y - e.y, player.x - e.x);
                        projectiles.push({ x: e.x, y: e.y,
                            vx: Math.cos(angle) * (e.type === 'big_pavuk' ? 3 : 2), 
                            vy: Math.sin(angle) * (e.type === 'big_pavuk' ? 3 : 2),
                            size: e.type === 'big_pavuk' ? 12 : 8, 
                            color: e.type === 'pakost' ? '#0F0' : e.type === 'big_pavuk' ? '#DDD' : '#00BFFF',
                            friendly: false, life: 120, slow: e.type === 'pakost', 
                            webShot: e.type === 'big_pavuk' });
                        e.shootCooldown = e.type === 'pakost' ? 180 : 120;
                    }
                } else { 
                    e.shootCooldown--; 
                }
                // –ë–æ–ª—å—à–æ–π –ø–∞–≤—É–∫ –º–µ–¥–ª–µ–Ω–Ω–æ –¥–≤–∏–∂–µ—Ç—Å—è
                if (e.type === 'big_pavuk' && !isInvisible) {
                    const dx = player.x - e.x, dy = player.y - e.y;
                    const dist = Math.hypot(dx, dy);
                    e.x += (dx / dist) * e.speed;
                    e.y += (dy / dist) * e.speed;
                }
            }
        });
    }

    function updateProjectiles() {
        projectiles.forEach((p, idx) => {
            p.x += p.vx; p.y += p.vy; p.life--;
            if (p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height || p.life <= 0) {
                projectiles.splice(idx, 1); return;
            }
            if (p.friendly) {
                enemies.forEach((e, ei) => {
                    if (Math.hypot(p.x - e.x, p.y - e.y) < e.size + p.size * 0.5) {
                        if (p.shootType === 'aoe') {
                            // AOE ‚Äî —É–±–∏–≤–∞–µ–º –≤—Å–µ—Ö –≤—Ä–∞–≥–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ
                            const aoeR = p.aoeRadius || 80;
                            // –†–∏—Å—É–µ–º –≤–∑—Ä—ã–≤ (—Ñ–ª–∞–≥ –¥–ª—è draw)
                            p.exploding = true;
                            p.explodeX  = p.x;
                            p.explodeY  = p.y;
                            p.explodeR  = aoeR;
                            const toRemove = [];
                            enemies.forEach((e2, ei2) => {
                                if (Math.hypot(p.x - e2.x, p.y - e2.y) < aoeR) {
                                    toRemove.push(ei2);
                                }
                            });
                            // –£–¥–∞–ª—è–µ–º —Å –∫–æ–Ω—Ü–∞ —á—Ç–æ–±—ã –∏–Ω–¥–µ–∫—Å—ã –Ω–µ —Å–¥–≤–∏–≥–∞–ª–∏—Å—å
                            toRemove.reverse().forEach(i => enemies.splice(i, 1));
                            projectiles.splice(idx, 1);
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∑—Ä—ã–≤
                            aoeExplosions.push({ x: p.x, y: p.y, r: aoeR, life: 25, maxLife: 25 });
                            showMessage('üí• –ë–≠–ú –ë–≠–ú! –ü–æ –ø–ª–æ—â–∞–¥–∏!', 1200);
                        } else if (p.shootType === 'slow') {
                            // –ó–∞–º–µ–¥–ª—è—é—â–∏–π ‚Äî —É–±–∏–≤–∞–µ–º –≤—Ä–∞–≥–∞ –∏ –∑–∞–º–µ–¥–ª—è–µ–º —Å–æ—Å–µ–¥–Ω–∏—Ö –Ω–∞ 5—Å
                            const hitX = e.x, hitY = e.y;
                            enemies.splice(ei, 1);
                            projectiles.splice(idx, 1);
                            // –ó–∞–º–µ–¥–ª—è–µ–º –≤—Å–µ—Ö –≤—Ä–∞–≥–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ 100
                            enemies.forEach(e2 => {
                                if (Math.hypot(hitX - e2.x, hitY - e2.y) < 100) {
                                    e2.slowed = true;
                                    e2.slowUntil = Date.now() + 5000;
                                }
                            });
                            showMessage('üê∞ –ó–ê–ú–ï–î–õ–ï–ù–ò–ï! 5—Å', 1200);
                        } else if (p.shootType === 'web') {
                            // –ü–∞—É—Ç–∏–Ω–∞ –ü–∞–≤—É–∫–∞ ‚Äî –∑–∞–º–µ–¥–ª—è–µ—Ç –≤—Ä–∞–≥–∞ –Ω–∞ 4 —Å–µ–∫—É–Ω–¥—ã
                            e.slowed = true;
                            e.slowUntil = Date.now() + 4000;
                            projectiles.splice(idx, 1);
                            showMessage('üï∑Ô∏è –ó–ê–ú–ï–î–õ–ï–ù–ò–ï! 4—Å', 1000);
                        } else if (p.shootType === 'web_push') {
                            // –ü–∞—É—Ç–∏–Ω–∞ –®–ª—è–ø—É–∫–∞ ‚Äî –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–µ—Ç –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç
                            const hitX = e.x, hitY = e.y;
                            const dx = e.x - player.x;
                            const dy = e.y - player.y;
                            const dist = Math.hypot(dx, dy);
                            e.x += (dx / dist) * 100;
                            e.y += (dy / dist) * 100;
                            e.x = Math.max(0, Math.min(canvas.width, e.x));
                            e.y = Math.max(0, Math.min(canvas.height, e.y));
                            e.slowed = true;
                            e.slowUntil = Date.now() + 3000;
                            projectiles.splice(idx, 1);
                            showMessage('üçÑ –û–¢–¢–ê–õ–ö–ò–í–ê–ù–ò–ï!', 1000);
                        } else if (p.shootType === 'fog') {
                            // –§–æ–≥ ‚Äî —É–±–∏–≤–∞–µ—Ç –∏ –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–æ—Å–µ–¥–Ω–∏—Ö
                            const hitX = e.x, hitY = e.y;
                            enemies.splice(ei, 1);
                            projectiles.splice(idx, 1);
                            // –ó–∞–º–µ–¥–ª—è–µ–º –≤—Å–µ—Ö –≤—Ä–∞–≥–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ 120
                            enemies.forEach(e2 => {
                                if (Math.hypot(hitX - e2.x, hitY - e2.y) < 120) {
                                    e2.slowed = true;
                                    e2.slowUntil = Date.now() + 6000;
                                }
                            });
                            showMessage('üå´Ô∏è –î–´–ú! –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ 6—Å', 1200);
                        } else {
                            // –û–±—ã—á–Ω—ã–π
                            enemies.splice(ei, 1);
                            projectiles.splice(idx, 1);
                            showMessage('üí• –£–ë–ò–¢!', 1000);
                        }
                    }
                });
            } else {
                if (Math.hypot(p.x - player.x, p.y - player.y) < player.size) {
                    hazard += 8; projectiles.splice(idx, 1);
                    if (p.webShot) {
                        // –ü–∞—É—Ç–∏–Ω–∞ –æ—Ç –±–æ–ª—å—à–æ–≥–æ –ø–∞–≤—É–∫–∞
                        showMessage('üï∏Ô∏è –ü–ê–£–¢–ò–ù–ê! +8%', 1000);
                    } else if (p.slow) {
                        const slowMs = p.slowDuration || 3000;
                        playerSlowUntil = Date.now() + slowMs;
                        if (p.isFogCloud) {
                            showMessage('üå´Ô∏è –¢–£–ú–ê–ù! –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ 8—Å', 2000);
                        } else {
                            showMessage('üê∞ –ü–ê–ö–û–°–¢–¨! –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ 3—Å', 1500);
                        }
                    } else {
                        showMessage(currentLocation === 'mytishchi' ? 'üíß –ü–£–ó–´–†–¨! +8%' : 'üíß –§–û–ì! +8%', 1000);
                    }
                }
            }
        });
    }

    // ===================== DRAW =====================
    function drawPlayer() {
        const ch = characters[currentChar];
        const isInvisible = Date.now() < invisibleUntil;
        
        // –ï—Å–ª–∏ –Ω–µ–≤–∏–¥–∏–º, —Ä–∏—Å—É–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º
        if (isInvisible) {
            ctx.globalAlpha = 0.3;
        }

        if (currentChar === 'kotnost') {
            // –ö–æ—Ç–Ω–æ—Å—Ç—å ‚Äî –∫–æ—Ç
            ctx.fillStyle = '#F4A460';
            ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#FFF'; ctx.lineWidth = 3; ctx.stroke();
            // –£—à–∫–∏ –∫–æ—Ç–∞
            ctx.fillStyle = '#F4A460';
            ctx.beginPath();
            ctx.moveTo(player.x - 14, player.y - player.size + 2);
            ctx.lineTo(player.x - 7,  player.y - player.size - 13);
            ctx.lineTo(player.x - 1,  player.y - player.size + 2);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(player.x + 1,  player.y - player.size + 2);
            ctx.lineTo(player.x + 7,  player.y - player.size - 13);
            ctx.lineTo(player.x + 14, player.y - player.size + 2);
            ctx.fill();
            ctx.fillStyle = '#000'; ctx.font = '16px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('üê±', player.x, player.y);

        } else if (currentChar === 'yakrasny') {
            // –Ø —É–∂–µ –∫—Ä–∞—Å–Ω—ã–π
            const readyColor = pushCooldown <= 0 ? '#FF2222' : '#881111';
            ctx.fillStyle = readyColor;
            ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = pushCooldown <= 0 ? '#FFD700' : '#FFF'; ctx.lineWidth = 3; ctx.stroke();
            // –ü—É–ª—å—Å –µ—Å–ª–∏ –≥–æ—Ç–æ–≤–æ
            if (pushCooldown <= 0) {
                ctx.strokeStyle = 'rgba(255,215,0,0.35)'; ctx.lineWidth = 6;
                ctx.beginPath(); ctx.arc(player.x, player.y, player.size + 6, 0, Math.PI * 2); ctx.stroke();
            }
            ctx.fillStyle = '#000'; ctx.font = '18px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('üü•', player.x, player.y);
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫—É–ª–¥–∞—É–Ω–∞
            if (pushCooldown > 0) {
                const secsLeft = Math.ceil(pushCooldown / 60);
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.beginPath(); ctx.arc(player.x, player.y - player.size - 14, 11, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#FF4444'; ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(secsLeft, player.x, player.y - player.size - 14);
            }

        } else if (currentChar === 'vkusnost') {
            // –í–∫—É—Å–Ω–æ—Å—Ç—å ‚Äî –∫—Ä–æ–ª–∏–∫
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#FFF'; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = '#FF9EC4';
            ctx.beginPath();
            ctx.ellipse(player.x - 8, player.y - player.size - 10, 5, 12, -0.2, 0, Math.PI * 2);
            ctx.ellipse(player.x + 8, player.y - player.size - 10, 5, 12,  0.2, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000'; ctx.font = '14px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('üê∞', player.x, player.y);

        } else if (currentChar === 'bambam') {
            // –ë—ç–º –ë—ç–º
            ctx.fillStyle = '#FF8C00';
            ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#FFF'; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = '#000'; ctx.font = '20px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('üí•', player.x, player.y);

        } else if (currentChar === 'melstroy') {
            // –ú–µ–ª—Å—Ç—Ä–æ–π ‚Äî –∑–æ–ª–æ—Ç–æ–π
            ctx.fillStyle = '#FFD700';
            ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#FFF'; ctx.lineWidth = 3; ctx.stroke();
            // –ó–æ–ª–æ—Ç–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
            ctx.shadowColor = '#FFD700'; ctx.shadowBlur = 15;
            ctx.strokeStyle = 'rgba(255,215,0,0.5)'; ctx.lineWidth = 6;
            ctx.beginPath(); ctx.arc(player.x, player.y, player.size + 5, 0, Math.PI * 2); ctx.stroke();
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#000'; ctx.font = '20px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('‚≠ê', player.x, player.y);

        } else {
            ctx.fillStyle = player.color;
            ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#FFF'; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = '#000'; ctx.font = '20px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('üòä', player.x, player.y);
        }
        
        // –°–±—Ä–æ—Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        if (isInvisible) {
            ctx.globalAlpha = 1;
        }
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫—É–ª–¥–∞—É–Ω–∞ –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–ª—è –ö—å–æ
        if (currentChar === 'kyo' && invisibilityCooldown > 0 && !isInvisible) {
            const secsLeft = Math.ceil(invisibilityCooldown / 60);
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.beginPath(); ctx.arc(player.x, player.y - player.size - 14, 11, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#9370DB'; ctx.font = 'bold 11px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(secsLeft, player.x, player.y - player.size - 14);
        }
    }

    function drawCoins() {
        coins.forEach(c => {
            ctx.save(); ctx.translate(c.x, c.y); ctx.rotate(c.angle);
            ctx.fillStyle = c.color;
            ctx.beginPath(); ctx.arc(0, 0, c.size, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.beginPath(); ctx.arc(-4, -4, 4, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
        });
    }

    function drawEnemies() {
        enemies.forEach(e => {
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –∑–∞–º–µ–¥–ª–µ–Ω–∏—è
            const isSlowed = e.slowed && Date.now() < e.slowUntil;

            if (e.type === 'gryaznya') {
                ctx.fillStyle = isSlowed ? '#AAD4FF' : e.color;
                ctx.fillRect(e.x - e.size/2, e.y - e.size/2, e.size, e.size);
                ctx.fillStyle = '#FFE4C4';
                ctx.beginPath(); ctx.arc(e.x, e.y - e.size/3, e.size/3, 0, Math.PI*2); ctx.fill();
            } else if (e.type === 'fog_shooter') {
                ctx.fillStyle = isSlowed ? '#AAD4FF' : e.color; ctx.globalAlpha = 0.6;
                ctx.beginPath(); ctx.arc(e.x, e.y, e.size, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1; ctx.fillStyle = '#000';
                ctx.beginPath(); ctx.arc(e.x-8, e.y-5, 4, 0, Math.PI*2); ctx.arc(e.x+8, e.y-5, 4, 0, Math.PI*2); ctx.fill();
            } else if (e.type === 'pakost') {
                ctx.fillStyle = isSlowed ? '#C8E8FF' : '#FFF';
                ctx.beginPath(); ctx.arc(e.x, e.y, e.size, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#FFB6C1';
                ctx.beginPath(); ctx.ellipse(e.x-12, e.y-20, 6, 14, 0, 0, Math.PI*2);
                ctx.ellipse(e.x+12, e.y-20, 6, 14, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = isSlowed ? '#00F' : '#F00';
                ctx.beginPath(); ctx.arc(e.x-8, e.y-5, 4, 0, Math.PI*2); ctx.arc(e.x+8, e.y-5, 4, 0, Math.PI*2); ctx.fill();
            } else if (e.type === 'fog_runner') {
                ctx.fillStyle = isSlowed ? '#AAD4FF' : e.color;
                ctx.beginPath(); ctx.arc(e.x, e.y, e.size, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
            } else if (e.type === 'pavuk') {
                // –ù–∞—Å—Ç–æ—è—â–∏–π –ø–∞—É–∫ —Å –ª–∞–ø–∫–∞–º–∏
                const lp = (e.legPhase || 0);
                const r = e.size;
                ctx.save();

                // –õ–∞–ø–∫–∏ (8 —à—Ç—É–∫ ‚Äî 4 —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
                ctx.strokeStyle = isSlowed ? '#4488AA' : '#2A1000';
                ctx.lineWidth = 2;
                for (let i = 0; i < 4; i++) {
                    const legAngle = -Math.PI * 0.7 + i * (Math.PI * 0.45);
                    const wave = Math.sin(lp * 3 + i * 0.8) * 0.25;
                    // –õ–µ–≤–∞—è –ª–∞–ø–∫–∞
                    const lx1 = e.x - r * 0.5;
                    const ly1 = e.y + r * 0.1;
                    const lx2 = e.x - r * 1.3 * Math.cos(legAngle + wave);
                    const ly2 = e.y + r * 0.9 * Math.sin(legAngle + wave);
                    const lx3 = e.x - r * 1.8 * Math.cos(legAngle - 0.3 + wave);
                    const ly3 = e.y + r * 1.4 * Math.sin(legAngle - 0.3 + wave);
                    ctx.beginPath();
                    ctx.moveTo(lx1, ly1);
                    ctx.quadraticCurveTo(lx2, ly2, lx3, ly3);
                    ctx.stroke();
                    // –ü—Ä–∞–≤–∞—è –ª–∞–ø–∫–∞ (–∑–µ—Ä–∫–∞–ª—å–Ω–æ)
                    const rx2 = e.x + r * 1.3 * Math.cos(legAngle + wave);
                    const ry2 = e.y + r * 0.9 * Math.sin(legAngle + wave);
                    const rx3 = e.x + r * 1.8 * Math.cos(legAngle - 0.3 + wave);
                    const ry3 = e.y + r * 1.4 * Math.sin(legAngle - 0.3 + wave);
                    ctx.beginPath();
                    ctx.moveTo(e.x + r * 0.5, ly1);
                    ctx.quadraticCurveTo(rx2, ry2, rx3, ry3);
                    ctx.stroke();
                }

                // –ë—Ä—é—Ö–æ (–±–æ–ª—å—à–æ–π –∫—Ä—É–≥ —Å–Ω–∏–∑—É)
                const abdomenGrad = ctx.createRadialGradient(e.x, e.y + r * 0.5, 0, e.x, e.y + r * 0.5, r * 0.85);
                abdomenGrad.addColorStop(0, isSlowed ? '#5588AA' : '#5C2A00');
                abdomenGrad.addColorStop(0.6, isSlowed ? '#3366AA' : '#3B1800');
                abdomenGrad.addColorStop(1, '#110500');
                ctx.fillStyle = abdomenGrad;
                ctx.beginPath();
                ctx.ellipse(e.x, e.y + r * 0.45, r * 0.72, r * 0.82, 0, 0, Math.PI * 2);
                ctx.fill();

                // –£–∑–æ—Ä –Ω–∞ –±—Ä—é—Ö–µ (–∫—Ä–∞—Å–Ω—ã–µ —Ç–æ—á–∫–∏)
                ctx.fillStyle = '#DD2200';
                ctx.beginPath();
                ctx.ellipse(e.x, e.y + r * 0.5, r * 0.22, r * 0.32, 0, 0, Math.PI * 2);
                ctx.fill();

                // –ì–æ–ª–æ–≤–∞ (–º–µ–Ω—å—à–∏–π –∫—Ä—É–≥ —Å–≤–µ—Ä—Ö—É)
                const headGrad = ctx.createRadialGradient(e.x - r * 0.15, e.y - r * 0.15, 0, e.x, e.y - r * 0.25, r * 0.55);
                headGrad.addColorStop(0, isSlowed ? '#4477AA' : '#7A3800');
                headGrad.addColorStop(1, isSlowed ? '#224488' : '#3B1800');
                ctx.fillStyle = headGrad;
                ctx.beginPath();
                ctx.ellipse(e.x, e.y - r * 0.22, r * 0.5, r * 0.48, 0, 0, Math.PI * 2);
                ctx.fill();

                // –ì–ª–∞–∑–∞ (4 –ø–∞—Ä—ã, –∫–∞–∫ —É –ø–∞—É–∫–∞)
                ctx.fillStyle = '#FF0000';
                const eyes = [[-0.22, -0.32], [0.22, -0.32], [-0.1, -0.42], [0.1, -0.42]];
                eyes.forEach(([ex, ey]) => {
                    ctx.beginPath();
                    ctx.arc(e.x + r * ex, e.y + r * ey, r * 0.1, 0, Math.PI * 2);
                    ctx.fill();
                    // –ë–µ–ª—ã–π –∑—Ä–∞—á–æ–∫
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.beginPath();
                    ctx.arc(e.x + r * ex + r * 0.03, e.y + r * ey - r * 0.03, r * 0.04, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FF0000';
                });

                // –ñ–≤–∞–ª—ã (–º–∞–Ω–¥–∏–±—É–ª—ã)
                ctx.strokeStyle = '#1A0A00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(e.x - r * 0.18, e.y - r * 0.62);
                ctx.lineTo(e.x - r * 0.32, e.y - r * 0.85 + Math.sin(lp * 4) * r * 0.1);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.x + r * 0.18, e.y - r * 0.62);
                ctx.lineTo(e.x + r * 0.32, e.y - r * 0.85 + Math.sin(lp * 4 + 0.5) * r * 0.1);
                ctx.stroke();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–∑—É –∞–Ω–∏–º–∞—Ü–∏–∏ –ª–∞–ø–æ–∫
                if (e.legPhase === undefined) e.legPhase = 0;
                e.legPhase += 0.12;

                ctx.restore();
            } else if (e.type === 'big_pavuk') {
                // –ë–æ–ª—å—à–æ–π –ø–∞—É–∫ ‚Äî —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π, –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–∏–π, –Ω–æ –∫—Ä—É–ø–Ω–µ–µ –∏ —Å –¥—Ä—É–≥–æ–π –æ–∫—Ä–∞—Å–∫–æ–π
                const lp = (e.legPhase || 0);
                const r = e.size;
                ctx.save();

                // –õ–∞–ø–∫–∏ (8 —à—Ç—É–∫ ‚Äî 4 —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã), –¥–ª–∏–Ω–Ω–µ–µ –∏ —Ç–æ–ª—â–µ
                ctx.strokeStyle = isSlowed ? '#4488AA' : '#1A0A00';
                ctx.lineWidth = 3;
                for (let i = 0; i < 4; i++) {
                    const legAngle = -Math.PI * 0.75 + i * (Math.PI * 0.48);
                    const wave = Math.sin(lp * 2.5 + i * 0.8) * 0.2;
                    // –õ–µ–≤–∞—è –ª–∞–ø–∫–∞
                    const lx1 = e.x - r * 0.5;
                    const ly1 = e.y + r * 0.1;
                    const lx2 = e.x - r * 1.5 * Math.cos(legAngle + wave);
                    const ly2 = e.y + r * 1.0 * Math.sin(legAngle + wave);
                    const lx3 = e.x - r * 2.1 * Math.cos(legAngle - 0.25 + wave);
                    const ly3 = e.y + r * 1.6 * Math.sin(legAngle - 0.25 + wave);
                    ctx.beginPath();
                    ctx.moveTo(lx1, ly1);
                    ctx.quadraticCurveTo(lx2, ly2, lx3, ly3);
                    ctx.stroke();
                    // –ü—Ä–∞–≤–∞—è –ª–∞–ø–∫–∞
                    const rx2 = e.x + r * 1.5 * Math.cos(legAngle + wave);
                    const ry2 = e.y + r * 1.0 * Math.sin(legAngle + wave);
                    const rx3 = e.x + r * 2.1 * Math.cos(legAngle - 0.25 + wave);
                    const ry3 = e.y + r * 1.6 * Math.sin(legAngle - 0.25 + wave);
                    ctx.beginPath();
                    ctx.moveTo(e.x + r * 0.5, ly1);
                    ctx.quadraticCurveTo(rx2, ry2, rx3, ry3);
                    ctx.stroke();
                }

                // –ë—Ä—é—Ö–æ ‚Äî –∫—Ä—É–ø–Ω–æ–µ, —Ç—ë–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–æ–µ —Å –∑–µ–ª—ë–Ω—ã–º –æ—Ç–ª–∏–≤–æ–º
                const abdomenGrad = ctx.createRadialGradient(e.x, e.y + r * 0.5, 0, e.x, e.y + r * 0.5, r * 0.95);
                abdomenGrad.addColorStop(0, isSlowed ? '#336699' : '#4A2200');
                abdomenGrad.addColorStop(0.5, isSlowed ? '#224488' : '#2B1200');
                abdomenGrad.addColorStop(1, '#0A0300');
                ctx.fillStyle = abdomenGrad;
                ctx.beginPath();
                ctx.ellipse(e.x, e.y + r * 0.45, r * 0.78, r * 0.88, 0, 0, Math.PI * 2);
                ctx.fill();

                // –£–∑–æ—Ä –Ω–∞ –±—Ä—é—Ö–µ ‚Äî –∂—ë–ª—Ç–æ-–∑–µ–ª—ë–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ (–∫–∞–∫ —É –∫—Ä–µ—Å—Ç–æ–≤–∏–∫–∞)
                ctx.fillStyle = isSlowed ? '#88CCFF' : '#7B9B00';
                ctx.beginPath();
                ctx.ellipse(e.x, e.y + r * 0.38, r * 0.28, r * 0.52, 0, 0, Math.PI * 2);
                ctx.fill();
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—è—Ç–Ω–∞
                ctx.fillStyle = isSlowed ? '#AADDFF' : '#A0B800';
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.ellipse(e.x, e.y + r * (0.1 + i * 0.35), r * 0.14, r * 0.1, 0, 0, Math.PI * 2);
                    ctx.fill();
                }

                // –ì–æ–ª–æ–≤–∞
                const headGrad = ctx.createRadialGradient(e.x - r * 0.1, e.y - r * 0.2, 0, e.x, e.y - r * 0.28, r * 0.6);
                headGrad.addColorStop(0, isSlowed ? '#5588AA' : '#6B3300');
                headGrad.addColorStop(1, isSlowed ? '#224477' : '#2B1200');
                ctx.fillStyle = headGrad;
                ctx.beginPath();
                ctx.ellipse(e.x, e.y - r * 0.24, r * 0.55, r * 0.52, 0, 0, Math.PI * 2);
                ctx.fill();

                // –ì–ª–∞–∑–∞ ‚Äî 4 –ø–∞—Ä—ã –∫—Ä–∞—Å–Ω—ã—Ö
                ctx.fillStyle = '#FF2200';
                const eyes = [[-0.25, -0.34], [0.25, -0.34], [-0.1, -0.46], [0.1, -0.46]];
                eyes.forEach(([ex, ey]) => {
                    ctx.beginPath();
                    ctx.arc(e.x + r * ex, e.y + r * ey, r * 0.11, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'rgba(255,255,255,0.55)';
                    ctx.beginPath();
                    ctx.arc(e.x + r * ex + r * 0.03, e.y + r * ey - r * 0.03, r * 0.045, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FF2200';
                });

                // –ñ–≤–∞–ª—ã ‚Äî –∫—Ä—É–ø–Ω—ã–µ
                ctx.strokeStyle = '#0A0500';
                ctx.lineWidth = 2.5;
                ctx.beginPath();
                ctx.moveTo(e.x - r * 0.2, e.y - r * 0.65);
                ctx.lineTo(e.x - r * 0.38, e.y - r * 0.95 + Math.sin(lp * 3.5) * r * 0.12);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.x + r * 0.2, e.y - r * 0.65);
                ctx.lineTo(e.x + r * 0.38, e.y - r * 0.95 + Math.sin(lp * 3.5 + 0.5) * r * 0.12);
                ctx.stroke();

                // –ó–Ω–∞—á–æ–∫ üï∏Ô∏è –Ω–∞–¥ –ø–∞—É–∫–æ–º —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ —Å—Ç—Ä–µ–ª—è–µ—Ç –ø–∞—É—Ç–∏–Ω–æ–π
                ctx.font = 'bold ' + Math.round(r * 0.5) + 'px Arial';
                ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
                ctx.globalAlpha = 0.8;
                ctx.fillText('üï∏Ô∏è', e.x, e.y - r * 1.1);
                ctx.globalAlpha = 1;

                if (e.legPhase === undefined) e.legPhase = 0;
                e.legPhase += 0.08;

                ctx.restore();
            }

            // –ò–∫–æ–Ω–∫–∞ ‚ùÑÔ∏è –Ω–∞–¥ –∑–∞–º–µ–¥–ª—ë–Ω–Ω—ã–º
            if (isSlowed) {
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('‚ùÑÔ∏è', e.x, e.y - e.size - 10);
            }
        });
    }

    function drawAoeExplosions() {
        aoeExplosions.forEach((exp, i) => {
            const progress = 1 - exp.life / exp.maxLife;
            const r = exp.r * (0.3 + 0.7 * progress);
            ctx.globalAlpha = (1 - progress) * 0.7;
            const grad = ctx.createRadialGradient(exp.x, exp.y, 0, exp.x, exp.y, r);
            grad.addColorStop(0, '#FFF');
            grad.addColorStop(0.3, '#FF8C00');
            grad.addColorStop(1, 'rgba(255,60,0,0)');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(exp.x, exp.y, r, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
            exp.life--;
            if (exp.life <= 0) aoeExplosions.splice(i, 1);
        });
    }

    function drawProjectiles() {
        projectiles.forEach(p => {
            if (p.shootType === 'aoe') {
                // –ë–æ–ª—å—à–æ–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Å–Ω–∞—Ä—è–¥ —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π
                ctx.fillStyle = '#FF8C00';
                ctx.globalAlpha = 0.9;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#FFF';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.aoeRadius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.globalAlpha = 1;
            } else if (p.shootType === 'slow') {
                // –†–æ–∑–æ–≤—ã–π —Å–Ω–∞—Ä—è–¥ —Å –∑–≤—ë–∑–¥–æ—á–∫–æ–π
                ctx.fillStyle = '#FFB6C1';
                ctx.globalAlpha = 0.85;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('‚ùÑÔ∏è', p.x, p.y);
            } else if (p.shootType === 'web' || p.shootType === 'web_push') {
                // –ü–∞—É—Ç–∏–Ω–∞
                ctx.fillStyle = p.color;
                ctx.globalAlpha = 0.7;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üï∏Ô∏è', p.x, p.y);
            } else if (p.shootType === 'fog') {
                // –î—ã–º–æ–≤–æ–π —Å–Ω–∞—Ä—è–¥ –§–æ–≥–∞
                ctx.globalAlpha = 0.75;
                const gr3 = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
                gr3.addColorStop(0, 'rgba(136,136,136,0.9)');
                gr3.addColorStop(1, 'rgba(64,64,64,0)');
                ctx.fillStyle = gr3;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            } else if (p.isFogCloud) {
                // –¢—É–º–∞–Ω–Ω–æ–µ –æ–±–ª–∞–∫–æ –æ—Ç The FOG (–°–ï–†–û–ï)
                ctx.globalAlpha = 0.7 * (p.life / 150);
                const gr2 = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
                gr2.addColorStop(0, 'rgba(136,136,136,0.8)');
                gr2.addColorStop(1, 'rgba(64,64,64,0)');
                ctx.fillStyle = gr2;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            } else {
                // –û–±—ã—á–Ω—ã–π —Å–Ω–∞—Ä—è–¥
                ctx.fillStyle = p.color;
                ctx.globalAlpha = 0.8;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        });
    }

    function drawShowers() {
        showers.forEach(s => {
            ctx.fillStyle = s.color;
            ctx.fillRect(s.x - s.size/2, s.y - s.size/2, s.size, s.size);
            ctx.fillStyle = '#000'; ctx.font = '20px Arial';
            ctx.textAlign = 'center'; ctx.fillText('üöø', s.x, s.y);
        });
    }

    function drawArthur() {
        ctx.fillStyle = arthur.color;
        ctx.beginPath(); ctx.arc(arthur.x, arthur.y, arthur.size, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#000'; ctx.font = '30px Arial';
        ctx.textAlign = 'center'; ctx.fillText('üëã', arthur.x, arthur.y);
    }

    function drawEmperor() {
        const scale = 1 + Math.sin(emperor.bouncePhase) * 0.1;
        // –°–≤–µ—á–µ–Ω–∏–µ
        ctx.shadowColor = '#00BFFF';
        ctx.shadowBlur  = 25;
        ctx.fillStyle   = emperor.color; ctx.globalAlpha = 0.75;
        ctx.beginPath(); ctx.arc(emperor.x, emperor.y, emperor.size * scale, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
        ctx.shadowBlur  = 0;
        // –ö–æ–Ω—Ç—É—Ä
        ctx.strokeStyle = '#7FDFFF'; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(emperor.x, emperor.y, emperor.size * scale, 0, Math.PI*2); ctx.stroke();
        // –ö–æ—Ä–æ–Ω–∞
        ctx.fillStyle = '#FFD700';
        ctx.beginPath();
        ctx.moveTo(emperor.x, emperor.y - emperor.size - 14);
        ctx.lineTo(emperor.x - 22, emperor.y - emperor.size + 8);
        ctx.lineTo(emperor.x + 22, emperor.y - emperor.size + 8);
        ctx.closePath(); ctx.fill();
        ctx.strokeStyle = '#FFA500'; ctx.lineWidth = 2; ctx.stroke();
        // –ì–ª–∞–∑–∞
        ctx.fillStyle = '#FF3300';
        ctx.beginPath(); ctx.arc(emperor.x - 16, emperor.y - 10, 8, 0, Math.PI*2); ctx.arc(emperor.x + 16, emperor.y - 10, 8, 0, Math.PI*2); ctx.fill();
        // –ë–µ–ª–∫–∏ –≥–ª–∞–∑
        ctx.fillStyle = '#FFF';
        ctx.beginPath(); ctx.arc(emperor.x - 14, emperor.y - 12, 3, 0, Math.PI*2); ctx.arc(emperor.x + 18, emperor.y - 12, 3, 0, Math.PI*2); ctx.fill();
    }

    // ===================== GAME OVER =====================
    function die() {
        gameRunning = false;
        stopMusic(); sfxDie();
        const hazardName = currentLocation === 'mytishchi' ? '–ì—Ä—è–∑–Ω–æ—Å—Ç—å' : currentLocation === 'molochnoe' ? '–ü–∞–≤—É–∫–æ—Å—Ç—å' : '–§–æ–≥–æ—Å—Ç—å';
        document.getElementById('deathStats').innerHTML = hazardName + ': 100%<br>üí∞ –°–æ–±—Ä–∞–Ω–æ: ' + currency.toLocaleString();
        document.getElementById('deathScreen').style.display = 'flex';
    }

    function victory() {
        gameRunning = false;
        stopMusic(); sfxVictory();
        document.getElementById('victoryStats').innerHTML = 'üéâ 10,000 –¥—Ä—É–Ω–±–ª–µ–π —Å–æ–±—Ä–∞–Ω–æ!<br>üìç –õ–æ–∫–∞—Ü–∏—è: –ú—ã—Ç–∏—â–∏';
        document.getElementById('victoryScreen').style.display = 'flex';
    }

    function drawTheFog() {
        const scale = 1 + Math.sin(theFog.bouncePhase) * 0.12;
        const r     = theFog.size * scale;

        // –ü—É–ª—å—Å–∏—Ä—É—é—â–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ (–°–ï–†–û–ï)
        ctx.shadowColor = '#888';
        ctx.shadowBlur  = 30;

        // –ù–µ—Å–∫–æ–ª—å–∫–æ –æ–±–ª–∞–∫–æ–≤ –¥—ã–º–∞ (–°–ï–†–´–ï)
        for (let i = 0; i < 5; i++) {
            const angle  = (i / 5) * Math.PI * 2 + theFog.bouncePhase * 0.6;
            const ox = Math.cos(angle) * r * 0.3;
            const oy = Math.sin(angle) * r * 0.3;
            const gr = ctx.createRadialGradient(theFog.x + ox, theFog.y + oy, 0, theFog.x + ox, theFog.y + oy, r * 0.75);
            gr.addColorStop(0, 'rgba(136,136,136,0.7)');
            gr.addColorStop(1, 'rgba(64,64,64,0)');
            ctx.fillStyle   = gr;
            ctx.globalAlpha = 0.8;
            ctx.beginPath();
            ctx.arc(theFog.x + ox, theFog.y + oy, r * 0.75, 0, Math.PI * 2);
            ctx.fill();
        }
        ctx.globalAlpha = 1;
        ctx.shadowBlur  = 0;

        // –ö–æ–Ω—Ç—É—Ä (–°–ï–†–´–ô)
        ctx.strokeStyle = '#AAA'; ctx.lineWidth = 2;
        ctx.globalAlpha = 0.7;
        ctx.beginPath();
        ctx.arc(theFog.x, theFog.y, r, 0, Math.PI * 2);
        ctx.stroke();
        ctx.globalAlpha = 1;

        // –ì–ª–∞–∑–∞-—Ç—É–º–∞–Ω
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        ctx.beginPath();
        ctx.arc(theFog.x - 9, theFog.y - 5, 5, 0, Math.PI * 2);
        ctx.arc(theFog.x + 9, theFog.y - 5, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#333';
        ctx.beginPath();
        ctx.arc(theFog.x - 9, theFog.y - 5, 3, 0, Math.PI * 2);
        ctx.arc(theFog.x + 9, theFog.y - 5, 3, 0, Math.PI * 2);
        ctx.fill();

        // –ù–∞–¥–ø–∏—Å—å (–°–ï–†–ê–Ø)
        ctx.fillStyle = '#AAA';
        ctx.font = 'bold 10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('THE FOG', theFog.x, theFog.y + r + 14);
    }

    // –ü–æ–ª–∏—Ñ–∏–ª–ª roundRect –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
            const radii = Array.isArray(r) ? r : [r, r, r, r];
            const [tl, tr, br, bl] = radii.map(v => Math.min(v || 0, Math.min(Math.abs(w), Math.abs(h)) / 2));
            this.moveTo(x + tl, y);
            this.lineTo(x + w - tr, y);
            this.quadraticCurveTo(x + w, y, x + w, y + tr);
            this.lineTo(x + w, y + h - br);
            this.quadraticCurveTo(x + w, y + h, x + w - br, y + h);
            this.lineTo(x + bl, y + h);
            this.quadraticCurveTo(x, y + h, x, y + h - bl);
            this.lineTo(x, y + tl);
            this.quadraticCurveTo(x, y, x + tl, y);
            this.closePath();
            return this;
        };
    }

    function drawTramvai() {
        const t = tramvai.bouncePhase;
        const scale = 1 + Math.sin(t) * 0.04;
        const x = tramvai.x;
        const y = tramvai.y;
        const w = tramvai.size * 2.2 * scale;   // —à–∏—Ä–∏–Ω–∞ –∫—É–∑–æ–≤–∞
        const h = tramvai.size * 1.6 * scale;   // –≤—ã—Å–æ—Ç–∞ –∫—É–∑–æ–≤–∞
        const x0 = x - w / 2;
        const y0 = y - h / 2;

        ctx.save();

        // === –°–í–ï–ß–ï–ù–ò–ï ===
        ctx.shadowColor = 'rgba(0,200,255,0.7)';
        ctx.shadowBlur = 28;

        // === –ö–£–ó–û–í ‚Äî –Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å –≥–æ–ª—É–±–∞—è ===
        ctx.fillStyle = '#29B6E8';
        ctx.beginPath();
        ctx.roundRect(x0, y0 + h * 0.38, w, h * 0.62, [0, 0, 8, 8]);
        ctx.fill();

        // === –ö–£–ó–û–í ‚Äî –≤–µ—Ä—Ö–Ω—è—è –ø–æ–ª–æ—Å–∞ –∂—ë–ª—Ç–∞—è ===
        ctx.fillStyle = '#F5C400';
        ctx.beginPath();
        ctx.roundRect(x0, y0 + h * 0.18, w, h * 0.22, 0);
        ctx.fill();

        // === –ö–†–´–®–ê ‚Äî –≥–æ–ª—É–±–∞—è —Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º ===
        ctx.fillStyle = '#1E9BD0';
        ctx.beginPath();
        ctx.roundRect(x0 + w * 0.03, y0, w * 0.94, h * 0.22, [10, 10, 0, 0]);
        ctx.fill();

        // === –ó–ï–õ–Å–ù–ê–Ø –ü–û–õ–û–°–ê –°–ù–ò–ó–£ ===
        ctx.fillStyle = '#2ECC40';
        ctx.beginPath();
        ctx.roundRect(x0, y0 + h * 0.88, w, h * 0.12, [0, 0, 8, 8]);
        ctx.fill();

        // === –ö–†–ê–°–ù–ê–Ø –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨–ù–ê–Ø –ü–û–õ–û–°–ö–ê ===
        ctx.fillStyle = '#CC2200';
        ctx.fillRect(x0, y0 + h * 0.37, w, h * 0.035);

        ctx.shadowBlur = 0;

        // === –õ–û–ë–û–í–û–ï –°–¢–ï–ö–õ–û (–±–æ–ª—å—à–æ–µ) ===
        ctx.fillStyle = 'rgba(135,210,240,0.85)';
        ctx.strokeStyle = '#F5C400';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.roundRect(x0 + w * 0.08, y0 + h * 0.2, w * 0.84, h * 0.3, 4);
        ctx.fill();
        ctx.stroke();

        // === –ë–õ–ò–ö–ò –ù–ê –°–¢–ï–ö–õ–ï ===
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.beginPath();
        ctx.roundRect(x0 + w * 0.1, y0 + h * 0.22, w * 0.3, h * 0.12, 3);
        ctx.fill();

        // === –ú–ê–†–®–†–£–¢–ù–ê–Ø –¢–ê–ë–õ–ò–ß–ö–ê (–ë–ï–†–ï–ì–û–í–û–ô) ===
        ctx.fillStyle = '#00AA00';
        ctx.beginPath();
        ctx.roundRect(x0 + w * 0.15, y0 + h * 0.02, w * 0.7, h * 0.12, 3);
        ctx.fill();
        ctx.fillStyle = '#FFFFFF';
        ctx.font = 'bold ' + Math.round(h * 0.09) + 'px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('–ë–ï–†–ï–ì–û–í–û–ô', x, y0 + h * 0.08);

        // === –ù–û–ú–ï–† 005 ===
        ctx.fillStyle = '#111';
        ctx.font = 'bold ' + Math.round(h * 0.13) + 'px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('005', x + w * 0.2, y0 + h * 0.72);

        // === –õ–ï–í–ê–Ø –§–ê–†–ê ===
        const headlightGlow = ctx.createRadialGradient(x0 + w * 0.18, y0 + h * 0.62, 0, x0 + w * 0.18, y0 + h * 0.62, h * 0.12);
        headlightGlow.addColorStop(0, 'rgba(255,255,220,1)');
        headlightGlow.addColorStop(0.5, 'rgba(255,240,100,0.6)');
        headlightGlow.addColorStop(1, 'rgba(255,240,100,0)');
        ctx.fillStyle = headlightGlow;
        ctx.beginPath();
        ctx.arc(x0 + w * 0.18, y0 + h * 0.62, h * 0.12, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#FFFFF0';
        ctx.beginPath();
        ctx.arc(x0 + w * 0.18, y0 + h * 0.62, h * 0.065, 0, Math.PI * 2);
        ctx.fill();

        // === –ü–†–ê–í–ê–Ø –§–ê–†–ê ===
        const headlightGlow2 = ctx.createRadialGradient(x0 + w * 0.82, y0 + h * 0.62, 0, x0 + w * 0.82, y0 + h * 0.62, h * 0.12);
        headlightGlow2.addColorStop(0, 'rgba(255,255,220,1)');
        headlightGlow2.addColorStop(0.5, 'rgba(255,240,100,0.6)');
        headlightGlow2.addColorStop(1, 'rgba(255,240,100,0)');
        ctx.fillStyle = headlightGlow2;
        ctx.beginPath();
        ctx.arc(x0 + w * 0.82, y0 + h * 0.62, h * 0.12, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#FFFFF0';
        ctx.beginPath();
        ctx.arc(x0 + w * 0.82, y0 + h * 0.62, h * 0.065, 0, Math.PI * 2);
        ctx.fill();

        // === –î–í–ï–†–ò (—Ç—ë–º–Ω—ã–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã) ===
        ctx.fillStyle = 'rgba(0,0,0,0.25)';
        ctx.fillRect(x0 + w * 0.38, y0 + h * 0.4, w * 0.04, h * 0.48);
        ctx.fillRect(x0 + w * 0.58, y0 + h * 0.4, w * 0.04, h * 0.48);

        // === –ö–†–ê–°–ù–ê–Ø –ó–í–ï–ó–î–ê (–∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ) ===
        ctx.fillStyle = '#CC0000';
        ctx.shadowColor = '#FF4400';
        ctx.shadowBlur = 6;
        const starX = x0 + w * 0.78, starY = y0 + h * 0.45;
        const starR = h * 0.055;
        ctx.beginPath();
        for (let i = 0; i < 5; i++) {
            const a1 = (i * 4 * Math.PI / 5) - Math.PI / 2;
            const a2 = ((i * 4 + 2) * Math.PI / 5) - Math.PI / 2;
            if (i === 0) ctx.moveTo(starX + starR * Math.cos(a1), starY + starR * Math.sin(a1));
            else         ctx.lineTo(starX + starR * Math.cos(a1), starY + starR * Math.sin(a1));
            ctx.lineTo(starX + starR * 0.4 * Math.cos(a2), starY + starR * 0.4 * Math.sin(a2));
        }
        ctx.closePath();
        ctx.fill();
        ctx.shadowBlur = 0;

        // === –ü–ê–ù–¢–û–ì–†–ê–§ (—Ç–æ–∫–æ—Å—ä—ë–º–Ω–∏–∫) ===
        const panto = y0 - h * 0.22;
        ctx.strokeStyle = '#888';
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        ctx.moveTo(x0 + w * 0.3, y0);
        ctx.lineTo(x + Math.sin(t * 0.7) * w * 0.05, panto);
        ctx.lineTo(x0 + w * 0.7, y0);
        ctx.stroke();
        // –ø–æ–ª–æ–∑
        ctx.strokeStyle = '#555';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(x - w * 0.35, panto);
        ctx.lineTo(x + w * 0.35, panto);
        ctx.stroke();
        // –ø—Ä–æ–≤–æ–¥
        ctx.strokeStyle = 'rgba(100,100,100,0.5)';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(x0 - w * 0.2, panto - h * 0.05);
        ctx.lineTo(x0 + w * 1.2, panto - h * 0.05);
        ctx.stroke();

        // === –ö–û–õ–Å–°–ê ===
        const wheelY = y0 + h * 0.97;
        [[x0 + w * 0.2, wheelY], [x0 + w * 0.8, wheelY]].forEach(([wx, wy]) => {
            ctx.fillStyle = '#333';
            ctx.beginPath(); ctx.arc(wx, wy, h * 0.1, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#666';
            ctx.beginPath(); ctx.arc(wx, wy, h * 0.055, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#AAA'; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.arc(wx, wy, h * 0.1, 0, Math.PI * 2); ctx.stroke();
        });

        // === –†–ï–õ–¨–° ===
        ctx.strokeStyle = 'rgba(100,100,100,0.6)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(x0 - w * 0.3, y0 + h * 1.02);
        ctx.lineTo(x0 + w * 1.3, y0 + h * 1.02);
        ctx.stroke();

        // === –ù–ê–î–ü–ò–°–¨ –¢–†–ê–ú–í–ê–ô ===
        ctx.fillStyle = '#FFD700';
        ctx.font = 'bold ' + Math.round(h * 0.12) + 'px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = '#000';
        ctx.shadowBlur = 4;
        ctx.fillText('–¢–†–ê–ú–í–ê–ô', x, y0 + h * 1.15);
        ctx.shadowBlur = 0;

        ctx.restore();
    }

    function murinoBossVictory() {
        gameRunning = false;
        stopMusic(); sfxVictory();
        molochnoeUnlocked = true;
        localStorage.setItem('molochnoeUnlocked', 'true');
        document.getElementById('victoryStats').innerHTML =
            'üå´Ô∏è THE FOG –ü–û–ë–ï–ñ–î–Å–ù!<br>üíú –¢—É–º–∞–Ω–Ω—ã–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã —Å–æ–±—Ä–∞–Ω—ã: 30<br>üíé –í—Å–µ–≥–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤: ' + totalCrystals + '<br><br>üï∏Ô∏è –ú–û–õ–û–ß–ù–û–ï –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–û!';
        document.getElementById('victoryScreen').style.display = 'flex';
    }

    function murinoVictory() {
        gameRunning = false;
        stopMusic(); sfxVictory();
        document.getElementById('victoryStats').innerHTML =
            'üéâ 20,000 –¥—Ä—É–Ω–±–ª–µ–π —Å–æ–±—Ä–∞–Ω–æ!<br>üìç –õ–æ–∫–∞—Ü–∏—è: –ú—É—Ä–∏–Ω–æ<br><br>' +
            'üÜï –¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø–æ–∫—É–ø–∫–∏:<br>' +
            '<span style="color:#CE93D8">üê∞ –í–∫—É—Å–Ω–æ—Å—Ç—å</span> ‚Ä¢ ' +
            '<span style="color:#FFCC02">üí• –ë—ç–º –ë—ç–º</span> ‚Ä¢ ' +
            '<span style="color:#FF6B6B">‚≠ê –ú–µ–ª—Å—Ç—Ä–æ–π</span>';
        document.getElementById('victoryScreen').style.display = 'flex';
    }

    function molochnoeVictory() {
        gameRunning = false;
        stopMusic(); sfxVictory();
        document.getElementById('victoryStats').innerHTML =
            'üéâ 15,000 –¥—Ä—É–Ω–±–ª–µ–π —Å–æ–±—Ä–∞–Ω–æ!<br>üìç –õ–æ–∫–∞—Ü–∏—è: –ú–æ–ª–æ—á–Ω–æ–µ<br><br>' +
            'üï∏Ô∏è –í –º–∞–≥–∞–∑–∏–Ω–µ –ø–æ—è–≤–∏–ª—Å—è –Ω–æ–≤—ã–π —Å—É–Ω–¥—É–∫: –ü–∞—É—Ç–∏–Ω–∞!';
        document.getElementById('victoryScreen').style.display = 'flex';
    }

    function molochnoeBo—Å—ÅVictory() {
        gameRunning = false;
        stopMusic(); sfxVictory();
        document.getElementById('victoryStats').innerHTML =
            'üöä –¢–†–ê–ú–í–ê–ô –ü–û–ë–ï–ñ–î–Å–ù!<br>üíé –ê–ª–º–∞–∑—ã —Å–æ–±—Ä–∞–Ω—ã: 25<br>üíé –í—Å–µ–≥–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤: ' + totalCrystals + '<br><br>üëë –¢—ã –ø–æ–∫–æ—Ä–∏–ª –ú–æ–ª–æ—á–Ω–æ–µ!';
        document.getElementById('victoryScreen').style.display = 'flex';
    }

    function bossVictory() {
        gameRunning = false;
        stopMusic(); sfxVictory();
        murinoUnlocked = true;
        localStorage.setItem('murinoUnlocked', 'true');
        document.getElementById('victoryStats').innerHTML =
            'üëë –ò–ú–ü–ï–†–ê–¢–û–† –ü–û–ë–ï–ñ–î–Å–ù!<br>üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã —Å–æ–±—Ä–∞–Ω—ã: 20<br>üíé –í—Å–µ–≥–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤: ' + totalCrystals + '<br><br>üå´Ô∏è –ú–£–†–ò–ù–û –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–û!';
        document.getElementById('victoryScreen').style.display = 'flex';
    }

    // ===================== INIT =====================
    const initChar = characters[currentChar];
    document.getElementById('charName').textContent = initChar.name;
    document.getElementById('charName').style.color = initChar.color;

    // –ó–∞–ø—É—Å–∫–∞–µ–º –º–µ–Ω—é-–º—É–∑—ã–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
    document.addEventListener('touchstart', function _firstTouch() {
        playMenuMusic();
        document.removeEventListener('touchstart', _firstTouch);
    }, { once: true });
    document.addEventListener('click', function _firstClick() {
        playMenuMusic();
        document.removeEventListener('click', _firstClick);
    }, { once: true });
</script>

</body>
</html>
